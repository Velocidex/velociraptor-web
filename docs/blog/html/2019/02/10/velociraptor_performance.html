<!DOCTYPE html>
<html>
  <head>
    <title>Velociraptor / Dig deeper</title>
    
      <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Velociraptor Performance :: Velociraptor / Dig deeper</title>
<link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link rel="stylesheet" href="/css/bootstrap.min.css">
<link href="/css/nucleus.css" rel="stylesheet">
<link href="/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/hybrid.css" rel="stylesheet">
<link href="/css/featherlight.min.css" rel="stylesheet">
<link href="/css/auto-complete.css" rel="stylesheet">
<link href="/theme-original/style.css" rel="stylesheet">

  <link href="/theme-original/variant-mine.css" rel="stylesheet">


<script src="/js/jquery-2.x.min.js"></script>
<style type="text/css">
  :root #header + #content > #left > #rlblock_left {
    display:none !important;
  }
</style>
<link rel="stylesheet" href="/css/theme-mine.css">
<script src="/js/custom.js"></script>


    
  </head>
  <body data-url="/blog/html/2019/02/10/velociraptor_performance.html">
    
      <div id="headermain"></div>
<nav id="sidebar" class="">



<div class="highlightable">
  <div id="header-wrapper">
    <div id="header">
      
	
  
    <a href="/">
  <img src="/images/logo.svg">
</a>

  


    </div>
        <div class="searchbox">
                    <label for="search-by"><i class="fa fa-search"></i></label>
                    <input data-search-input id="search-by" type="text" placeholder="Search...">
                    <span data-search-clear=""><i class="fa fa-close"></i></span>
                </div>
                <script type="text/javascript" src="/js/lunr.min.js"></script>
                <script type="text/javascript" src="/js/auto-complete.js"></script>
                <script type="text/javascript">
        
            var baseurl = "\/";
        
                </script>
                <script type="text/javascript" src="/js/search.js"></script>
  </div>

      <ul class="topics">
    <li data-nav-id="/about/" class="dd-item haschildren
        ">
      <div>
      <a href="/about/">About Velociraptor</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/about/features/" class="dd-item">
        <div>
          <a href="/about/features/">
            Velociraptor Features
          </a>
        </div>
    </li>
      <li data-nav-id="/about/license/" class="dd-item">
        <div>
          <a href="/about/license/">
            License
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/">Velociraptor Documentation</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/getting-started/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/getting-started/">Getting Started</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/getting-started/stand_alone/" class="dd-item
        ">
      <div>
      <a href="/docs/getting-started/stand_alone/">Standalone Deployment</a>
      </div>
    </li>
    <li data-nav-id="/docs/getting-started/deploying_clients/" class="dd-item
        ">
      <div>
      <a href="/docs/getting-started/deploying_clients/">Deploying Clients</a>
      </div>
    </li>
    <li data-nav-id="/docs/getting-started/cloud/" class="dd-item
        ">
      <div>
      <a href="/docs/getting-started/cloud/">Deploying in the cloud</a>
      </div>
    </li>
    <li data-nav-id="/docs/getting-started/performance/" class="dd-item
        ">
      <div>
      <a href="/docs/getting-started/performance/">Performance</a>
      </div>
    </li>
    <li data-nav-id="/docs/getting-started/triaging/" class="dd-item
        ">
      <div>
      <a href="/docs/getting-started/triaging/">Triaging</a>
      </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/user-interface/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/">User Interface</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/user-interface/investigating_clients/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/investigating_clients/">Investigating Clients</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/user-interface/investigating_clients/searching_clients/" class="dd-item
        ">
      <div>
      <a href="/docs/user-interface/investigating_clients/searching_clients/">Searching for clients</a>
      </div>
    </li>
    <li data-nav-id="/docs/user-interface/investigating_clients/virtual_filesystem/" class="dd-item
        ">
      <div>
      <a href="/docs/user-interface/investigating_clients/virtual_filesystem/">The Virtual File System</a>
      </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/user-interface/artifacts/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/artifacts/">Velociraptor Artifacts</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/user-interface/artifacts/client_artifacts/" class="dd-item
        ">
      <div>
      <a href="/docs/user-interface/artifacts/client_artifacts/">Client Artifacts</a>
      </div>
    </li>
    <li data-nav-id="/docs/user-interface/artifacts/client_events/" class="dd-item
        ">
      <div>
      <a href="/docs/user-interface/artifacts/client_events/">Client Event Artifacts</a>
      </div>
    </li>
    <li data-nav-id="/docs/user-interface/artifacts/server_artifacts/" class="dd-item
        ">
      <div>
      <a href="/docs/user-interface/artifacts/server_artifacts/">Server Artifacts</a>
      </div>
    </li>
    <li data-nav-id="/docs/user-interface/artifacts/server_events/" class="dd-item
        ">
      <div>
      <a href="/docs/user-interface/artifacts/server_events/">Server Event Artifacts</a>
      </div>
    </li>
    <li data-nav-id="/docs/user-interface/artifacts/add_artifacts/" class="dd-item
        ">
      <div>
      <a href="/docs/user-interface/artifacts/add_artifacts/">Customizing Artifacts</a>
      </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/user-interface/api/" class="dd-item
        ">
      <div>
      <a href="/docs/user-interface/api/">The Velociraptor API</a>
      </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/vql_reference/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/vql_reference/">VQL Reference</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/vql_reference/basic/" class="dd-item
        ">
      <div>
      <a href="/docs/vql_reference/basic/">Basic VQL functions and plugins</a>
      </div>
    </li>
    <li data-nav-id="/docs/vql_reference/windows/" class="dd-item
        ">
      <div>
      <a href="/docs/vql_reference/windows/">Windows Specific Functionality</a>
      </div>
    </li>
    <li data-nav-id="/docs/vql_reference/parsers/" class="dd-item
        ">
      <div>
      <a href="/docs/vql_reference/parsers/">Parsers and data extractors</a>
      </div>
    </li>
    <li data-nav-id="/docs/vql_reference/server/" class="dd-item
        ">
      <div>
      <a href="/docs/vql_reference/server/">Server Side Functionality</a>
      </div>
    </li>
    <li data-nav-id="/docs/vql_reference/plugin/" class="dd-item
        ">
      <div>
      <a href="/docs/vql_reference/plugin/">Client Side Functionality</a>
      </div>
    </li>
    <li data-nav-id="/docs/vql_reference/event/" class="dd-item
        ">
      <div>
      <a href="/docs/vql_reference/event/">Event Plugins</a>
      </div>
    </li>
    <li data-nav-id="/docs/vql_reference/experimental/" class="dd-item
        ">
      <div>
      <a href="/docs/vql_reference/experimental/">Experimental Functionality</a>
      </div>
    </li>
    <li data-nav-id="/docs/vql_reference/filesystem_accessors/" class="dd-item
        ">
      <div>
      <a href="/docs/vql_reference/filesystem_accessors/">Filesystem Accessors</a>
      </div>
    </li>
    <li data-nav-id="/docs/vql_reference/templates/" class="dd-item
        ">
      <div>
      <a href="/docs/vql_reference/templates/">Report Templates</a>
      </div>
    </li>
    <li data-nav-id="/docs/vql_reference/tips/" class="dd-item
        ">
      <div>
      <a href="/docs/vql_reference/tips/">Artifact Tips</a>
      </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/artifacts/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/artifacts/">Artifact Reference</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/artifacts/linux/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/linux/">Linux Artifacts</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/artifacts/windows_system/">Windows</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/artifacts/windows_system/events/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/events/">Event Logs</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/system/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/system/">System</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/registry/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/registry/">Registry</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/network/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/network/">Network</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/applications/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/applications/">Applications</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/detection/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/detection/">Malware Detection</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/triage/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/triage/">Triage Artifacts</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/remediation/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/remediation/">Remdiation</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/monitoring/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/monitoring/">Event Monitoring</a>
      </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/artifacts/server/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/server/">Server Artifacts</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/misc/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/misc/">Miscelaneous Artifacts</a>
      </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/presentations/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/presentations/">Presentations and Workshops</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/presentations/comfycon.2020/" class="dd-item
        ">
      <div>
      <a href="/docs/presentations/comfycon.2020/">Comfycon 2020</a>
      </div>
    </li>
    <li data-nav-id="/docs/presentations/training_2020/" class="dd-item
        ">
      <div>
      <a href="/docs/presentations/training_2020/">Enterprise Hunting and Incident Response with Velociraptor 2020</a>
      </div>
    </li>
    <li data-nav-id="/docs/presentations/linux.conf.au.2020/" class="dd-item
        ">
      <div>
      <a href="/docs/presentations/linux.conf.au.2020/">Linux.Conf.Au 2020</a>
      </div>
    </li>
    <li data-nav-id="/docs/presentations/sans_dfir_summit2019/" class="dd-item
        ">
      <div>
      <a href="/docs/presentations/sans_dfir_summit2019/">SANS Summit 2019</a>
      </div>
    </li>
    <li data-nav-id="/docs/presentations/rsa/" class="dd-item
        ">
      <div>
      <a href="/docs/presentations/rsa/">RSA Asia Pacific and Japan 2019</a>
      </div>
    </li>
    <li data-nav-id="/docs/presentations/crikeycon2019/" class="dd-item
        ">
      <div>
      <a href="/docs/presentations/crikeycon2019/">Crikeycon 2019 Training Workshop</a>
      </div>
    </li>
    <li data-nav-id="/docs/presentations/nzitf2018/" class="dd-item
        ">
      <div>
      <a href="/docs/presentations/nzitf2018/">New Zealand Internet Task Force Conference 2018</a>
      </div>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li data-nav-id="/blog/" class="dd-item parent haschildren
        ">
      <div>
      <a href="/blog/">Velociraptor Blog</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/blog/medium/2020-08-17-velociraptor-sso-authentication-6dd68d46dccf/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-08-17-velociraptor-sso-authentication-6dd68d46dccf/">
            Velociraptor SSO Authentication
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-08-16-profiling-the-beast-58913437fd16/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-08-16-profiling-the-beast-58913437fd16/">
            Profiling the beast
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-07-14-triage-with-velociraptor-pt-4-cf0e60810d1e/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-07-14-triage-with-velociraptor-pt-4-cf0e60810d1e/">
            Triage with Velociraptor — Pt 4
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-07-13-velociraptor-in-the-tool-age-d896dfe71b9/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-07-13-velociraptor-in-the-tool-age-d896dfe71b9/">
            Velociraptor in the tool age
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-06-19-the-velociraptor-query-language-pt-2-fe92bb7aa150/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-06-19-the-velociraptor-query-language-pt-2-fe92bb7aa150/">
            The Velociraptor Query Language Pt 2
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-06-14-the-velociraptor-query-language-pt-1-d721bff100bf/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-06-14-the-velociraptor-query-language-pt-1-d721bff100bf/">
            The Velociraptor Query Language Pt 1
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-04-16-velociraptor-e48a47e0317d/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-04-16-velociraptor-e48a47e0317d/">
            Velociraptor
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-03-29-velociraptors-acl-model-7f497575daee/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-03-29-velociraptors-acl-model-7f497575daee/">
            Velociraptor’s ACL model
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-03-28-velociraptor-notebooks-d02e0bd11230/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-03-28-velociraptor-notebooks-d02e0bd11230/">
            Velociraptor notebooks
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-03-07-extending-vql-plugins-7fb004cb6ec4/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-03-07-extending-vql-plugins-7fb004cb6ec4/">
            Extending VQL plugins
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-03-06-velociraptor-post-processing-with-jupyter-notebook-and-pandas-8a344d05ee8c/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-03-06-velociraptor-post-processing-with-jupyter-notebook-and-pandas-8a344d05ee8c/">
            Velociraptor Post-processing with Jupyter Notebook and Pandas
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-01-12_hunting-malware-using-mutants-ea08e86dfc19/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-01-12_hunting-malware-using-mutants-ea08e86dfc19/">
            Hunting Malware using Mutants
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-12-31_digging-into-the-system-resource-usage-monitor-srum-afbadb1a375/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-12-31_digging-into-the-system-resource-usage-monitor-srum-afbadb1a375/">
            Digging into the System Resource Usage Monitor (SRUM)
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-12-08-velociraptor-to-elasticsearch-3a9fc02c6568/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-12-08-velociraptor-to-elasticsearch-3a9fc02c6568/">
            Velociraptor to Elasticsearch
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/">
            Recovering deleted NTFS Files with Velociraptor
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-11-12_windows-event-logs-d8d8e615c9ca/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-11-12_windows-event-logs-d8d8e615c9ca/">
            Windows Event Logs
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/">
            Triage with Velociraptor — Pt 3
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-10-04_triage-with-velociraptor-pt-2-d0f79066ca0e/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-10-04_triage-with-velociraptor-pt-2-d0f79066ca0e/">
            Triage with Velociraptor — Pt 2
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-10-02_triage-with-velociraptor-pt-1-253f57ce96c0/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-10-02_triage-with-velociraptor-pt-1-253f57ce96c0/">
            Triage with Velociraptor — Pt 1
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-09-11_velociraptor-s-client-side-buffer-3ce03697a4e6/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-09-11_velociraptor-s-client-side-buffer-3ce03697a4e6/">
            Velociraptor’s client side buffer
          </a>
        </div>
    </li>
        </ul>
    </li>




    <hr />
    <li></li>

    </ul>

 <section id="footer">
    </section>
  </div>
</nav>



<section id="body">
<div id="overlay"></div>
<div class="padding highlightable">

  <div id="top-bar">
    <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
        <span id="sidebar-toggle-span">
          <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
            <i class="fa fa-bars"></i>
          </a>
        </span>
        <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
        <span class="links">
        







 <a href='/'>Velociraptor / Dig deeper</a> > <a href='/blog/'>Velociraptor Blog</a> > Velociraptor Performance






        </span>
    </div>

    
    <div class="progress">
        <div class="wrapper">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#velociraptor-rate-limiting">Velociraptor rate limiting</a></li>
  </ul>

  <ul>
    <li><a href="#thanks">Thanks</a></li>
  </ul>
</nav>
        </div>
    </div>
    

  </div>


<div id="body-inner">
  
      <h1>Velociraptor Performance</h1>
      
        <h4 class="subtitle"> We are often asked how many resources does a Velociraptor deployment use? How should one spec a machine for a Velociraptor deployment? </h4>
      
  



    
    
    
    <p>We are often asked how many resources does a Velociraptor deployment
use? How should one spec a machine for a Velociraptor deployment?</p>
<p>We have previously said that one of the reasons we developed
Velociraptor was to improve on the performance of GRR which was not
scalable for our use case.</p>
<p>We've been working with the team at Klein &amp; Co. on several intrusions
over the past several months, which are providing valuable opportunities
to deploy and test Velociraptor in a range of real world investigation
scenarios. Through this process, we&rsquo;ve been able to extend
Velociraptor&rsquo;s functionality and prove its performance on real client
networks.</p>
<p>I thought I would write a short blog post to show how Velociraptor
performed on such a recent engagement. In this engagement we deployed
Velociraptor on AWS and selectively pushed the client to around 600
machines running a mix of MacOS and Windows.</p>
<p>This post will hopefully give readers some idea of how scalable the tool
is and the typical workloads we run with it.</p>
<h1 id="the-server">The Server</h1>
<p>Since this is a smallish deployment we used a single VM with 32Gb of RAM
and 8 cores. This was definitely over speced for this job as most of the
time the server consumed less than 10% of one core:</p>
<pre><code class="language-{.sourceCode" data-lang="{.sourceCode">top - 06:26:13 up 29 days,  2:31,  5 users,  load average: 0.00, 0.01, 0.05
Tasks: 214 total,   1 running, 213 sleeping,   0 stopped,   0 zombie
%Cpu(s):  0.5 us,  0.1 sy,  0.0 ni, 99.4 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
KiB Mem:  32948060 total, 14877988 used, 18070072 free,   411192 buffers
KiB Swap:        0 total,        0 used,        0 free. 13381224 cached Mem

  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND
19334 root      20   0 1277924  94592  12616 S   3.0  0.3   9:11.03 ./velociraptor --config server.config.yaml frontend
    8 root      20   0       0      0      0 S   0.3  0.0   7:16.30 [rcuos/0]
</code></pre><p>You can see that the server consumed about 95mb when operating normally
and CPU usage was around 3% of one core.</p>
<p>For this engagement we knew that we would be collecting a lot of data
and so we specified a large 500gb volume.</p>
<h1 id="hunt-performance">Hunt performance</h1>
<p>Velociraptor works by collecting &quot;Artifacts&quot; from clients. Artifacts
are simply encapsulated VQL queries which specify something to search
for on the endpoint. Without going into the details of this engagement,
we can say that we collected typical artifacts for a DFIR/Forensic
investigation engagement. In the following I want to explore how well
hunts performed for the following typical artifacts in order of
complexity:</p>
<ol>
<li>Search the filesystem for a file glob.</li>
<li>Download the $MFT from the root filesystem.</li>
<li>Run a Yara scan over every file on all mounted filesystems.</li>
</ol>
<p>We ran these artifact collections over a large number of hosts (between
400-500) that fell within the scope of our engagement. Although the
number of hosts is not huge, we hope to demonstrate Velociraptor's
scalability.</p>
<h1 id="searching-for-a-file-glob">Searching for a file glob</h1>
<p>One of the simplest and most common tasks in DFIR is to search the
filesystem for a glob based on filename. This requires traversing
directories and matching the filename based on the user specified
expression - for example, find all files with the extension *.exe
within the C:\\Users directory.</p>
<p>Velociraptor can glob over the entire filesystem or over a limited set
of files. Typically a full filesystem glob can take some minutes on the
endpoint (it is equivalent to running the find unix command) and touches
every file. We typically try to limit the scope of the glob as much as
possible (e.g. only search system directories) but sometimes it is nice
to run a glob over all mounted filesystems to make sure we don't miss
anything. In this case we opted for a full filesystem scan.</p>
<p>We searched the entire deployment using a hunt (The hunt is constructed
using the File Finder flow in the GUI) which just launches the artifact
collection. Therefore the horizontal distance between the red and blue
dot, in the graph below, represents the total time taken by the host to
collect the artifact.</p>
<p><img src="FileNameSearch.svg" alt="image"></p>
<p>The graph shows how many hosts were recruited into this hunt on the Y
axis. The X axis show the number of seconds since the hunt launch. The
red points indicate the time when clients started their collection,
while the blue dots indicate the time when the client completed the
artifact collection and the server saved its results.</p>
<p>The inset shows the same data but zoomed into the time origin.</p>
<p>Velociraptor improves and builds on the initial ideas implemented within
the GRR DFIR tool, and so it is interesting to compare this graph to a
typical graph produced by GRR's hunt (reproduced from <a href="https://www.sciencedirect.com/science/article/pii/S1742287613000285">this
paper</a>).</p>
<p><img src="grr_hunt.png" alt="image"></p>
<p>The first noticeable difference is that Velociraptor clients complete
their collection much faster than GRR's (the horizontal distance
between the red and blue dots represents the time between when the
collection is issued and the time it completes).</p>
<p>The main reason for this is that GRR's communication protocol relies on
polling (by default every 10 minutes). Also, since hunting is so
resource intensive in GRR, the clients actually poll the hunt foreman
task every 30 minutes by default. This means that GRR clients typically
have to wait up to 30 minutes to run a hunt!</p>
<p>The second difference is the slope of the line around the start of the
hunt. GRR implements a hunt client rate - clients are recruited into the
hunt slowly (by default 20 per minute) in order to limit the load on the
frontends. Unlike GRR, Velociraptor does not implement a hunt rate since
the Velociraptor frontend load is controlled by limiting concurrency
instead (more on this below).</p>
<p>This means that Velociraptor can deliver useful results within seconds
of the hunt starting. We see that this particular filename search
typically takes 25-30 seconds and we see about 200 clients completing
the hunt within this time consistently. The remaining clients are
probably not online and they receive the hunt as they join the network.
This makes Velociraptor hunts far more responsive and useful.</p>
<p>You might also notice a few outliers which spend a long time collecting
this artifact - these machines have probably been shutdown or suspended
while collecting this artifact.</p>
<h1 id="mft-download">MFT Download</h1>
<p>A common technique is to examine the Master File Table (MFT) of an NTFS
volume. By forensically analyzing the MFT it is possible to detect
deleted files, time stomping and build a timeline of the system using
tools like <a href="https://github.com/dkovar/analyzeMFT">analyseMFT.py</a> or
<a href="https://dmitrybrant.com/ntfswalker">ntfswalker</a> .</p>
<p>In this case we decided to collect the $MFT from all the Windows hosts
and post-process them offline. Typically the MFT is around 300-400mb and
could be larger. Therefore this artifact collection is about performance
downloading large quantities of data from multiple hosts quickly.</p>
<p>Velociraptor can read the raw NTFS partition and therefore read the
$MFT file. We wrote the following artifact to just fetch the $MFT
file:</p>
<pre><code class="language-{.sourceCode" data-lang="{.sourceCode">name: Artifact.NTFS.MFT_puller
description: |
   Uses an NTFS accessor to pull the $MFT

parameters:
- name: path
  default: \\.\C:\$MFT

sources:
- precondition:
    SELECT OS From info() where OS = 'windows'
  queries:
  - SELECT upload(file=path, accessor=&quot;ntfs&quot;) as Upload from scope()
</code></pre><p>Here is the timing graph for this artifact collection:</p>
<p><img src="MFTDownload.svg" alt="image"></p>
<p>This collection takes a lot longer on each host as clients are uploading
around 400mb each to the server, but our server was in the cloud so it
had fast bandwidth. Again we see the hosts that are currently up being
tasked within seconds, while as hosts come online gradually we see them
receiving the hunt and a few minutes later uploading their $MFT file.</p>
<p>Was the frontend loaded at the time? I took a screenshot of top on the
server seconds after launching the hunt:</p>
<p><img src="UploadingMFT.png" alt="image"></p>
<p>We can see that the CPU load is trivial (4.7%) but the major impact of a
heavy upload collection is the memory used (about 4.7gb - up from about
100mb). The reason is that each client is posting a large buffer of data
(several mb) simultaneously. The server needs to buffer the data before
it can decrypt and process it which takes memory.</p>
<p>In order to limit the amount of memory used, Velociraptor limits the
total number of connections it is actively processing to 8-10 concurrent
connections. By carefully managing concurrency we are able to keep a
limit on server memory use. We may lower the total memory use by
reducing the concurrency (and therefore maybe fit into a smaller VM).
Clients simply wait until the server is able to process their uploaded
buffers. If the server takes too long, the clients automatically back
off and retry to send the same buffer.</p>
<h1 id="yara-scan-over-the-entire-filesystem">Yara scan over the entire filesystem</h1>
<p>The final example of a very intense artifact is to scan the entire
filesystem with a YARA rule. This not only requires traversing the
entire filesystem, but also opening each file and searching it.</p>
<p>One of the dangers with such a scan is that users will be negatively
impacted as their workstations start to read every file on disk! The
main resources a YARA scan consumes is disk IO and CPU load. Users might
complain and blame Velociraptor for their machine being slow (disk IO
may negatively affect performance much more than CPU load!).</p>
<p>However in this case, we don't care how long we take to scan the
user's system, as long as every file was scanned, and as long as the
endpoint is not overloaded and the user's work is not affected. Luckily
Velociraptor allows us to specify the trade-off between collection time
and collection intensity.</p>
<h2 id="velociraptor-rate-limiting">Velociraptor rate limiting</h2>
<p>Velociraptor controls client side load by rate limiting the client's
VQL query. Each VQL plugin consumes an &quot;operation&quot; from the throttler.
We define an &quot;operation&quot; as a notional unit of work - the heavier the
VQL plugin's work, the more operations are consumed. For example for
yara scanning, an operation is defined as 1mb of scanned data, or a
single file if the file is smaller.</p>
<p>When a user issues an artifact collection task, they may limit the rate
at which operations are performed by the client. The Velociraptor agent
then limits the operations to the specified rate. For example, if the
rate is 20 ops/sec then the client will scan less than 20mb per seconds.</p>
<p>Other collections may run concurrently at different rates, though; The
client is not blocked while performing a single artifact collection.
This makes sense since we often need to collect a low priority artifact
slowly, but we do not want this to compromise rapid response to that
host.</p>
<p>For example, one of our targets was a server with large attached
storage. We ran the Yara scan over this system, scanning the first 100Mb
of each file, at a rate of 50 ops/sec. In total we scanned 1.5Tb of
files and the scan took 14 hours (for a total scan rate of 30Mb/sec).</p>
<p>Velociraptor by default collects the Generic.Client.Stats artifact,
which samples the client's CPU utilization and memory usage every 10
seconds. These samples are streamed to the server and form a record of
the client's footprint on the endpoint. We can use this data to
visualize the effects of performing the yara scan on this host:</p>
<p><img src="cpu_utilization.svg" alt="image"></p>
<p>Above is the CPU usage on that particular server over the course of a
full day (24 hours). The 14 hour yara scan is clearly visible but at no
time is CPU utilization exceeding 30% of one core. With endpoint disk IO
limited to about 30mb/sec we have achieved a balance between performance
and endpoint load we are happy with.</p>
<p><img src="YaraScanFull.svg" alt="image"></p>
<p>We can see that most endpoints take approximately an hour to perform
this yara scan, but server load is minimal since the server simply
stores the results of the scans while doing minimal processing.</p>
<h1 id="conclusions">Conclusions</h1>
<p>This post provides some typical numbers for Velociraptor performance in
typical DFIR engagements. We also covered some considerations and
trade-offs we must think about when issuing large artifact collections.
Readers can use these as a guideline in their own deployments - please
comment below about your experiences. Velociraptor is under very active
development and this feedback is important to ensure we put in place the
mechanisms to account for more use cases.</p>
<h2 id="thanks">Thanks</h2>
<p>We would like to thank the folk at
<a href="https://www.kleinco.com.au/">Klein&amp;Co</a> for their wonderful support and
assistance in Velociraptor development.</p>


    
    
          <footer class=" footline" >
	
</footer>
  </div>
</div>

<div id="navigation">
<a class="nav nav-prev" href="/docs/presentations/nzitf2018/" title="New Zealand Internet Task Force Conference 2018"> <i class="fa fa-chevron-left"></i><label>New Zealand Internet Task Force Conference 2018</label></a>
    <a class="nav nav-next" href="/blog/medium/2020-08-17-velociraptor-sso-authentication-6dd68d46dccf/" title="Velociraptor SSO Authentication" style="margin-right: 0px;"><label>Velociraptor SSO Authentication</label><i class="fa fa-chevron-right"></i></a></div>

</section>
<div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
  <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
</div>    

<script src="/js/clipboard.min.js"></script>
<script src="/js/featherlight.min.js"></script>
<script src="/js/html5shiv-printshiv.min.js"></script>

<script src="/js/modernizr.custom.71422.js"></script>
<script src="/js/docdock.js"></script>
<script src="/theme-original/script.js"></script>


    

    
    

    
  </body>
</html>