<!DOCTYPE html>
<html>
  <head>
    <title>Velociraptor / Dig deeper</title>
    
      <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Event Queries and Endpoint Monitoring :: Velociraptor / Dig deeper</title>
<link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link rel="stylesheet" href="/css/bootstrap.min.css">
<link href="/css/nucleus.css" rel="stylesheet">
<link href="/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/hybrid.css" rel="stylesheet">
<link href="/css/featherlight.min.css" rel="stylesheet">
<link href="/css/auto-complete.css" rel="stylesheet">
<link href="/theme-original/style.css" rel="stylesheet">

  <link href="/theme-original/variant-mine.css" rel="stylesheet">


<script src="/js/jquery-2.x.min.js"></script>
<style type="text/css">
  :root #header + #content > #left > #rlblock_left {
    display:none !important;
  }
</style>
<link rel="stylesheet" href="/css/theme-mine.css">
<script src="/js/custom.js"></script>


    
  </head>
  <body data-url="/blog/html/2018/11/09/event_queries_and_endpoint_monitoring.html">
    
      <div id="headermain"></div>
<nav id="sidebar" class="">



<div class="highlightable">
  <div id="header-wrapper">
    <div id="header">
      
	
  
    <a href="/">
  <img src="/images/logo.svg">
</a>
  


    </div>
        <div class="searchbox">
		    <label for="search-by"><i class="fa fa-search"></i></label>
		    <input data-search-input id="search-by" type="text" placeholder="Search...">
		    <span data-search-clear=""><i class="fa fa-close"></i></span>
		</div>
		<script type="text/javascript" src="/js/lunr.min.js"></script>
		<script type="text/javascript" src="/js/auto-complete.js"></script>
		<script type="text/javascript">
        
            var baseurl = "\/";
        
		</script>
		<script type="text/javascript" src="/js/search.js"></script>
  </div>

      <ul class="topics">
    <li data-nav-id="/about/" class="dd-item haschildren
        ">
      <div>
      <a href="/about/">About Velociraptor</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/about/features/" class="dd-item">
        <div>
          <a href="/about/features/">
            Velociraptor Features
          </a>
        </div>
    </li>
      <li data-nav-id="/about/license/" class="dd-item">
        <div>
          <a href="/about/license/">
            License
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/">Velociraptor Documentation</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/getting-started/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/getting-started/">Getting Started</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/getting-started/stand_alone/" class="dd-item">
        <div>
          <a href="/docs/getting-started/stand_alone/">
            Standalone Deployment
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/getting-started/deploying_clients/" class="dd-item">
        <div>
          <a href="/docs/getting-started/deploying_clients/">
            Deploying Clients
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/getting-started/cloud/" class="dd-item">
        <div>
          <a href="/docs/getting-started/cloud/">
            Deploying in the cloud
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/getting-started/triaging/" class="dd-item">
        <div>
          <a href="/docs/getting-started/triaging/">
            Triaging
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/user-interface/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/">User Interface</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/user-interface/investigating_clients/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/investigating_clients/">Investigating Clients</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/user-interface/investigating_clients/searching_clients/" class="dd-item">
        <div>
          <a href="/docs/user-interface/investigating_clients/searching_clients/">
            Searching for clients
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/investigating_clients/virtual_filesystem/" class="dd-item">
        <div>
          <a href="/docs/user-interface/investigating_clients/virtual_filesystem/">
            Client VFS
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/user-interface/artifacts/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/artifacts/">Velociraptor Artifacts</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/user-interface/artifacts/client_artifacts/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/client_artifacts/">
            Client Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/client_events/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/client_events/">
            Client Event Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/server_artifacts/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/server_artifacts/">
            Server Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/server_events/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/server_events/">
            Server Event Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/add_artifacts/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/add_artifacts/">
            Customizing Artifacts
          </a>
        </div>
    </li>
        </ul>
    </li>
      <li data-nav-id="/docs/user-interface/api/" class="dd-item">
        <div>
          <a href="/docs/user-interface/api/">
            The Velociraptor API
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/vql_reference/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/vql_reference/">VQL Reference</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/vql_reference/plugins/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/plugins/">
            VQL PLugins
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/event_plugins/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/event_plugins/">
            VQL Event PLugins
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/server/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/server/">
            VQL Server Plugins
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/functions/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/functions/">
            VQL Functions
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/templates/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/templates/">
            Report Templates
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/tips/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/tips/">
            Artifact Tips
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/filesystem_accessors/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/filesystem_accessors/">
            Filesystem Accessors
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/artifacts/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/artifacts/">Artifact Reference</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/artifacts/linux/" class="dd-item">
        <div>
          <a href="/docs/artifacts/linux/">
            Linux Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/windows_system/" class="dd-item">
        <div>
          <a href="/docs/artifacts/windows_system/">
            Windows System
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/server/" class="dd-item">
        <div>
          <a href="/docs/artifacts/server/">
            Server Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/triage/" class="dd-item">
        <div>
          <a href="/docs/artifacts/triage/">
            Windows Triage
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/detection/" class="dd-item">
        <div>
          <a href="/docs/artifacts/detection/">
            Windows Detection
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/events/" class="dd-item">
        <div>
          <a href="/docs/artifacts/events/">
            Windows Monitoring
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/misc/" class="dd-item">
        <div>
          <a href="/docs/artifacts/misc/">
            Miscelaneous
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/linux/linux/" class="dd-item">
        <div>
          <a href="/docs/artifacts/linux/linux/">
            Linux Artifacts
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/presentations/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/presentations/">Presentations and Workshops</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/presentations/sans_dfir_summit2019/" class="dd-item">
        <div>
          <a href="/docs/presentations/sans_dfir_summit2019/">
            SANS 2019
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/rsa/" class="dd-item">
        <div>
          <a href="/docs/presentations/rsa/">
            RSA APJ 2019
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/crikeycon2019/" class="dd-item">
        <div>
          <a href="/docs/presentations/crikeycon2019/">
            Crikeycon 2019
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/nzitf2018/" class="dd-item">
        <div>
          <a href="/docs/presentations/nzitf2018/">
            NZITF 2018
          </a>
        </div>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li data-nav-id="/blog/" class="dd-item parent haschildren
        ">
      <div>
      <a href="/blog/">Velociraptor Blog</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i>
      </div>
        <ul>
        </ul>
    </li>




    <hr />
    <li></li>
    
    </ul>

 <section id="footer">
    </section>
  </div>
</nav>



<section id="body">
<div id="overlay"></div>
<div class="padding highlightable">

  <div id="top-bar">
    <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
        <span id="sidebar-toggle-span">
          <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
            <i class="fa fa-bars"></i>
          </a>
        </span>
        <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
        <span class="links">
        







 <a href='/'>Velociraptor / Dig deeper</a> > <a href='/blog/'>Velociraptor Blog</a> > Event Queries and Endpoint Monitoring

 

 

   
        </span>
    </div>
    
    
    <div class="progress">
        <div class="wrapper">
    
        </div>
    </div>
    

  </div>


<div id="body-inner">
  
    <h1>Event Queries and Endpoint Monitoring</h1>
  



    
    
    
    <div class="document">


<p>Why monitor endpoint events? Recording end point event information on
the server gives a bunch of advantages. For one, the server keeps a
record of historical events, which makes going back to search for
these easy as part of an incident response activity.</p>
<p>For example, Velociraptor can keep a running log of process execution
events for all clients, on the server. If a particular executable is
suspected to be malicious, we can now go back and search for the
execution of that process in the past on the infected machine (for
establishing the time of infection), as well as search the entire
deployment base for the same binary execution to be able identify
lateral movement and wider compromises.</p>
<div class="section" id="how-are-events-monitored">
<h2>How are events monitored?</h2>
<p>Velociraptor relies heavily on VQL queries. A VQL query typically
produces a single table of multiple rows. For example, the query:</p>
<pre class="code sql literal-block">
<span class="keyword">SELECT</span> <span class="name">Name</span><span class="punctuation">,</span> <span class="name">CommandLine</span> <span class="keyword">FROM</span> <span class="name">pslist</span><span class="punctuation">()</span>
</pre>
<p>Returns a single row of all running processes, and then returns.</p>
<p>However, VQL queries do not have to terminate at all. If the VQL
plugin they are calling does not terminate, the VQL query will
continue to run and pass events in partial results to the VQL caller.</p>
<p>Event queries are just regular VQL queries which do not terminate
(unless cancelled) returning rows whenever an event is generated.</p>
<img alt="1.png" src="1.png" />
<p>Consider the parse_evtx() plugin. This plugin parses an event log file
and returns all events in it. We can then filter events and return
specific events of interest. The following query returns all the
service installation events and terminates:</p>
<pre class="code console literal-block">
<span class="generic output">F:\&gt;velociraptor.exe query &quot;SELECT EventData, System.TimeCreated.SystemTime from
   parse_evtx(filename='c:/windows/system32/winevt/logs/system.evtx') where
   System.EventId.value = '7045'&quot;
[
 {
  &quot;EventData&quot;: {
   &quot;AccountName&quot;: &quot;&quot;,
   &quot;ImagePath&quot;: &quot;system32\\DRIVERS\\VBoxGuest.sys&quot;,
   &quot;ServiceName&quot;: &quot;VirtualBox Guest Driver&quot;,
   &quot;ServiceType&quot;: &quot;kernel mode driver&quot;,
   &quot;StartType&quot;: &quot;boot start&quot;
  },
  &quot;System.TimeCreated.SystemTime&quot;: &quot;2018-11-10T06:32:34Z&quot;
 }
]</span>
</pre>
<p>The query specifically looks at the 7045 event <a class="reference external" href="http://www.eventid.net/display.asp?eventid=7045&amp;source=service+control+manager">&quot;A service was installed in the system&quot;</a></p>
<p>Lets turn this query into an event query:</p>
<pre class="code console literal-block">
<span class="generic output">F:\&gt;velociraptor.exe query &quot;SELECT EventData, System.TimeCreated.SystemTime from
   watch_evtx(filename='c:/windows/system32/winevt/logs/system.evtx') where
   System.EventId.value = '7045'&quot; --max_wait 1
[
  &quot;EventData&quot;: {
    &quot;AccountName&quot;: &quot;&quot;,
    &quot;ImagePath&quot;: &quot;C:\\Users\\test\\AppData\\Local\\Temp\\pmeFF0E.tmp&quot;,
    &quot;ServiceName&quot;: &quot;pmem&quot;,
    &quot;ServiceType&quot;: &quot;kernel mode driver&quot;,
    &quot;StartType&quot;: &quot;demand start&quot;
  },
  &quot;System.TimeCreated.SystemTime&quot;: &quot;2018-11-10T04:57:35Z&quot;
  }
]</span>
</pre>
<p>The watch_evtx() plugin is the event watcher equivalent of the
parse_evtx() plugin. If you ran the above query, you will notice that
Velociraptor does not terminate. Instead it will show all existing
service installation events in the log file, and then just wait in the
console.</p>
<p>If you then install a new service (in another terminal), for example
using <cite>winpmem.exe -L</cite>, a short time later you should see the event
reported by Velociraptor as in the above example. You will notice that
the watch_evtx() plugin emits event logs as they occur, but
Velociraptor will try to group the events into batches. The max_wait
flag controls how long to wait before releasing a partial result set.</p>
</div>
<div class="section" id="employing-event-queries-for-client-monitoring">
<h2>Employing event queries for client monitoring</h2>
<p>The above illustrates how event queries work, but to actually be able
to use these we had to implement the Velociraptor event monitoring
framework.</p>
<p>Normally, when we launch a CollectVQL flow, the client executes the
query and returns the result to the flow. Clearly since event queries
never terminate, we can not run them in series (because the client
will never be able to do anything else). The Velociraptor client has a
table of executing event queries which are run in a separate
thread. As these queries return more results, the results are sent
back to the server.</p>
<p>We also wanted to be able to update the events the clients are
monitoring on the fly (without a client restart). Therefore we needed
a way to be able to update the client's event table. This simply
cancels current event queries, and installs new queries in their
place.</p>
<img alt="2.png" src="2.png" />
<p>As events are generated by the Event Table, they are sent back to the
server into the Monitoring flow. This flow is automatically created
for each client. The monitoring flow simply writes events into the
client's VFS. Therefore, events are currently simply recorded for each
client. In future there will be a mechanism to post process event and
produce alerts based on these.</p>
</div>
<div class="section" id="process-execution-logs">
<h2>Process Execution logs</h2>
<p>One of the most interesting event plugins is the WMI eventing
plugin. This allows Velociraptor to install a temporary WMI event
listener. For example, we can install a listener for new process
creation:</p>
<pre class="code console literal-block">
<span class="generic output">// Convert the timestamp from WinFileTime to Epoch.
SELECT timestamp(epoch=atoi(
  string=Parse.TIME_CREATED) / 10000000 - 11644473600 ) as Timestamp,
  Parse.ParentProcessID as PPID,
  Parse.ProcessID as PID,
  Parse.ProcessName as Name, {
    SELECT CommandLine
    FROM wmi(
      query=&quot;SELECT * FROM Win32_Process WHERE ProcessID = &quot; +
          format(format=&quot;%v&quot;, args=Parse.ProcessID),
      namespace=&quot;ROOT/CIMV2&quot;)
  } AS CommandLine
  FROM wmi_events(
       query=&quot;SELECT * FROM __InstanceCreationEvent WITHIN 1 WHERE
              TargetInstance ISA 'Win32_Process'&quot;,
       wait=5000000,   // Do not time out.
       namespace=&quot;ROOT/CIMV2&quot;)</span>
</pre>
<p>The wmi_events() plugin installs an event listener into WMI and
therefore receives events from the OS about new process creation
events. Unfortunately these events, do not contain a lot of
information about the process. They only provide the ProcessID but not
the full command line. The above query executes a second subquery to
retrieve the command line for the process. We also parse the timestamp
and convert it into a more standard epoch based timestamp.</p>
</div>
<div class="section" id="specifying-what-should-the-client-monitor">
<h2>Specifying what should the client monitor</h2>
<p>We have seen how Event VQL queries can generate events for the
server. However, this is difficult for Velociraptor's end users to
directly use. Who can really remember the full query?</p>
<p>As we have shown previously, Velociraptor's Artifacts are specifically
designed to solve this issue. Artifacts encapsulate a VQL query so it
can be called by name alone.</p>
<p>For example, the Windows.Events.ProcessCreation artifact encapsulates
the above query in one easy to remember name.</p>
<p>To specify what clients should collect, users simply need to name the
event artifacts that should be monitored. Currently this is done in
the server configuration (in future this may be done via the GUI).</p>
<pre class="code yaml literal-block">
<span class="name tag">Events</span><span class="punctuation">:</span>
  <span class="name tag">artifacts</span><span class="punctuation">:</span>
  <span class="punctuation indicator">-</span> <span class="literal scalar plain">Windows.Events.ServiceCreation</span>
  <span class="punctuation indicator">-</span> <span class="literal scalar plain">Windows.Events.ProcessCreation</span>
  <span class="name tag">version</span><span class="punctuation">:</span> <span class="literal scalar plain">1</span>
</pre>
<p>The event table version should be incremented each time the monitored
event list is updated. This forces all clients to refresh their event
tables.</p>
</div>
<div class="section" id="how-does-it-look-like-in-the-gui">
<h2>How does it look like in the GUI?</h2>
<p>The Monitoring flow simply writes files into the client's VFS. This
allows these to be downloaded and post processed outside of
Velociraptor.</p>
<img alt="3.png" src="3.png" />
</div>
<div class="section" id="conclusions">
<h2>Conclusions</h2>
<p>Adding event monitoring to Velociraptor is a great step forward. Even
just keeping the logs around is extremely helpful for incident
response. There is a lot of value in things like process execution
logging, and remote event log forwarding. We will cover some more
examples of event log monitoring in future blog posts. Until then,
have a play and provide feedback as usual by filing issues and feature
requests.</p>
</div>
</div>

    
    
          <footer class=" footline" >
	
</footer>
  </div>
</div>

<div id="navigation">
<a class="nav nav-prev" href="/docs/presentations/nzitf2018/" title="New Zealand Internet Task Force Conference 2018"> <i class="fa fa-chevron-left"></i><label>New Zealand Internet Task Force Conference 2018</label></a>
    <a class="nav nav-next" href="/about/" title="About Velociraptor" style="margin-right: 0px;"><label>About Velociraptor</label><i class="fa fa-chevron-right"></i></a></div>

</section>
<div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
  <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
</div>    

<script src="/js/clipboard.min.js"></script>
<script src="/js/featherlight.min.js"></script>
<script src="/js/html5shiv-printshiv.min.js"></script>

<script src="/js/modernizr.custom.71422.js"></script>
<script src="/js/docdock.js"></script>
<script src="/theme-original/script.js"></script>


    

    
    

    
  </body>
</html>