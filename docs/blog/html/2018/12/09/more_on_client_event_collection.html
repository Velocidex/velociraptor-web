<!DOCTYPE html>
<html>
  <head>
    <title>Velociraptor / Dig deeper</title>
    
      <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>More on client event collection :: Velociraptor / Dig deeper</title>
<link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link rel="stylesheet" href="/css/bootstrap.min.css">
<link href="/css/nucleus.css" rel="stylesheet">
<link href="/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/hybrid.css" rel="stylesheet">
<link href="/css/featherlight.min.css" rel="stylesheet">
<link href="/css/auto-complete.css" rel="stylesheet">
<link href="/theme-original/style.css" rel="stylesheet">

  <link href="/theme-original/variant-mine.css" rel="stylesheet">


<script src="/js/jquery-2.x.min.js"></script>
<style type="text/css">
  :root #header + #content > #left > #rlblock_left {
    display:none !important;
  }
</style>
<link rel="stylesheet" href="/css/theme-mine.css">
<script src="/js/custom.js"></script>


    
  </head>
  <body data-url="/blog/html/2018/12/09/more_on_client_event_collection.html">
    
      <div id="headermain"></div>
<nav id="sidebar" class="">



<div class="highlightable">
  <div id="header-wrapper">
    <div id="header">
      
	
  
    <p><a href="/">
  <img src="/images/logo.svg">
</a></p>

  


    </div>
        <div class="searchbox">
		    <label for="search-by"><i class="fa fa-search"></i></label>
		    <input data-search-input id="search-by" type="text" placeholder="Search...">
		    <span data-search-clear=""><i class="fa fa-close"></i></span>
		</div>
		<script type="text/javascript" src="/js/lunr.min.js"></script>
		<script type="text/javascript" src="/js/auto-complete.js"></script>
		<script type="text/javascript">
        
            var baseurl = "\/";
        
		</script>
		<script type="text/javascript" src="/js/search.js"></script>
  </div>

      <ul class="topics">
    <li data-nav-id="/about/" class="dd-item haschildren
        ">
      <div>
      <a href="/about/">About Velociraptor</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/about/features/" class="dd-item">
        <div>
          <a href="/about/features/">
            Velociraptor Features
          </a>
        </div>
    </li>
      <li data-nav-id="/about/license/" class="dd-item">
        <div>
          <a href="/about/license/">
            License
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/">Velociraptor Documentation</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/getting-started/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/getting-started/">Getting Started</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/getting-started/stand_alone/" class="dd-item">
        <div>
          <a href="/docs/getting-started/stand_alone/">
            Standalone Deployment
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/getting-started/deploying_clients/" class="dd-item">
        <div>
          <a href="/docs/getting-started/deploying_clients/">
            Deploying Clients
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/getting-started/cloud/" class="dd-item">
        <div>
          <a href="/docs/getting-started/cloud/">
            Deploying in the cloud
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/getting-started/triaging/" class="dd-item">
        <div>
          <a href="/docs/getting-started/triaging/">
            Triaging
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/user-interface/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/">User Interface</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/user-interface/investigating_clients/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/investigating_clients/">Investigating Clients</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/user-interface/investigating_clients/searching_clients/" class="dd-item">
        <div>
          <a href="/docs/user-interface/investigating_clients/searching_clients/">
            Searching for clients
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/investigating_clients/virtual_filesystem/" class="dd-item">
        <div>
          <a href="/docs/user-interface/investigating_clients/virtual_filesystem/">
            Client VFS
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/user-interface/artifacts/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/artifacts/">Velociraptor Artifacts</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/user-interface/artifacts/client_artifacts/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/client_artifacts/">
            Client Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/client_events/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/client_events/">
            Client Event Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/server_artifacts/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/server_artifacts/">
            Server Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/server_events/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/server_events/">
            Server Event Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/add_artifacts/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/add_artifacts/">
            Customizing Artifacts
          </a>
        </div>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/vql_reference/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/vql_reference/">VQL Reference</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/vql_reference/plugins/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/plugins/">
            VQL PLugins
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/event_plugins/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/event_plugins/">
            VQL Event PLugins
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/server/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/server/">
            VQL Server Plugins
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/functions/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/functions/">
            VQL Functions
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/templates/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/templates/">
            Report Templates
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/tips/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/tips/">
            Artifact Tips
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/filesystem_accessors/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/filesystem_accessors/">
            Filesystem Accessors
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/artifacts/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/artifacts/">Artifact Reference</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/artifacts/linux/" class="dd-item">
        <div>
          <a href="/docs/artifacts/linux/">
            Linux Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/windows_system/" class="dd-item">
        <div>
          <a href="/docs/artifacts/windows_system/">
            Windows System
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/server/" class="dd-item">
        <div>
          <a href="/docs/artifacts/server/">
            Server Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/triage/" class="dd-item">
        <div>
          <a href="/docs/artifacts/triage/">
            Windows Triage
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/detection/" class="dd-item">
        <div>
          <a href="/docs/artifacts/detection/">
            Windows Detection
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/events/" class="dd-item">
        <div>
          <a href="/docs/artifacts/events/">
            Windows Monitoring
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/misc/" class="dd-item">
        <div>
          <a href="/docs/artifacts/misc/">
            Miscelaneous
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/linux/linux/" class="dd-item">
        <div>
          <a href="/docs/artifacts/linux/linux/">
            Linux Artifacts
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/presentations/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/presentations/">Presentations and Workshops</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/presentations/sans_dfir_summit2019/" class="dd-item">
        <div>
          <a href="/docs/presentations/sans_dfir_summit2019/">
            SANS 2019
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/rsa/" class="dd-item">
        <div>
          <a href="/docs/presentations/rsa/">
            RSA APJ 2019
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/crikeycon2019/" class="dd-item">
        <div>
          <a href="/docs/presentations/crikeycon2019/">
            Crikeycon 2019
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/nzitf2018/" class="dd-item">
        <div>
          <a href="/docs/presentations/nzitf2018/">
            NZITF 2018
          </a>
        </div>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li data-nav-id="/blog/" class="dd-item parent haschildren
        ">
      <div>
      <a href="/blog/">Velociraptor Blog</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i>
      </div>
        <ul>
        </ul>
    </li>




    <hr />
    <li></li>
    
    </ul>

 <section id="footer">
    </section>
  </div>
</nav>



<section id="body">
<div id="overlay"></div>
<div class="padding highlightable">

  <div id="top-bar">
    <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
        <span id="sidebar-toggle-span">
          <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
            <i class="fa fa-bars"></i>
          </a>
        </span>
        <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
        <span class="links">
        







 <a href='/'>Velociraptor / Dig deeper</a> > <a href='/blog/'>Velociraptor Blog</a> > More on client event collection

 

 

   
        </span>
    </div>
    
    
    <div class="progress">
        <div class="wrapper">
    
        </div>
    </div>
    

  </div>


<div id="body-inner">
  
    <h1>More on client event collection</h1>
  



    
    
    
    <div class="document">


<div class="section" id="periodic-event-queries">
<h2>Periodic Event queries</h2>
<p>The simplest kind of events are periodically generated events. These
are created using the <cite>clock()</cite> VQL plugin. This is a simple event
plugin which just emits a new row periodically.</p>
<pre class="code bash literal-block">
$ velociraptor query <span class="literal string double">&quot;select Unix from clock(period=5)&quot;</span> --max_wait <span class="literal number">1</span>
<span class="operator">[</span>
 <span class="operator">{</span>
   <span class="literal string double">&quot;Unix&quot;</span>: <span class="literal number">1544339715</span>
 <span class="operator">}</span>
<span class="operator">][</span>
 <span class="operator">{</span>
   <span class="literal string double">&quot;Unix&quot;</span>: <span class="literal number">1544339720</span>
 <span class="operator">}</span>
<span class="operator">]</span>^C
</pre>
<p>The query will never terminate, instead the <cite>clock()</cite> plugin will emit
a new timestamp every 5 seconds. Note the <cite>--max_wait</cite> flag which
tells Velociraptor to wait at least for 1 second in order to batch
rows before reporting them.</p>
<p>This query is not very interesting! Let's do something more
interesting. GRR has a feature where each client sends its own CPU use
and memory footprint sampled every minutes to the server. This is a
really useful feature because it can be used to make sure the client's
impact on the host's performance is minimal.</p>
<p>Let us implement the same feature with a VQL query. What we want is to
measure the client's footprint every minute and send that to the
server:</p>
<pre class="code psql literal-block">
<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="name">foreach</span><span class="punctuation">(</span>
 <span class="keyword">row</span><span class="operator">=</span><span class="punctuation">{</span>
   <span class="keyword">SELECT</span> <span class="name">UnixNano</span> <span class="keyword">FROM</span> <span class="name">clock</span><span class="punctuation">(</span><span class="name">period</span><span class="operator">=</span><span class="literal number float">60</span><span class="punctuation">)</span>
 <span class="punctuation">},</span>
 <span class="name">query</span><span class="operator">=</span><span class="punctuation">{</span>
   <span class="keyword">SELECT</span> <span class="name">UnixNano</span> <span class="operator">/</span> <span class="literal number float">1000000000</span> <span class="keyword">as</span> <span class="name builtin">Timestamp</span><span class="punctuation">,</span>
          <span class="name">Times</span><span class="literal number float">.</span><span class="keyword">user</span> <span class="operator">+</span> <span class="name">Times</span><span class="literal number float">.</span><span class="keyword">system</span> <span class="keyword">as</span> <span class="name">CPU</span><span class="punctuation">,</span>
          <span class="name">MemoryInfo</span><span class="literal number float">.</span><span class="name">RSS</span> <span class="keyword">as</span> <span class="name">RSS</span>
   <span class="keyword">FROM</span> <span class="name">pslist</span><span class="punctuation">(</span><span class="name">pid</span><span class="operator">=</span><span class="name">getpid</span><span class="punctuation">())</span>
 <span class="punctuation">})</span>
</pre>
<p>This query runs the <cite>clock()</cite> VQL plugin and for each row it emits, we
run the <cite>pslist()</cite> plugin, extracting the total CPU time (system +
user) used by our own pid (i.e. the Velociraptor client).</p>
<p>We can now encapsulate this query in an <a class="reference external" href="/blog/html/reference/artifacts.html#generic-client-stats">artifact</a> and collect it:</p>
<pre class="code bash literal-block">
$ velociraptor artifacts collect Generic.Client.Stats --max_wait <span class="literal number">1</span> --format json
<span class="operator">[][</span>
  <span class="operator">{</span>
  <span class="literal string double">&quot;CPU&quot;</span>: <span class="literal number">0</span>.06999999999999999,
  <span class="literal string double">&quot;RSS&quot;</span>: <span class="literal number">18866176</span>,
  <span class="literal string double">&quot;Timestamp&quot;</span>: <span class="literal number">1544340582</span>.9939497
  <span class="operator">}</span>
<span class="operator">][</span>
  <span class="operator">{</span>
  <span class="literal string double">&quot;CPU&quot;</span>: <span class="literal number">0</span>.09,
  <span class="literal string double">&quot;RSS&quot;</span>: <span class="literal number">18866176</span>,
  <span class="literal string double">&quot;Timestamp&quot;</span>: <span class="literal number">1544340602</span>.9944408
  <span class="operator">}</span>
<span class="operator">]</span>^C
</pre>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You must specify the --format json to be able to see the results
from event queries on the command line. Otherwise Velociraptor will
try to get all the results so it can format them in a table and
never return any results.</p>
</div>
</div>
<div class="section" id="installing-the-event-collector">
<h2>Installing the event collector.</h2>
<p>In order to have clients collect this event, we need to add the
artifact to the server. Simply add the YAML file into a directory on
the server and start the server with the --definitions flag. Then
simply add the event name to the Events clause of the server
configuration. When clients connect to the server they will
automatically start collecting these events and sending them to the
server:</p>
<pre class="code bash literal-block">
$ velociraptor --definitions path/to/my/artifacts/ frontend
</pre>
<pre class="code yaml literal-block">
<span class="name tag">Events</span><span class="punctuation">:</span>
  <span class="name tag">artifacts</span><span class="punctuation">:</span>
  <span class="punctuation indicator">-</span> <span class="literal scalar plain">Generic.Client.Stats</span>
  <span class="name tag">version</span><span class="punctuation">:</span> <span class="literal scalar plain">2</span>
</pre>
<p>Note that we do not need to redeploy any clients, modify any code or
recompile anything. We simply add the new artifact definition and
clients will automatically start monitoring and feeding back our
information.</p>
<p>The data is sent to the server where it is stored in a file (Events are stored in a unique file for each day).</p>
<p>For example, the path
<cite>/var/lib/velociraptor/clients/C.772d16449719317f/monitoring/Artifact%20Generic.Client.Stats/2018-12-10</cite>
stores all events collected from client id <cite>C.772d16449719317f</cite> for
the <cite>Generic.Client.Stats</cite> artifact on the day of <cite>2018-12-10</cite>.</p>
<p>In the next blog post we will demonstrate how these events can be post
processed and acted on. It is important to note that the Velociraptor
server does not interpret the collected monitoring events at all -
they are simply appended to the daily log file (which is a CSV file).</p>
<p>The CSV file can then be imported into basically any tool designed to
work with tabular data (e.g. spreadsheets, databases, BigQuery
etc). CSV is almost universally supported by all major systems.</p>
<pre class="code text literal-block">
Timestamp,CPU,RSS
1544363561.8001275,14.91,18284544
1544363571.8002906,14.91,18284544
1544363581.8004665,14.920000000000002,18284544
1544363591.8007126,14.920000000000002,18284544
1544363601.8008528,14.920000000000002,18284544
</pre>
</div>
</div>

    
    
          <footer class=" footline" >
	
</footer>
  </div>
</div>

<div id="navigation">
<a class="nav nav-prev" href="/docs/presentations/nzitf2018/" title="New Zealand Internet Task Force Conference 2018"> <i class="fa fa-chevron-left"></i><label>New Zealand Internet Task Force Conference 2018</label></a>
    <a class="nav nav-next" href="/about/" title="About Velociraptor" style="margin-right: 0px;"><label>About Velociraptor</label><i class="fa fa-chevron-right"></i></a></div>

</section>
<div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
  <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
</div>    

<script src="/js/clipboard.min.js"></script>
<script src="/js/featherlight.min.js"></script>
<script src="/js/html5shiv-printshiv.min.js"></script>

<script src="/js/modernizr.custom.71422.js"></script>
<script src="/js/docdock.js"></script>
<script src="/theme-original/script.js"></script>


    

    
    

    
  </body>
</html>