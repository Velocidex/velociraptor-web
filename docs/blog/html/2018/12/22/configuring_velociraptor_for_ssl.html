<!DOCTYPE html>
<html>
  <head>
    <title>Velociraptor / Dig deeper</title>
    
      <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Configuring Velociraptor for SSL :: Velociraptor / Dig deeper</title>
<link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link rel="stylesheet" href="/css/bootstrap.min.css">
<link href="/css/nucleus.css" rel="stylesheet">
<link href="/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/hybrid.css" rel="stylesheet">
<link href="/css/featherlight.min.css" rel="stylesheet">
<link href="/css/auto-complete.css" rel="stylesheet">
<link href="/theme-original/style.css" rel="stylesheet">

  <link href="/theme-original/variant-mine.css" rel="stylesheet">


<script src="/js/jquery-2.x.min.js"></script>
<style type="text/css">
  :root #header + #content > #left > #rlblock_left {
    display:none !important;
  }
</style>
<link rel="stylesheet" href="/css/theme-mine.css">
<script src="/js/custom.js"></script>


    
  </head>
  <body data-url="/blog/html/2018/12/22/configuring_velociraptor_for_ssl.html">
    
      <div id="headermain"></div>
<nav id="sidebar" class="">



<div class="highlightable">
  <div id="header-wrapper">
    <div id="header">
      
	
  
    <p><a href="/">
  <img src="/images/logo.svg">
</a></p>

  


    </div>
        <div class="searchbox">
		    <label for="search-by"><i class="fa fa-search"></i></label>
		    <input data-search-input id="search-by" type="text" placeholder="Search...">
		    <span data-search-clear=""><i class="fa fa-close"></i></span>
		</div>
		<script type="text/javascript" src="/js/lunr.min.js"></script>
		<script type="text/javascript" src="/js/auto-complete.js"></script>
		<script type="text/javascript">
        
            var baseurl = "\/";
        
		</script>
		<script type="text/javascript" src="/js/search.js"></script>
  </div>

      <ul class="topics">
    <li data-nav-id="/about/" class="dd-item haschildren
        ">
      <div>
      <a href="/about/">About Velociraptor</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/about/features/" class="dd-item">
        <div>
          <a href="/about/features/">
            Velociraptor Features
          </a>
        </div>
    </li>
      <li data-nav-id="/about/license/" class="dd-item">
        <div>
          <a href="/about/license/">
            License
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/">Velociraptor Documentation</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/getting-started/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/getting-started/">Getting Started</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/getting-started/stand_alone/" class="dd-item">
        <div>
          <a href="/docs/getting-started/stand_alone/">
            Standalone Deployment
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/getting-started/deploying_clients/" class="dd-item">
        <div>
          <a href="/docs/getting-started/deploying_clients/">
            Deploying Clients
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/getting-started/cloud/" class="dd-item">
        <div>
          <a href="/docs/getting-started/cloud/">
            Deploying in the cloud
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/getting-started/triaging/" class="dd-item">
        <div>
          <a href="/docs/getting-started/triaging/">
            Triaging
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/user-interface/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/">User Interface</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/user-interface/investigating_clients/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/investigating_clients/">Investigating Clients</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/user-interface/investigating_clients/searching_clients/" class="dd-item">
        <div>
          <a href="/docs/user-interface/investigating_clients/searching_clients/">
            Searching for clients
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/investigating_clients/virtual_filesystem/" class="dd-item">
        <div>
          <a href="/docs/user-interface/investigating_clients/virtual_filesystem/">
            Client VFS
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/user-interface/artifacts/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/artifacts/">Velociraptor Artifacts</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/user-interface/artifacts/client_artifacts/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/client_artifacts/">
            Client Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/client_events/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/client_events/">
            Client Event Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/server_artifacts/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/server_artifacts/">
            Server Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/server_events/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/server_events/">
            Server Event Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/add_artifacts/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/add_artifacts/">
            Customizing Artifacts
          </a>
        </div>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/vql_reference/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/vql_reference/">VQL Reference</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/vql_reference/plugins/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/plugins/">
            VQL PLugins
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/event_plugins/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/event_plugins/">
            VQL Event PLugins
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/server/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/server/">
            VQL Server Plugins
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/functions/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/functions/">
            VQL Functions
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/templates/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/templates/">
            Report Templates
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/tips/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/tips/">
            Artifact Tips
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/filesystem_accessors/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/filesystem_accessors/">
            Filesystem Accessors
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/artifacts/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/artifacts/">Artifact Reference</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/artifacts/linux/" class="dd-item">
        <div>
          <a href="/docs/artifacts/linux/">
            Linux Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/windows_system/" class="dd-item">
        <div>
          <a href="/docs/artifacts/windows_system/">
            Windows System
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/server/" class="dd-item">
        <div>
          <a href="/docs/artifacts/server/">
            Server Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/triage/" class="dd-item">
        <div>
          <a href="/docs/artifacts/triage/">
            Windows Triage
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/detection/" class="dd-item">
        <div>
          <a href="/docs/artifacts/detection/">
            Windows Detection
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/events/" class="dd-item">
        <div>
          <a href="/docs/artifacts/events/">
            Windows Monitoring
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/misc/" class="dd-item">
        <div>
          <a href="/docs/artifacts/misc/">
            Miscelaneous
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/linux/linux/" class="dd-item">
        <div>
          <a href="/docs/artifacts/linux/linux/">
            Linux Artifacts
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/presentations/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/presentations/">Presentations and Workshops</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/presentations/rsa/" class="dd-item">
        <div>
          <a href="/docs/presentations/rsa/">
            RSA APJ 2019
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/crikeycon2019/" class="dd-item">
        <div>
          <a href="/docs/presentations/crikeycon2019/">
            Crikeycon 2019
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/nzitf2018/" class="dd-item">
        <div>
          <a href="/docs/presentations/nzitf2018/">
            NZITF 2018
          </a>
        </div>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li data-nav-id="/blog/" class="dd-item parent haschildren
        ">
      <div>
      <a href="/blog/">Velociraptor Blog</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i>
      </div>
        <ul>
        </ul>
    </li>




    <hr />
    <li></li>
    
    </ul>

 <section id="footer">
    </section>
  </div>
</nav>



<section id="body">
<div id="overlay"></div>
<div class="padding highlightable">

  <div id="top-bar">
    <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
        <span id="sidebar-toggle-span">
          <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
            <i class="fa fa-bars"></i>
          </a>
        </span>
        <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
        <span class="links">
        







 <a href='/'>Velociraptor / Dig deeper</a> > <a href='/blog/'>Velociraptor Blog</a> > Configuring Velociraptor for SSL

 

 

   
        </span>
    </div>
    
    
    <div class="progress">
        <div class="wrapper">
    
        </div>
    </div>
    

  </div>


<div id="body-inner">
  
    <h1>Configuring Velociraptor for SSL</h1>
  



    
    
    
    <div class="document">


<p>We have previously seen how to deploy a new Velociraptor server. For a
simple deployment we can have Velociraptor server and clients
provisioned in minutes.</p>
<p>Usually we deploy a specific Velociraptor deployment on our DFIR
engagements. We use cloud resources to provision the server and have
the clients connect to this cloud VM. A proper secure deployment of
Velociraptor will use SSL for securing both client communication and
protecting the web GUI.</p>
<p>In the past provisioning an SSL enabled web application was complex
and expensive - you had to create certificate signing requests,
interact with a CA. Pay for the certificates, then configure the
server. In particular you had to remember to renew the cert in 2 years
or your website suddenly broke!</p>
<p>Those days are over with the emergence of Lets Encrypt! and
autocert. These days applications can automatically provision their
own certificates. Velociraptor can manage its own certificates, fully
automatically - and then renew its certificates when the time comes
with no user intervention required.</p>
<p>In this blog post we will see how to configure a new Velociraptor
server in a cloud VM.</p>
<div class="section" id="setting-up-a-domain">
<h2>Setting up a domain</h2>
<p>The first step in deploying an SSL enabled web application is to have
a domain name. SSL verifies the authenticity of a web site by its DNS
name.</p>
<p>We go over to Google Domains and buy a domain. In this post I will be
using the domain <cite>rekall-innovations.com</cite>.</p>
</div>
<div class="section" id="provisioning-a-virtual-machine">
<h2>Provisioning a Virtual Machine</h2>
<p>Next we provision an Ubuntu VM from any cloud provider. Depending on
your deployment size your VM should be large enough. An 8 or 16Gb VM
should be sufficient for around 5-10k clients. Additionally we will
need sufficient disk space to hold the data we will collect. We
recommend to start with a modest amount of storage and then either
backup data as it gets collected or increase the storage volume as
needed.</p>
<p>Our virtual machine will receive connections over ports 80
and 443.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When using SSL both the client communication <em>and</em> the GUI
are served over the same ports to benefit from SSL transport
encryption.</p>
</div>
<p>When we deploy our Virtual Machine we may choose either a static IP
address or allow the cloud provider to assign a dynamic IP address. We
typically choose a dynamic IP address and so we need to configure
Dynamic DNS.</p>
<p>Go to the Google Domains dashboard and create a new dynamic DNS for
your domain. In our example we will use
<cite>velociraptor.rekall-innovations.com</cite> as our endpoint address.</p>
<img alt="1.png" src="1.png" />
<p>After the dynamic address is created, we can get the credentials for
updating the IP address.</p>
<img alt="2.png" src="2.png" />
<p>Next we install ddclient on our VM. This will update our dynamic IP
address whenever the external interface changes. Configure the file
<cite>/etc/ddclient.conf</cite>:</p>
<pre class="code text literal-block">
protocol=dyndns2
use=web
server=domains.google.com
ssl=yes
login=X13342342XYZ
password='slk43521kj'
velociraptor.rekall-innovations.com
</pre>
<p>Next configure the service to start:</p>
<pre class="code text literal-block">
# Configuration for ddclient scripts
# generated from debconf on Tue Oct 23 20:25:23 AEST 2018
#
# /etc/default/ddclient

# Set to &quot;true&quot; if ddclient should be run every time DHCP client ('dhclient'
# from package isc-dhcp-client) updates the systems IP address.
run_dhclient=&quot;false&quot;

# Set to &quot;true&quot; if ddclient should be run every time a new ppp connection is
# established. This might be useful, if you are using dial-on-demand.
run_ipup=&quot;false&quot;

# Set to &quot;true&quot; if ddclient should run in daemon mode
# If this is changed to true, run_ipup and run_dhclient must be set to false.
run_daemon=&quot;true&quot;

# Set the time interval between the updates of the dynamic DNS name in seconds.
# This option only takes effect if the ddclient runs in daemon mode.
daemon_interval=&quot;300&quot;
</pre>
<p>Run dhclient and check that it updates the address correctly.</p>
</div>
<div class="section" id="configuring-velociraptor-for-ssl">
<h2>Configuring Velociraptor for SSL</h2>
<p>Now comes the hard part! We need to configure Velociraptor to use
SSL. Edit the following in your <cite>server.config.yaml</cite> file (if you do
not have one yet you can generate one using <cite>velociraptor config
generate &gt; server.config.yaml</cite> ):</p>
<pre class="code yaml literal-block">
<span class="name tag">Client</span><span class="punctuation">:</span>
   <span class="name tag">server_urls</span><span class="punctuation">:</span>
   <span class="punctuation indicator">-</span> <span class="literal scalar plain">https://velociraptor.rekall-innovations.com/</span>

<span class="name tag">autocert_domain</span><span class="punctuation">:</span> <span class="literal scalar plain">velociraptor.rekall-innovations.com</span>
<span class="name tag">autocert_cert_cache</span><span class="punctuation">:</span> <span class="literal scalar plain">/etc/velociraptor_cache/</span>
</pre>
<p>The <cite>autocert_domain</cite> parameter tells Velociraptor to provision its
own cert for this domain automatically. The certificates will be
stored in the directory specified by <cite>autocert_cert_cache</cite>.  You don't
have to worry about rotating the certs, Velociraptor will
automatically renew them.</p>
<p>Obviously now the clients need to connect to the control channel over
SSL so we also need to direct the client's <cite>server_urls</cite> parameter to
the SSL port.</p>
<p>Lets start the frontend (We need to start Velociraptor as root because
it must be able to bind to port 80 and 443):</p>
<pre class="code bash literal-block">
$ sudo velociraptor --config server.config.yaml frontend -v

<span class="operator">[</span>INFO<span class="operator">]</span> <span class="literal number">2018</span>-12-22T17:12:42+10:00 Loaded <span class="literal number">43</span> built in artifacts
<span class="operator">[</span>INFO<span class="operator">]</span> <span class="literal number">2018</span>-12-22T17:12:42+10:00 Increased open file limit to <span class="literal number">999999</span>
<span class="operator">[</span>INFO<span class="operator">]</span> <span class="literal number">2018</span>-12-22T17:12:42+10:00 Launched gRPC API server on <span class="literal number">127</span>.0.0.1:8888
<span class="operator">[</span>INFO<span class="operator">]</span> <span class="literal number">2018</span>-12-22T17:12:42+10:00 Autocert specified - will listen on ports <span class="literal number">443</span> and <span class="literal number">80</span>. I will ignore specified GUI port at <span class="literal number">8889</span>
<span class="operator">[</span>INFO<span class="operator">]</span> <span class="literal number">2018</span>-12-22T17:12:42+10:00 Autocert specified - will listen on ports <span class="literal number">443</span> and <span class="literal number">80</span>. I will ignore specified Frontend port at <span class="literal number">8889</span>
<span class="operator">[</span>INFO<span class="operator">]</span> <span class="literal number">2018</span>-12-22T17:12:42+10:00 Frontend is ready to handle client requests using HTTPS
</pre>
<p>If all goes well we now can point our browser to
<cite>https://velociraptor.rekall-innovations.com/</cite> and it should just
work. Don't forget to provision a user and password using:</p>
<pre class="code bash literal-block">
$ velociraptor --config server.config.yaml user add mic
</pre>
</div>
<div class="section" id="notes">
<h2>Notes</h2>
<p>The autocert configuration is very easy to do but there are a few caveats:</p>
<ol class="arabic simple">
<li>Both ports 80 and 443 must be accessible over the web. This is
needed because Letsencrypt's servers need to connect to our domain
name in order to verify our domain ownership.</li>
<li>It is not possible to change the ports from port 80 and 443 due to
limitations in Letsencrypt's ACME protocol. This is why we can not
have more than one Velociraptor deployment on the same IP
currently.</li>
</ol>
<p>We have seen how easy it is to deploy secure Velociraptor servers. In
the next post we will discuss how to enhance security further by
deploying two factor authentication with Google's Single Sign On (SSO).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This feature will be available in the upcoming 0.27
release. You can try it now by building from git head.</p>
</div>
</div>
</div>

    
    
          <footer class=" footline" >
	
</footer>
  </div>
</div>

<div id="navigation">
<a class="nav nav-prev" href="/docs/presentations/nzitf2018/" title="New Zealand Internet Task Force Conference 2018"> <i class="fa fa-chevron-left"></i><label>New Zealand Internet Task Force Conference 2018</label></a>
    <a class="nav nav-next" href="/about/" title="About Velociraptor" style="margin-right: 0px;"><label>About Velociraptor</label><i class="fa fa-chevron-right"></i></a></div>

</section>
<div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
  <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
</div>    

<script src="/js/clipboard.min.js"></script>
<script src="/js/featherlight.min.js"></script>
<script src="/js/html5shiv-printshiv.min.js"></script>

<script src="/js/modernizr.custom.71422.js"></script>
<script src="/js/docdock.js"></script>
<script src="/theme-original/script.js"></script>


    

    
    

    
  </body>
</html>