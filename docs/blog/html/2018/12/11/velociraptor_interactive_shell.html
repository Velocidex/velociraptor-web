<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.56.0-DEV" />
    <meta name="description" content="One of the interesting new features in the latest release of
Velociraptor is an interactive shell. One can interact with the end
point over the standard Velociraptor communication mechanism - an
encrypted and authenticated channel.
">


    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>Velociraptor Interactive Shell :: Velociraptor - Digging Deeper!</title>

    
    <link href="/css/nucleus.css" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css" rel="stylesheet">
    <link href="/css/hybrid.css" rel="stylesheet">
    <link href="/css/featherlight.min.css" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css" rel="stylesheet">
    <link href="/css/auto-complete.css" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css" rel="stylesheet">
    <link href="/css/theme.css" rel="stylesheet">
    <link href="/css/hugo-theme.css" rel="stylesheet">
    
      <link href="/css/theme-mine.css" rel="stylesheet">
    

    <script src="/js/jquery-3.3.1.min.js"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/blog/html/2018/12/11/velociraptor_interactive_shell.html">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a href="/">
  <img src="/images/logo.svg" />
</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js"></script>
<script type="text/javascript" src="/js/auto-complete.js"></script>
<script type="text/javascript">
    
        var baseurl = "\/";
    
</script>
<script type="text/javascript" src="/js/search.js"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/about/" title="About Velociraptor" class="dd-item 
        
        
        
        ">
      <a href="/about/">
          Overview
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/about/features/" title="Velociraptor Features" class="dd-item ">
        <a href="/about/features/">
        Velociraptor Features
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/about/license/" title="GNU Affero General Public License" class="dd-item ">
        <a href="/about/license/">
        License
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/docs/" title="Velociraptor Documentation" class="dd-item 
        
        
        
        ">
      <a href="/docs/">
          Velociraptor Documentation
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/docs/getting-started/" title="Getting Started" class="dd-item 
        
        
        
        ">
      <a href="/docs/getting-started/">
          Getting Started
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/docs/getting-started/stand_alone/" title="Standalone Deployment" class="dd-item ">
        <a href="/docs/getting-started/stand_alone/">
        Standalone Deployment
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/getting-started/deploying_clients/" title="Deploying Clients" class="dd-item ">
        <a href="/docs/getting-started/deploying_clients/">
        Deploying Clients
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/getting-started/cloud/" title="Deploying in the cloud" class="dd-item ">
        <a href="/docs/getting-started/cloud/">
        Deploying in the cloud
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/getting-started/triaging/" title="Triaging" class="dd-item ">
        <a href="/docs/getting-started/triaging/">
        Triaging
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/docs/user-interface/" title="User Interface" class="dd-item 
        
        
        
        ">
      <a href="/docs/user-interface/">
          User Interface
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/docs/user-interface/investigating_clients/" title="Investigating Clients" class="dd-item 
        
        
        
        ">
      <a href="/docs/user-interface/investigating_clients/">
          Investigating Clients
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/docs/user-interface/investigating_clients/searching_clients/" title="Searching for clients" class="dd-item ">
        <a href="/docs/user-interface/investigating_clients/searching_clients/">
        Searching for clients
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/user-interface/investigating_clients/virtual_filesystem/" title="The Virtual File System" class="dd-item ">
        <a href="/docs/user-interface/investigating_clients/virtual_filesystem/">
        Client VFS
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/docs/user-interface/artifacts/" title="Velociraptor Artifacts" class="dd-item 
        
        
        
        ">
      <a href="/docs/user-interface/artifacts/">
          Velociraptor Artifacts
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/docs/user-interface/artifacts/client_artifacts/" title="Client Artifacts" class="dd-item ">
        <a href="/docs/user-interface/artifacts/client_artifacts/">
        Client Artifacts
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/user-interface/artifacts/client_events/" title="Client Event Artifacts" class="dd-item ">
        <a href="/docs/user-interface/artifacts/client_events/">
        Client Event Artifacts
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/user-interface/artifacts/server_artifacts/" title="Server Artifacts" class="dd-item ">
        <a href="/docs/user-interface/artifacts/server_artifacts/">
        Server Artifacts
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/user-interface/artifacts/server_events/" title="Server Event Artifacts" class="dd-item ">
        <a href="/docs/user-interface/artifacts/server_events/">
        Server Event Artifacts
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/user-interface/artifacts/add_artifacts/" title="Customizing Artifacts" class="dd-item ">
        <a href="/docs/user-interface/artifacts/add_artifacts/">
        Customizing Artifacts
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/use_cases/" title="Use Cases" class="dd-item ">
        <a href="/docs/use_cases/">
        Use Cases
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/docs/presentations/" title="Presentations and Workshops" class="dd-item 
        
        
        
        ">
      <a href="/docs/presentations/">
          Presentations and Workshops
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/docs/presentations/crikeycon2019/" title="Crikeycon 2019 Training Workshop" class="dd-item ">
        <a href="/docs/presentations/crikeycon2019/">
        CrikeyCon 2019
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/presentations/nzitf2018/" title="New Zealand Internet Task Force Conference 2018" class="dd-item ">
        <a href="/docs/presentations/nzitf2018/">
        NZITF2018
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/docs/vql_reference/" title="VQL Reference" class="dd-item 
        
        
        
        ">
      <a href="/docs/vql_reference/">
          VQL Reference
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/docs/vql_reference/templates/" title="Report Templates" class="dd-item ">
        <a href="/docs/vql_reference/templates/">
        Report Templates
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/vql_reference/event_plugins/" title="VQL Event PLugins" class="dd-item ">
        <a href="/docs/vql_reference/event_plugins/">
        VQL Event PLugins
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/vql_reference/functions/" title="VQL Functions" class="dd-item ">
        <a href="/docs/vql_reference/functions/">
        VQL Functions
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/vql_reference/plugins/" title="VQL PLugins" class="dd-item ">
        <a href="/docs/vql_reference/plugins/">
        VQL PLugins
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/vql_reference/server/" title="VQL Server Plugins" class="dd-item ">
        <a href="/docs/vql_reference/server/">
        VQL Server Plugins
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/tutorial/" title="Tutorial" class="dd-item ">
        <a href="/docs/tutorial/">
        Tutorial
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/docs/artifacts/" title="Artifact Reference" class="dd-item 
        
        
        
        ">
      <a href="/docs/artifacts/">
          Artifact Reference
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/docs/artifacts/linux/linux/" title="Linux Artifacts" class="dd-item ">
        <a href="/docs/artifacts/linux/linux/">
        Linux Artifacts
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/artifacts/misc/" title="Miscelaneous Artifacts" class="dd-item ">
        <a href="/docs/artifacts/misc/">
        Miscelaneous
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/artifacts/server/" title="Server Artifacts" class="dd-item ">
        <a href="/docs/artifacts/server/">
        Server Artifacts
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/artifacts/detection/" title="Windows Malware Detection" class="dd-item ">
        <a href="/docs/artifacts/detection/">
        Windows Detection
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/artifacts/events/" title="Windows Event Monitoring" class="dd-item ">
        <a href="/docs/artifacts/events/">
        Windows Monitoring
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/artifacts/windows_system/" title="Windows System" class="dd-item ">
        <a href="/docs/artifacts/windows_system/">
        Windows System
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/artifacts/triage/" title="Windows Triage Artifacts" class="dd-item ">
        <a href="/docs/artifacts/triage/">
        Windows Triage
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/blog/" title="Velociraptor Blog" class="dd-item 
        parent
        
        
        ">
      <a href="/blog/">
          Velociraptor Blog
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2019/03/02/agentless_hunting_with_velociraptor.html" title="Agentless hunting with Velociraptor" class="dd-item ">
        <a href="/blog/html/2019/03/02/agentless_hunting_with_velociraptor.html">
        Agentless hunting with Velociraptor
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2019/02/14/alerting_on_event_patterns.html" title="Alerting on event patterns" class="dd-item ">
        <a href="/blog/html/2019/02/14/alerting_on_event_patterns.html">
        Alerting on event patterns
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2019/02/10/velociraptor_performance.html" title="Velociraptor Performance" class="dd-item ">
        <a href="/blog/html/2019/02/10/velociraptor_performance.html">
        Velociraptor Performance
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2019/02/09/velociraptor_python_api.html" title="The Velociraptor Python API" class="dd-item ">
        <a href="/blog/html/2019/02/09/velociraptor_python_api.html">
        The Velociraptor Python API
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/09/03/velociraptor_s_client_communications.html" title="Velociraptor&#39;s client communications" class="dd-item ">
        <a href="/blog/html/2018/09/03/velociraptor_s_client_communications.html">
        Velociraptor&#39;s client communications
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/12/23/deploying_velociraptor_with_oauth_sso.html" title="Deploying Velociraptor with OAuth SSO" class="dd-item ">
        <a href="/blog/html/2018/12/23/deploying_velociraptor_with_oauth_sso.html">
        Deploying Velociraptor with OAuth SSO
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/12/22/configuring_velociraptor_for_ssl.html" title="Configuring Velociraptor for SSL" class="dd-item ">
        <a href="/blog/html/2018/12/22/configuring_velociraptor_for_ssl.html">
        Configuring Velociraptor for SSL
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/12/11/velociraptor_interactive_shell.html" title="Velociraptor Interactive Shell" class="dd-item active">
        <a href="/blog/html/2018/12/11/velociraptor_interactive_shell.html">
        Velociraptor Interactive Shell
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/12/10/server_side_vql_queries_and_events.html" title="Server side VQL queries and Escalation Events" class="dd-item ">
        <a href="/blog/html/2018/12/10/server_side_vql_queries_and_events.html">
        Server side VQL queries and Escalation Events
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/12/09/more_on_client_event_collection.html" title="More on client event collection" class="dd-item ">
        <a href="/blog/html/2018/12/09/more_on_client_event_collection.html">
        More on client event collection
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/11/13/velociraptor_training_at_nzitf.html" title="Velociraptor training at NZITF" class="dd-item ">
        <a href="/blog/html/2018/11/13/velociraptor_training_at_nzitf.html">
        Velociraptor training at NZITF
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/11/09/event_queries_and_endpoint_monitoring.html" title="Event Queries and Endpoint Monitoring" class="dd-item ">
        <a href="/blog/html/2018/11/09/event_queries_and_endpoint_monitoring.html">
        Event Queries and Endpoint Monitoring
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/09/30/velorciraptor_s_filesystem_s_accessors.html" title="Velorciraptor&#39;s filesystem&#39;s accessors" class="dd-item ">
        <a href="/blog/html/2018/09/30/velorciraptor_s_filesystem_s_accessors.html">
        Velorciraptor&#39;s filesystem&#39;s accessors
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/09/29/detecting_powershell_persistence_with_velociraptor_and_yara.html" title="Detecting powershell persistence with Velociraptor and Yara" class="dd-item ">
        <a href="/blog/html/2018/09/29/detecting_powershell_persistence_with_velociraptor_and_yara.html">
        Detecting powershell persistence with Velociraptor and Yara
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/09/03/velociraptor_walk_through_and_demo.html" title="Velociraptor walk through and demo" class="dd-item ">
        <a href="/blog/html/2018/09/03/velociraptor_walk_through_and_demo.html">
        Velociraptor walk through and demo
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/08/20/velociraptor_artifacts.html" title="Velociraptor Artifacts" class="dd-item ">
        <a href="/blog/html/2018/08/20/velociraptor_artifacts.html">
        Velociraptor Artifacts
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/08/10/browsing_around_the_filesystem.html" title="Browsing around the filesystem." class="dd-item ">
        <a href="/blog/html/2018/08/10/browsing_around_the_filesystem.html">
        Browsing around the filesystem.
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/08/10/design_differences_between_velociraptor_and_grr.html" title="Design differences between Velociraptor and GRR" class="dd-item ">
        <a href="/blog/html/2018/08/10/design_differences_between_velociraptor_and_grr.html">
        Design differences between Velociraptor and GRR
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/02/09/files_files_everything_is_just_a_file.html" title="Files, files everything is just a file!" class="dd-item ">
        <a href="/blog/html/2018/02/09/files_files_everything_is_just_a_file.html">
        Files, files everything is just a file!
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/08/10/hunting_what_velociraptors_do_best.html" title="Hunting - What Velociraptors do best!" class="dd-item ">
        <a href="/blog/html/2018/08/10/hunting_what_velociraptors_do_best.html">
        Hunting - What Velociraptors do best!
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/08/10/interrogation_make_the_endpoint_tell_us_what_it_knows.html" title="Interrogation - Make the endpoint tell us what it knows!" class="dd-item ">
        <a href="/blog/html/2018/08/10/interrogation_make_the_endpoint_tell_us_what_it_knows.html">
        Interrogation - Make the endpoint tell us what it knows!
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/08/10/the_velocidex_query_language.html" title="Velocidex Query Language (VQL)" class="dd-item ">
        <a href="/blog/html/2018/08/10/the_velocidex_query_language.html">
        Velocidex Query Language (VQL)
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/08/10/introducing_velociraptor.html" title="Introducing Velociraptor" class="dd-item ">
        <a href="/blog/html/2018/08/10/introducing_velociraptor.html">
        Introducing Velociraptor
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
         
    </ul>

    
    

    
    <section id="footer">
      
    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                   Velociraptor Interactive Shell 
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">

    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Velociraptor Interactive Shell
            </h1>
          

        



<div class="document">


<p>One of the interesting new features in the latest release of
Velociraptor is an interactive shell. One can interact with the end
point over the standard Velociraptor communication mechanism - an
encrypted and authenticated channel.</p>
<p>This feature is implemented by utilizing the Velociraptor event
monitoring, server side VQL queries. This post explores how these
components come together to deliver a responsive, interactive
workflow.</p>
<div class="section" id="endpoint-shell-access">
<h2>Endpoint shell access</h2>
<p>Although we generally try to avoid it, sometimes the easiest way to
extract certain information is to run a command and parse its
output. For example, consider the windows <cite>ipconfig</cite> command. It is
possible to extract this information using win32 apis but this
requires additional code to be written in the client. The <cite>ipconfig</cite>
command is guaranteed to be available. Soemtimes running a command and
parsing its output is the easiest option.</p>
<p>The GRR client has a client action which can run a command. However
that client action is restricted to run a whitelist of commands, since
GRR chose to prevent the running of arbitrary commands on the
endpoint. In practice, though it is difficult to add new commands to
the whitelist (and rebuild and deploy new clients that have the
updated whitelist). But users need to run arbitrary commands
(including their own third party tools) anyway. So in the GRR world,
most people use &quot;python hacks&quot; routinely to run arbitrary commands.</p>
<p>When we came to redesign Velociraptor we pondered if arbitrary command
execution should be included or not. To be sure, this is a dangerous
capability - effectively giving Velociraptor root level access on the
endpoint. In our experience restricting it in an arbitrary way (as was
done in GRR) is not useful because it is harder adapt to real incident
response needs (you hardly ever know in advance what is needed at 2am
in the morning when trying to triage an incident!).</p>
<p>Other endpoint monitoring tools also have a shell interface (For
example Carbon Black). It is understood that this feature is extremely
powerful, but it is necessary sometimes.</p>
<p>Velociraptor mitigates this risk in a few ways:</p>
<ol class="arabic simple">
<li>If an organization deems the ability to run arbitrary commands too
dangerous, they can completely disable this feature in the client's
configuration.</li>
<li>Every shell command run by the client is audited and its output is
archived. Misuse can be easily detected and investigated.</li>
<li>This feature is considered high risk and it is not available via
the GUI. One must use the velociraptor binary on the server itself
to run the interactive shell.</li>
</ol>
</div>
<div class="section" id="interactive-shell">
<h2>Interactive Shell</h2>
<p>The interactive shell feature is accessed by issueing the shell
command to the velociraptor binary:</p>
<pre class="code bash literal-block">
$ velociraptor --config ~/server.config.yaml shell C.7403676ab8664b2b
C.7403676ab8664b2b <span class="operator">(</span>trek<span class="operator">)</span> &gt;ls /
Running ls / on C.7403676ab8664b2b
Received response at <span class="literal number">2018</span>-12-11 <span class="literal number">13</span>:12:35 +1000 AEST - Return code <span class="literal number">0</span>

bin
boot
core
data
dev

C.7403676ab8664b2b <span class="operator">(</span>trek<span class="operator">)</span> &gt;id
Running id on C.7403676ab8664b2b
Received response at <span class="literal number">2018</span>-12-11 <span class="literal number">13</span>:13:05 +1000 AEST - Return code <span class="literal number">0</span>

<span class="name variable">uid</span><span class="operator">=</span><span class="literal number">1000</span><span class="operator">(</span>mic<span class="operator">)</span> <span class="name variable">gid</span><span class="operator">=</span><span class="literal number">1000</span><span class="operator">(</span>mic<span class="operator">)</span> <span class="name variable">groups</span><span class="operator">=</span><span class="literal number">1000</span><span class="operator">(</span>mic<span class="operator">)</span>,4<span class="operator">(</span>adm<span class="operator">)</span>,24<span class="operator">(</span>cdrom<span class="operator">)</span>,27<span class="operator">(</span>sudo<span class="operator">)</span>

C.7403676ab8664b2b <span class="operator">(</span>trek<span class="operator">)</span> &gt;whoami
Running whoami on C.7403676ab8664b2b
Received response at <span class="literal number">2018</span>-12-11 <span class="literal number">13</span>:13:10 +1000 AEST - Return code <span class="literal number">0</span>

mic
</pre>
<p>As you can see it is pretty straight forward - type a command, the
command is sent to the client, and the client responds with the
output.</p>
</div>
<div class="section" id="how-does-it-work">
<h2>How does it work?</h2>
<p>The main components are shown in the figure below. Note that the shell
process is a different process from the frontend:</p>
<img alt="interactive_shell_workflow.png" src="interactive_shell_workflow.png" />
<p>The workflow starts when a user issues a command (for example &quot;ls -l
/&quot;) on the terminal. The shell process schedules a VQL query for the
client:</p>
<pre class="code psql literal-block">
<span class="keyword">SELECT</span> <span class="name">now</span><span class="punctuation">()</span> <span class="keyword">as</span> <span class="name builtin">Timestamp</span><span class="punctuation">,</span> <span class="name">Argv</span><span class="punctuation">,</span> <span class="keyword">Stdout</span><span class="punctuation">,</span>
     <span class="name">Stderr</span><span class="punctuation">,</span> <span class="name">ReturnCode</span> <span class="keyword">FROM</span> <span class="name">execve</span><span class="punctuation">(</span><span class="name">argv</span><span class="operator">=</span><span class="punctuation">[</span><span class="literal string single">'ls'</span><span class="punctuation">,</span> <span class="literal string single">'-l'</span><span class="punctuation">,</span> <span class="literal string single">'/'</span><span class="punctuation">])</span>
</pre>
<p>However, this query is scheduled as part of the monitoring flow -
which means it's response will be sent and stored with the monitoring
logs. As soon as the shell process schedules the VQL query the
frontend is notified and the client is woken. Note that due to
Velociraptor's near instantaneous communication protocol this causes
the client to run the command almost immediately.</p>
<p>The client executes the query which returns one or more rows
containing the Stdout of the process. The client will then send the
response to the server as a monitoring event. The frontend will then
append the event to a CSV file.</p>
<p>After sending the initial client query, the interactive shell process
will issue a watch VQL query to watch for the shell response:</p>
<pre class="code psql literal-block">
<span class="keyword">SELECT</span> <span class="name">ReturnCode</span><span class="punctuation">,</span> <span class="keyword">Stdout</span><span class="punctuation">,</span> <span class="name">Stderr</span><span class="punctuation">,</span> <span class="name builtin">Timestamp</span><span class="punctuation">,</span> <span class="name">Argv</span>
<span class="keyword">FROM</span> <span class="name">watch_monitoring</span><span class="punctuation">(</span><span class="name">client_id</span><span class="operator">=</span><span class="name">ClientId</span><span class="punctuation">,</span> <span class="name">artifact</span><span class="operator">=</span><span class="literal string single">'Shell'</span><span class="punctuation">)</span>
</pre>
<p>The process now blocks until this second query detects the response
arrived on the monitoring queue. Now we simply display the result and
go back to the interactive prompt.</p>
<p>Note that the interactive shell is implemented using the same basic
building blocks that Velociraptor offers:</p>
<ol class="arabic simple">
<li>Issuing client VQL queries.</li>
<li>Waking the client immediately gives instant results (no need for polling).</li>
<li>Utilizing the event monitoring flow to receive results from queries immediately.</li>
<li>Writing server side event queries to watch for new events, such as responses from the client.</li>
</ol>
<p>Note that the frontend is very simple and does no specific processing
of the interactive shell, the feature is implemented completely within
the interactive shell process itself. This design lowers the load on
the frontends since their job is very simple, but enables complex post
processing and interaction to tbe implemented by other processes.</p>
</div>
<div class="section" id="auditing">
<h2>Auditing</h2>
<p>We mentioned previously that running shell commands on endpoints is a
powerful feature and we need to audit its use closely. Since shell
command output is implemented via the monitored event queues it should
be obvious that we can monitor all such commands by simply watching
the Shell artifact event queue:</p>
<pre class="code bash literal-block">
$ velociraptor query <span class="literal string double">&quot;select * from watch_monitoring(artifact='Shell')&quot;</span>
<span class="operator">[</span>
 <span class="operator">{</span>
  <span class="literal string double">&quot;Argv&quot;</span>: <span class="literal string double">&quot;\&quot;{\\\&quot;Argv\\\&quot;:[\\\&quot;id\\\&quot;]}\&quot;&quot;</span>,
  <span class="literal string double">&quot;Artifact&quot;</span>: <span class="literal string double">&quot;Shell&quot;</span>,
  <span class="literal string double">&quot;ClientId&quot;</span>: <span class="literal string double">&quot;C.7403676ab8664b2b&quot;</span>,
  <span class="literal string double">&quot;ReturnCode&quot;</span>: <span class="literal string double">&quot;0&quot;</span>,
  <span class="literal string double">&quot;Stderr&quot;</span>: <span class="literal string double">&quot;\&quot;\&quot;&quot;</span>,
  <span class="literal string double">&quot;Stdout&quot;</span>: <span class="literal string double">&quot;\&quot;uid=1000(mic) gid=1000(mic) groups=1000(mic)\\n\&quot;&quot;</span>,
  <span class="literal string double">&quot;Timestamp&quot;</span>: <span class="literal string double">&quot;1544499929&quot;</span>
 <span class="operator">}</span>
<span class="operator">]</span>
</pre>
<p>We can easily write an artifact that escalates any use of the
interactive shell by sending the admin an mail (See previous blog
post). This way we can see if someone missused the
feature. Alternatively we may simply archive the event queue CSV file
for long term auditing of any interactive shell use.</p>
</div>
</div>

<footer class=" footline" >
	
</footer>


        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/blog/html/2018/12/22/configuring_velociraptor_for_ssl.html" title="Configuring Velociraptor for SSL"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/blog/html/2018/12/10/server_side_vql_queries_and_events.html" title="Server side VQL queries and Escalation Events" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js"></script>
    <script src="/js/perfect-scrollbar.min.js"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js"></script>
    <script src="/js/jquery.sticky.js"></script>
    <script src="/js/featherlight.min.js"></script>
    <script src="/js/html5shiv-printshiv.min.js"></script>
    <script src="/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js"></script>
    <script src="/js/learn.js"></script>
    <script src="/js/hugo-learn.js"></script>

    <link href="/mermaid/mermaid.css" rel="stylesheet" />
    <script src="/mermaid/mermaid.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    

  </body>
</html>

