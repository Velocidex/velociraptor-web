<!DOCTYPE html>
<html>
  <head>
    <title>Velociraptor / Dig deeper</title>
    
      <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Deploying Velociraptor with OAuth SSO :: Velociraptor / Dig deeper</title>
<link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link rel="stylesheet" href="/css/bootstrap.min.css">
<link href="/css/nucleus.css" rel="stylesheet">
<link href="/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/hybrid.css" rel="stylesheet">
<link href="/css/featherlight.min.css" rel="stylesheet">
<link href="/css/auto-complete.css" rel="stylesheet">
<link href="/theme-original/style.css" rel="stylesheet">

  <link href="/theme-original/variant-mine.css" rel="stylesheet">


<script src="/js/jquery-2.x.min.js"></script>
<style type="text/css">
  :root #header + #content > #left > #rlblock_left {
    display:none !important;
  }
</style>
<link rel="stylesheet" href="/css/theme-mine.css">
<script src="/js/custom.js"></script>


    
  </head>
  <body data-url="/blog/html/2018/12/23/deploying_velociraptor_with_oauth_sso.html">
    
      <div id="headermain"></div>
<nav id="sidebar" class="">



<div class="highlightable">
  <div id="header-wrapper">
    <div id="header">
      
	
  
    <a href="/">
  <img src="/images/logo.svg">
</a>
  


    </div>
        <div class="searchbox">
		    <label for="search-by"><i class="fa fa-search"></i></label>
		    <input data-search-input id="search-by" type="text" placeholder="Search...">
		    <span data-search-clear=""><i class="fa fa-close"></i></span>
		</div>
		<script type="text/javascript" src="/js/lunr.min.js"></script>
		<script type="text/javascript" src="/js/auto-complete.js"></script>
		<script type="text/javascript">
        
            var baseurl = "\/";
        
		</script>
		<script type="text/javascript" src="/js/search.js"></script>
  </div>

      <ul class="topics">
    <li data-nav-id="/about/" class="dd-item haschildren
        ">
      <div>
      <a href="/about/">About Velociraptor</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/about/features/" class="dd-item">
        <div>
          <a href="/about/features/">
            Velociraptor Features
          </a>
        </div>
    </li>
      <li data-nav-id="/about/license/" class="dd-item">
        <div>
          <a href="/about/license/">
            License
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/">Velociraptor Documentation</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/getting-started/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/getting-started/">Getting Started</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/getting-started/stand_alone/" class="dd-item">
        <div>
          <a href="/docs/getting-started/stand_alone/">
            Standalone Deployment
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/getting-started/deploying_clients/" class="dd-item">
        <div>
          <a href="/docs/getting-started/deploying_clients/">
            Deploying Clients
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/getting-started/cloud/" class="dd-item">
        <div>
          <a href="/docs/getting-started/cloud/">
            Deploying in the cloud
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/getting-started/triaging/" class="dd-item">
        <div>
          <a href="/docs/getting-started/triaging/">
            Triaging
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/user-interface/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/">User Interface</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/user-interface/investigating_clients/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/investigating_clients/">Investigating Clients</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/user-interface/investigating_clients/searching_clients/" class="dd-item">
        <div>
          <a href="/docs/user-interface/investigating_clients/searching_clients/">
            Searching for clients
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/investigating_clients/virtual_filesystem/" class="dd-item">
        <div>
          <a href="/docs/user-interface/investigating_clients/virtual_filesystem/">
            Client VFS
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/user-interface/artifacts/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/artifacts/">Velociraptor Artifacts</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/user-interface/artifacts/client_artifacts/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/client_artifacts/">
            Client Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/client_events/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/client_events/">
            Client Event Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/server_artifacts/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/server_artifacts/">
            Server Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/server_events/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/server_events/">
            Server Event Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/add_artifacts/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/add_artifacts/">
            Customizing Artifacts
          </a>
        </div>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/vql_reference/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/vql_reference/">VQL Reference</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/vql_reference/plugins/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/plugins/">
            VQL PLugins
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/event_plugins/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/event_plugins/">
            VQL Event PLugins
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/server/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/server/">
            VQL Server Plugins
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/functions/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/functions/">
            VQL Functions
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/templates/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/templates/">
            Report Templates
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/tips/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/tips/">
            Artifact Tips
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/filesystem_accessors/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/filesystem_accessors/">
            Filesystem Accessors
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/artifacts/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/artifacts/">Artifact Reference</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/artifacts/linux/" class="dd-item">
        <div>
          <a href="/docs/artifacts/linux/">
            Linux Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/windows_system/" class="dd-item">
        <div>
          <a href="/docs/artifacts/windows_system/">
            Windows System
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/server/" class="dd-item">
        <div>
          <a href="/docs/artifacts/server/">
            Server Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/triage/" class="dd-item">
        <div>
          <a href="/docs/artifacts/triage/">
            Windows Triage
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/detection/" class="dd-item">
        <div>
          <a href="/docs/artifacts/detection/">
            Windows Detection
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/events/" class="dd-item">
        <div>
          <a href="/docs/artifacts/events/">
            Windows Monitoring
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/misc/" class="dd-item">
        <div>
          <a href="/docs/artifacts/misc/">
            Miscelaneous
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/linux/linux/" class="dd-item">
        <div>
          <a href="/docs/artifacts/linux/linux/">
            Linux Artifacts
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/presentations/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/presentations/">Presentations and Workshops</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/presentations/sans_dfir_summit2019/" class="dd-item">
        <div>
          <a href="/docs/presentations/sans_dfir_summit2019/">
            SANS 2019
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/rsa/" class="dd-item">
        <div>
          <a href="/docs/presentations/rsa/">
            RSA APJ 2019
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/crikeycon2019/" class="dd-item">
        <div>
          <a href="/docs/presentations/crikeycon2019/">
            Crikeycon 2019
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/nzitf2018/" class="dd-item">
        <div>
          <a href="/docs/presentations/nzitf2018/">
            NZITF 2018
          </a>
        </div>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li data-nav-id="/blog/" class="dd-item parent haschildren
        ">
      <div>
      <a href="/blog/">Velociraptor Blog</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i>
      </div>
        <ul>
        </ul>
    </li>




    <hr />
    <li></li>
    
    </ul>

 <section id="footer">
    </section>
  </div>
</nav>



<section id="body">
<div id="overlay"></div>
<div class="padding highlightable">

  <div id="top-bar">
    <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
        <span id="sidebar-toggle-span">
          <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
            <i class="fa fa-bars"></i>
          </a>
        </span>
        <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
        <span class="links">
        







 <a href='/'>Velociraptor / Dig deeper</a> > <a href='/blog/'>Velociraptor Blog</a> > Deploying Velociraptor with OAuth SSO

 

 

   
        </span>
    </div>
    
    
    <div class="progress">
        <div class="wrapper">
    
        </div>
    </div>
    

  </div>


<div id="body-inner">
  
    <h1>Deploying Velociraptor with OAuth SSO</h1>
  



    
    
    
    <div class="document">


<p>In the previous post we saw how to set up Velociraptor's GUI over
SSL. This is great, but we still need to create users and assign them
passwords manually. The trouble with user account management is that
we can not enforce 2 factor authentication, or any password policies
or any of the usual enterprise requirements for user account
management. It is also difficult for users to remember yet another
password for a separate system, and so might make the password easily
guessable.</p>
<p>Most enterprise systems require an SSO mechanism to manage user
accounts and passwords. Manual user account management simply does not
scale!</p>
<p>In this post we discuss how to enable Google's SSO authentication for
Velociraptor identity management.</p>
<div class="section" id="oauth-identity-management">
<h2>OAuth Identity management</h2>
<p>Velociraptor can use Google's oauth mechanism to verify a user's
identity. This requires a user to authenticate to Google via their
usual mechanism - if their account requires 2 factor authentication,
then users need to log in this way.</p>
<p>Once the user authenticates to Google, they are redirected back into
the Velociraptor application with a token that allows the application
to request information about the user (for example, the username or
email address).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">OAuth is an authentication protocol. This means Velociraptor
can be pretty confident the user is who they claim they
are. This does not automatically grant them access to the
application! A Velociraptor administrator must still
manually grant them access before a user may log in.</p>
</div>
<p>Before we can use Google for Authentication, we need to register our
Velociraptor deployment as an OAuth App with Google. Unfortunately
Google is not known for having intuitive and easy to follow processes
so actually doing this is complicated and bounces through many
seemingly unrelated Google products and services. This post attempts
to document this process at it exists in this time.</p>
<p>For our example we assume that our server is located at
<a class="reference external" href="https://velociraptor.rekall-innovations.com">https://velociraptor.rekall-innovations.com</a> as we continue on from our
example in the last post (i.e. it is already configured to use SSL).</p>
</div>
<div class="section" id="registering-velociraptor-as-an-oauth-application">
<h2>Registering Velociraptor as an OAuth application</h2>
<p>The first step is to register Velociraptor as an OAuth app. We do this
by accessing the Google cloud console at
<a class="reference external" href="https://console.cloud.google.com">https://console.cloud.google.com</a> . You will need to set up a cloud
account first and create a cloud project. Although in this example we
do not necessarily need to host our application on Google cloud or
have anything to do with Google cloud, OAuth seems to exist within the
Google cloud product.</p>
<p>Our ultimate goal is to obtain OAuth credentials to give our
Velociraptor app, but we have to have a few things set up first. The
cloud console is fairly confusing so I usually use the search feature
to find exactly what I need. Searching for &quot;oauth&quot; at the search bar
indicates that it is under &quot;APIs and Services&quot;.</p>
<p>We need to set up the OAuth consent screen first - in which we give
our application a name to be presented to the user by the OAuth flow:</p>
<img alt="1.png" src="1.png" />
<p>Further down we need to provide an authorized domain</p>
<img alt="2.png" src="2.png" />
<p>In order to add an Authorized domain we need to <em>verify it</em>. Google's
help pages explain it further:</p>
<div class="admonition admonition-authorized-domains">
<p class="first admonition-title">Authorized domains</p>
<p class="last">To protect you and your users, Google restricts your OAuth 2.0
application to using Authorized Domains. If you have verified the
domain with Google, you can use any Top Private Domain as an
Authorized Domain.</p>
</div>
<p>And this links to <a class="reference external" href="https://www.google.com/webmasters/tools/home">https://www.google.com/webmasters/tools/home</a> which
again seems completely unrelated to OAuth, Velociraptor or even a web
app (the web masters product is supposed to help sites increase their
search presence).</p>
<p>Within this product we now need to &quot;Add a property&quot;:</p>
<img alt="3.png" src="3.png" />
<p>Hidden within the settings menu there is an option &quot;Verification
Details&quot; which allows you to verify that you own the domain. If you
purchased your domain from Google Domains then it should already be
verified - otherwise you can set some TXT records to prove you own the
domain.</p>
<img alt="4.png" src="4.png" />
<p>After all this we can go back to the cloud console and Create
Credentials/OAuth client ID:</p>
<img alt="5.png" src="5.png" />
<p>Now select &quot;Web App&quot; and we must set the &quot;Authorized redirect URIs&quot; to
<a class="reference external" href="https://velociraptor.rekall-innovations.com/auth/google/callback">https://velociraptor.rekall-innovations.com/auth/google/callback</a> -
This is the URL that successful OAuth authentication will direct
to. Velociraptor accepts this redirect and uses it to log the user on.</p>
<img alt="6.png" src="6.png" />
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The UI is a bit confusing here - you must press enter after
typing the redirect URL to have it registered <strong>before</strong> you
hit <em>Create</em> otherwise it misses that you typed it
completely. I spent some time stumped on this UI bug.</p>
</div>
<p>If all goes well the Google cloud console will give us a client ID and
a client secret. We can then copy those into the Velociraptor
configuration file under the GUI section:</p>
<pre class="code yaml literal-block">
<span class="name tag">GUI</span><span class="punctuation">:</span>
  <span class="name tag">google_oauth_client_id</span><span class="punctuation">:</span> <span class="literal scalar plain">1234xxxxxx.apps.googleusercontent.com</span>
  <span class="name tag">google_oauth_client_secret</span><span class="punctuation">:</span> <span class="literal scalar plain">qsadlkjhdaslkjasd</span>
  <span class="name tag">public_url</span><span class="punctuation">:</span> <span class="literal scalar plain">https://velociraptor.rekall-innovations.com/</span>

<span class="name tag">logging</span><span class="punctuation">:</span>
  <span class="name tag">output_directory</span><span class="punctuation">:</span> <span class="literal scalar plain">/var/log/velociraptor/</span>
  <span class="name tag">separate_logs_per_component</span><span class="punctuation">:</span> <span class="literal scalar plain">true</span>
</pre>
<p>In the above config we also enabled logging (which is important for a
secure application!). The <cite>separate_logs_per_component</cite> option will
create a separate log file for the GUI, Frontend as well as important
Audit related events.</p>
<p>Now we can start the Velociraptor frontend:</p>
<pre class="code bash literal-block">
$ velociraptor --config server.config.yaml frontend
</pre>
<p>Connecting using the browser goes through the familiar OAuth flow and
arrives at this Velociraptor screen:</p>
<img alt="7.png" src="7.png" />
<p>The OAuth flow ensures the user's identity is correct but does not
give them permission to log into Velociraptor. Note that having an
OAuth enabled application on the web allows anyone with a Google
identity to authenticate to the application but the user is still
required to be authorized. We can see the following in the Audit logs:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;level&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;error&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;method&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;GET&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;User rejected by GUI&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;remote&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;192.168.0.10:40570&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;time&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;2018-12-21T18:17:47+10:00&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;user&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;mike&#64;velocidex.com&quot;</span>
<span class="punctuation">}</span>
</pre>
<p>In order to authorize the user we must explicitly add them using the
velociraptor admin tool:</p>
<pre class="code bash literal-block">
$ velociraptor --config ~/server.config.yaml user add mike&#64;velocidex.com
Authentication will occur via Google - therefore no password needs to be set.
</pre>
<p>Note that this time, Velociraptor does not ask for a password at all,
since authentication occurs using Google's SSO. If we hit refresh in
the browser we can now see the Velociraptor application:</p>
<img alt="8.png" src="8.png" />
<p>We can see that the logged in user is authenticated by Google, and we
can also see their Google avatar at the top right for some more eye
candy :-).</p>
<div class="admonition admonition-thanks">
<p class="first admonition-title">Thanks</p>
<p class="last">Shouts to the folks from <a class="reference external" href="https://www.kleinco.com.au/">Klein &amp; Co</a> who sponsored this exciting
feature!.</p>
</div>
</div>
</div>

    
    
          <footer class=" footline" >
	
</footer>
  </div>
</div>

<div id="navigation">
<a class="nav nav-prev" href="/docs/presentations/nzitf2018/" title="New Zealand Internet Task Force Conference 2018"> <i class="fa fa-chevron-left"></i><label>New Zealand Internet Task Force Conference 2018</label></a>
    <a class="nav nav-next" href="/about/" title="About Velociraptor" style="margin-right: 0px;"><label>About Velociraptor</label><i class="fa fa-chevron-right"></i></a></div>

</section>
<div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
  <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
</div>    

<script src="/js/clipboard.min.js"></script>
<script src="/js/featherlight.min.js"></script>
<script src="/js/html5shiv-printshiv.min.js"></script>

<script src="/js/modernizr.custom.71422.js"></script>
<script src="/js/docdock.js"></script>
<script src="/theme-original/script.js"></script>


    

    
    

    
  </body>
</html>