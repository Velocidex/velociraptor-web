<!DOCTYPE html>
<html>
  <head>
    <title>Velociraptor / Dig deeper</title>
    
      <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Hunting - What Velociraptors do best! :: Velociraptor / Dig deeper</title>
<link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link rel="stylesheet" href="/css/bootstrap.min.css">
<link href="/css/nucleus.css" rel="stylesheet">
<link href="/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/hybrid.css" rel="stylesheet">
<link href="/css/featherlight.min.css" rel="stylesheet">
<link href="/css/auto-complete.css" rel="stylesheet">
<link href="/theme-original/style.css" rel="stylesheet">

  <link href="/theme-original/variant-mine.css" rel="stylesheet">


<script src="/js/jquery-2.x.min.js"></script>
<style type="text/css">
  :root #header + #content > #left > #rlblock_left {
    display:none !important;
  }
</style>
<link rel="stylesheet" href="/css/theme-mine.css">
<script src="/js/custom.js"></script>


    
  </head>
  <body data-url="/blog/html/2018/08/10/hunting_what_velociraptors_do_best.html">
    
      <div id="headermain"></div>
<nav id="sidebar" class="">



<div class="highlightable">
  <div id="header-wrapper">
    <div id="header">
      
	
  
    <a href="/">
  <img src="/images/logo.svg">
</a>
  


    </div>
        <div class="searchbox">
		    <label for="search-by"><i class="fa fa-search"></i></label>
		    <input data-search-input id="search-by" type="text" placeholder="Search...">
		    <span data-search-clear=""><i class="fa fa-close"></i></span>
		</div>
		<script type="text/javascript" src="/js/lunr.min.js"></script>
		<script type="text/javascript" src="/js/auto-complete.js"></script>
		<script type="text/javascript">
        
            var baseurl = "\/";
        
		</script>
		<script type="text/javascript" src="/js/search.js"></script>
  </div>

      <ul class="topics">
    <li data-nav-id="/about/" class="dd-item haschildren
        ">
      <div>
      <a href="/about/">About Velociraptor</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/about/features/" class="dd-item">
        <div>
          <a href="/about/features/">
            Velociraptor Features
          </a>
        </div>
    </li>
      <li data-nav-id="/about/license/" class="dd-item">
        <div>
          <a href="/about/license/">
            License
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/">Velociraptor Documentation</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/getting-started/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/getting-started/">Getting Started</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/getting-started/stand_alone/" class="dd-item">
        <div>
          <a href="/docs/getting-started/stand_alone/">
            Standalone Deployment
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/getting-started/deploying_clients/" class="dd-item">
        <div>
          <a href="/docs/getting-started/deploying_clients/">
            Deploying Clients
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/getting-started/cloud/" class="dd-item">
        <div>
          <a href="/docs/getting-started/cloud/">
            Deploying in the cloud
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/getting-started/triaging/" class="dd-item">
        <div>
          <a href="/docs/getting-started/triaging/">
            Triaging
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/user-interface/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/">User Interface</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/user-interface/investigating_clients/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/investigating_clients/">Investigating Clients</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/user-interface/investigating_clients/searching_clients/" class="dd-item">
        <div>
          <a href="/docs/user-interface/investigating_clients/searching_clients/">
            Searching for clients
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/investigating_clients/virtual_filesystem/" class="dd-item">
        <div>
          <a href="/docs/user-interface/investigating_clients/virtual_filesystem/">
            Client VFS
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/user-interface/artifacts/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/artifacts/">Velociraptor Artifacts</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/user-interface/artifacts/client_artifacts/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/client_artifacts/">
            Client Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/client_events/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/client_events/">
            Client Event Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/server_artifacts/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/server_artifacts/">
            Server Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/server_events/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/server_events/">
            Server Event Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/add_artifacts/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/add_artifacts/">
            Customizing Artifacts
          </a>
        </div>
    </li>
        </ul>
    </li>
      <li data-nav-id="/docs/user-interface/api/" class="dd-item">
        <div>
          <a href="/docs/user-interface/api/">
            The Velociraptor API
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/vql_reference/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/vql_reference/">VQL Reference</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/vql_reference/basic/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/basic/">
            Basic VQL
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/windows/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/windows/">
            Windows
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/parsers/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/parsers/">
            Parsers
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/server/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/server/">
            Server
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/plugin/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/plugin/">
            Client
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/event/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/event/">
            Event Plugins
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/experimental/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/experimental/">
            Experimental
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/filesystem_accessors/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/filesystem_accessors/">
            Filesystem Accessors
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/templates/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/templates/">
            Report Templates
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/tips/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/tips/">
            Artifact Tips
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/artifacts/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/artifacts/">Artifact Reference</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/artifacts/linux/" class="dd-item">
        <div>
          <a href="/docs/artifacts/linux/">
            Linux Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/windows_system/" class="dd-item">
        <div>
          <a href="/docs/artifacts/windows_system/">
            Windows System
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/server/" class="dd-item">
        <div>
          <a href="/docs/artifacts/server/">
            Server Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/triage/" class="dd-item">
        <div>
          <a href="/docs/artifacts/triage/">
            Windows Triage
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/detection/" class="dd-item">
        <div>
          <a href="/docs/artifacts/detection/">
            Windows Detection
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/events/" class="dd-item">
        <div>
          <a href="/docs/artifacts/events/">
            Windows Monitoring
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/misc/" class="dd-item">
        <div>
          <a href="/docs/artifacts/misc/">
            Miscelaneous
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/linux/linux/" class="dd-item">
        <div>
          <a href="/docs/artifacts/linux/linux/">
            Linux Artifacts
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/presentations/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/presentations/">Presentations and Workshops</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/presentations/training_2020/" class="dd-item">
        <div>
          <a href="/docs/presentations/training_2020/">
            Training 2020
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/linux.conf.au.2020/" class="dd-item">
        <div>
          <a href="/docs/presentations/linux.conf.au.2020/">
            Linux.Conf.Au 2020
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/sans_dfir_summit2019/" class="dd-item">
        <div>
          <a href="/docs/presentations/sans_dfir_summit2019/">
            SANS 2019
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/rsa/" class="dd-item">
        <div>
          <a href="/docs/presentations/rsa/">
            RSA APJ 2019
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/crikeycon2019/" class="dd-item">
        <div>
          <a href="/docs/presentations/crikeycon2019/">
            Crikeycon 2019
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/nzitf2018/" class="dd-item">
        <div>
          <a href="/docs/presentations/nzitf2018/">
            NZITF 2018
          </a>
        </div>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li data-nav-id="/blog/" class="dd-item parent haschildren
        ">
      <div>
      <a href="/blog/">Velociraptor Blog</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/blog/medium/2019-12-31_digging-into-the-system-resource-usage-monitor-srum-afbadb1a375/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-12-31_digging-into-the-system-resource-usage-monitor-srum-afbadb1a375/">
            Digging into the System Resource Usage Monitor (SRUM)
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-12-08-velociraptor-to-elasticsearch-3a9fc02c6568/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-12-08-velociraptor-to-elasticsearch-3a9fc02c6568/">
            Velociraptor to Elasticsearch
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/">
            Recovering deleted NTFS Files with Velociraptor
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-11-12_windows-event-logs-d8d8e615c9ca/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-11-12_windows-event-logs-d8d8e615c9ca/">
            Windows Event Logs
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/">
            Triage with Velociraptor — Pt 3
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-10-04_triage-with-velociraptor-pt-2-d0f79066ca0e/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-10-04_triage-with-velociraptor-pt-2-d0f79066ca0e/">
            Triage with Velociraptor — Pt 2
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-10-02_triage-with-velociraptor-pt-1-253f57ce96c0/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-10-02_triage-with-velociraptor-pt-1-253f57ce96c0/">
            Triage with Velociraptor — Pt 1
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-09-11_velociraptor-s-client-side-buffer-3ce03697a4e6/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-09-11_velociraptor-s-client-side-buffer-3ce03697a4e6/">
            Velociraptor’s client side buffer
          </a>
        </div>
    </li>
        </ul>
    </li>




    <hr />
    <li></li>
    
    </ul>

 <section id="footer">
    </section>
  </div>
</nav>



<section id="body">
<div id="overlay"></div>
<div class="padding highlightable">

  <div id="top-bar">
    <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
        <span id="sidebar-toggle-span">
          <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
            <i class="fa fa-bars"></i>
          </a>
        </span>
        <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
        <span class="links">
        







 <a href='/'>Velociraptor / Dig deeper</a> > <a href='/blog/'>Velociraptor Blog</a> > Hunting - What Velociraptors do best!

 

 

   
        </span>
    </div>
    
    
    <div class="progress">
        <div class="wrapper">
    <nav id="TableOfContents">
<ul>
<li><a href="#how-are-hunts-scheduled">How are hunts scheduled?</a></li>
<li><a href="#the-hunt-s-life-cycle">The hunt\&rsquo;s life cycle</a></li>
<li><a href="#the-hunt-manager">The hunt manager</a></li>
</ul>
</nav>
        </div>
    </div>
    

  </div>


<div id="body-inner">
  
    <h1>Hunting - What Velociraptors do best!</h1>
  



    
    
    
    

<p>Velociraptor has completely redesigned the way that hunts are
implemented in order to avoid database locking and increase hunt
processing efficiency.</p>

<p>Now we hunt like this:</p>

<p><img src="image4.jpg" alt="image" />{.align-center}</p>

<h1 id="how-are-hunts-scheduled">How are hunts scheduled?</h1>

<p>GRR allows hunts to be scheduled by a few client properties such as OS
type, label, users etc. This works because GRR has an extensive data
model of endpoint properties. However, this requires that the data model
be refreshed periodically to be kept accurate. For example, to run a
hunt of all machines with a suspected compromised user account we can
schedule the run on all machines where the user has logged in, but
because GRR uses its data model to decide if a machine should be issued
the hunt, the data model may be out of date and GRR will not schedule
the hunt on machines which have only recently been logged into. For this
reason we typically run the Interrogate hunt very frequently causing a
lot of extra load on the system and clients hoping to minimize the time
window where the data model is out of date with reality.</p>

<p>Velociraptor\&rsquo;s approach is different - since Velociraptor does not
really maintain a data model server side, we check the client\&rsquo;s
information for every hunt, before we even decide if the hunt should be
scheduled for this client. This is done by issuing a VQL query to the
client.</p>

<p>Sometimes we don\&rsquo;t necessarily want the client to know exactly why we
are scheduling the hunt (e.g. in the compromised user account case we
don\&rsquo;t want to advertise the exact username we are looking for). In
these cases we run another VQL query on the server side.</p>

<p>So hunt selection is managed by two different VQL queries - a client
side one and a server side on.</p>

<p>The default client side VQL queries simply collects the usual facts like
OS version, Username etc, while the server side query filters the
results with more specific conditions. This approach does not reveal to
the client the hunt\&rsquo;s condition:</p>

<pre><code class="language-.sourceCode">Client side VQL:
    SELECT OS, Architecture, Fqdn, Platform,
      config.Client_labels AS Labels
      FROM info()

Server side VQL:
    SELECT * from rows
      WHERE Fqdn =~ '(?i)myhostname.+' AND 'MY_LABEL' IN Labels
</code></pre>

<h1 id="the-hunt-s-life-cycle">The hunt\&rsquo;s life cycle</h1>

<dl>
<dt>the CheckHuntCondition flow on the client.</dt>
<dt>::: {.note}
::: {.admonition-title}
Note
:::</dt>
</dl>

<dl>
<dt>the CheckHuntCondition flow on the client.</dt>
<dt>::: {.note}
::: {.admonition-title}
Note
:::</dt>
</dl>

<dl>
<dt>the CheckHuntCondition flow on the client.</dt>
<dt>::: {.note}
::: {.admonition-title}
Note
:::</dt>
</dl>

<dl>
<dt>the CheckHuntCondition flow on the client.</dt>
<dt>::: {.note}
::: {.admonition-title}
Note
:::</dt>
</dl>

<dl>
<dt>untCondition flow on the client.</dt>
<dt>::: {.note}
::: {.admonition-title}
Note
:::</dt>
</dl>

<p>The clients themselves are actively keeping track of the hunts they
participated in. This avoids the server having to check the client\&rsquo;s DB
record.
:::</p>

<p>The CheckHuntCondition flow issues the client side VQL queries and then
runs the server side query on the results. If the query matches (i.e.
the hunt should be scheduled for this client), the client\&rsquo;s record is
written into the hunt\&rsquo;s \&ldquo;pending\&rdquo; queue.</p>

<h1 id="the-hunt-manager">The hunt manager</h1>

<p>Each hunt specifies its own client recruitment rate (i.e. how many
clients will be started per minute). The hunt manager is a component
which periodically reads all hunts and schedules flows for these hunts
if the hunts\&rsquo; client rate allows for more clients to be scheduled. It
does this by moving clients from the pending queue to the running queue
and starting respective flows for them.</p>

<p>Once each of those flows completes, the record is moved from the running
queue to the completed queue or the results queue if the flow produced
any results. We can observe how many clients exist in each queue using
the GUI.</p>

<p><img src="image2.png" alt="image" /></p>

<p>The flows that hunts launch arn the client. However, when they complete,
a small record is made in the hunts\&rsquo;s results queue pointing to the
flow. It is therefore possible to retrieve all results from the hunt
from all client\&rsquo;s. For example, the GUI allows downloading a zip file
of all the results and files uploaded:</p>

<p><img src="image7.png" alt="image" /></p>

<p>Since hunts invoke regular flows, and Velociraptor flows are much
lighter than GRR\&rsquo;s flows, hunts are much cheaper to run in terms of
resources consumed.</p>


    
    
          <footer class=" footline" >
	
</footer>
  </div>
</div>

<div id="navigation">
<a class="nav nav-prev" href="/docs/presentations/nzitf2018/" title="New Zealand Internet Task Force Conference 2018"> <i class="fa fa-chevron-left"></i><label>New Zealand Internet Task Force Conference 2018</label></a>
    <a class="nav nav-next" href="/blog/medium/2019-12-31_digging-into-the-system-resource-usage-monitor-srum-afbadb1a375/" title="Digging into the System Resource Usage Monitor (SRUM)" style="margin-right: 0px;"><label>Digging into the System Resource Usage Monitor (SRUM)</label><i class="fa fa-chevron-right"></i></a></div>

</section>
<div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
  <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
</div>    

<script src="/js/clipboard.min.js"></script>
<script src="/js/featherlight.min.js"></script>
<script src="/js/html5shiv-printshiv.min.js"></script>

<script src="/js/modernizr.custom.71422.js"></script>
<script src="/js/docdock.js"></script>
<script src="/theme-original/script.js"></script>


    

    
    

    
  </body>
</html>