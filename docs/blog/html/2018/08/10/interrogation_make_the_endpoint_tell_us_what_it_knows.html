<!DOCTYPE html>
<html>
  <head>
    <title>Velociraptor / Dig deeper</title>
    
      <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Interrogation - Make the endpoint tell us what it knows! :: Velociraptor / Dig deeper</title>
<link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link rel="stylesheet" href="/css/bootstrap.min.css">
<link href="/css/nucleus.css" rel="stylesheet">
<link href="/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/hybrid.css" rel="stylesheet">
<link href="/css/featherlight.min.css" rel="stylesheet">
<link href="/css/auto-complete.css" rel="stylesheet">
<link href="/theme-original/style.css" rel="stylesheet">

  <link href="/theme-original/variant-mine.css" rel="stylesheet">


<script src="/js/jquery-2.x.min.js"></script>
<style type="text/css">
  :root #header + #content > #left > #rlblock_left {
    display:none !important;
  }
</style>
<link rel="stylesheet" href="/css/theme-mine.css">
<script src="/js/custom.js"></script>


    
  </head>
  <body data-url="/blog/html/2018/08/10/interrogation_make_the_endpoint_tell_us_what_it_knows.html">
    
      <div id="headermain"></div>
<nav id="sidebar" class="">



<div class="highlightable">
  <div id="header-wrapper">
    <div id="header">
      
	
  
    <p><a href="/">
  <img src="/images/logo.svg">
</a></p>

  


    </div>
        <div class="searchbox">
		    <label for="search-by"><i class="fa fa-search"></i></label>
		    <input data-search-input id="search-by" type="text" placeholder="Search...">
		    <span data-search-clear=""><i class="fa fa-close"></i></span>
		</div>
		<script type="text/javascript" src="/js/lunr.min.js"></script>
		<script type="text/javascript" src="/js/auto-complete.js"></script>
		<script type="text/javascript">
        
            var baseurl = "\/";
        
		</script>
		<script type="text/javascript" src="/js/search.js"></script>
  </div>

      <ul class="topics">
    <li data-nav-id="/about/" class="dd-item haschildren
        ">
      <div>
      <a href="/about/">About Velociraptor</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/about/features/" class="dd-item">
        <div>
          <a href="/about/features/">
            Velociraptor Features
          </a>
        </div>
    </li>
      <li data-nav-id="/about/license/" class="dd-item">
        <div>
          <a href="/about/license/">
            License
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/">Velociraptor Documentation</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/getting-started/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/getting-started/">Getting Started</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/getting-started/stand_alone/" class="dd-item">
        <div>
          <a href="/docs/getting-started/stand_alone/">
            Standalone Deployment
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/getting-started/deploying_clients/" class="dd-item">
        <div>
          <a href="/docs/getting-started/deploying_clients/">
            Deploying Clients
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/getting-started/cloud/" class="dd-item">
        <div>
          <a href="/docs/getting-started/cloud/">
            Deploying in the cloud
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/getting-started/triaging/" class="dd-item">
        <div>
          <a href="/docs/getting-started/triaging/">
            Triaging
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/user-interface/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/">User Interface</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/user-interface/investigating_clients/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/investigating_clients/">Investigating Clients</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/user-interface/investigating_clients/searching_clients/" class="dd-item">
        <div>
          <a href="/docs/user-interface/investigating_clients/searching_clients/">
            Searching for clients
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/investigating_clients/virtual_filesystem/" class="dd-item">
        <div>
          <a href="/docs/user-interface/investigating_clients/virtual_filesystem/">
            Client VFS
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/user-interface/artifacts/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/artifacts/">Velociraptor Artifacts</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/user-interface/artifacts/client_artifacts/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/client_artifacts/">
            Client Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/client_events/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/client_events/">
            Client Event Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/server_artifacts/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/server_artifacts/">
            Server Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/server_events/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/server_events/">
            Server Event Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/add_artifacts/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/add_artifacts/">
            Customizing Artifacts
          </a>
        </div>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/vql_reference/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/vql_reference/">VQL Reference</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/vql_reference/plugins/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/plugins/">
            VQL PLugins
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/event_plugins/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/event_plugins/">
            VQL Event PLugins
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/server/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/server/">
            VQL Server Plugins
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/functions/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/functions/">
            VQL Functions
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/templates/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/templates/">
            Report Templates
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/tips/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/tips/">
            Artifact Tips
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/filesystem_accessors/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/filesystem_accessors/">
            Filesystem Accessors
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/artifacts/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/artifacts/">Artifact Reference</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/artifacts/linux/" class="dd-item">
        <div>
          <a href="/docs/artifacts/linux/">
            Linux Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/windows_system/" class="dd-item">
        <div>
          <a href="/docs/artifacts/windows_system/">
            Windows System
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/server/" class="dd-item">
        <div>
          <a href="/docs/artifacts/server/">
            Server Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/triage/" class="dd-item">
        <div>
          <a href="/docs/artifacts/triage/">
            Windows Triage
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/detection/" class="dd-item">
        <div>
          <a href="/docs/artifacts/detection/">
            Windows Detection
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/events/" class="dd-item">
        <div>
          <a href="/docs/artifacts/events/">
            Windows Monitoring
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/misc/" class="dd-item">
        <div>
          <a href="/docs/artifacts/misc/">
            Miscelaneous
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/linux/linux/" class="dd-item">
        <div>
          <a href="/docs/artifacts/linux/linux/">
            Linux Artifacts
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/presentations/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/presentations/">Presentations and Workshops</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/presentations/sans_dfir_summit2019/" class="dd-item">
        <div>
          <a href="/docs/presentations/sans_dfir_summit2019/">
            SANS 2019
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/rsa/" class="dd-item">
        <div>
          <a href="/docs/presentations/rsa/">
            RSA APJ 2019
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/crikeycon2019/" class="dd-item">
        <div>
          <a href="/docs/presentations/crikeycon2019/">
            Crikeycon 2019
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/nzitf2018/" class="dd-item">
        <div>
          <a href="/docs/presentations/nzitf2018/">
            NZITF 2018
          </a>
        </div>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li data-nav-id="/blog/" class="dd-item parent haschildren
        ">
      <div>
      <a href="/blog/">Velociraptor Blog</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i>
      </div>
        <ul>
        </ul>
    </li>




    <hr />
    <li></li>
    
    </ul>

 <section id="footer">
    </section>
  </div>
</nav>



<section id="body">
<div id="overlay"></div>
<div class="padding highlightable">

  <div id="top-bar">
    <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
        <span id="sidebar-toggle-span">
          <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
            <i class="fa fa-bars"></i>
          </a>
        </span>
        <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
        <span class="links">
        







 <a href='/'>Velociraptor / Dig deeper</a> > <a href='/blog/'>Velociraptor Blog</a> > Interrogation - Make the endpoint tell us what it knows!

 

 

   
        </span>
    </div>
    
    
    <div class="progress">
        <div class="wrapper">
    
        </div>
    </div>
    

  </div>


<div id="body-inner">
  
    <h1>Interrogation - Make the endpoint tell us what it knows!</h1>
  



    
    
    
    <div class="document">


<p>When writing Velociraptor we decided to keep things very simple - we
did away with a lot of the information gathered during interrogate in
favor of a much simpler data model.</p>
<div class="section" id="data-modelling-the-interrogate-flow">
<h2>Data Modelling - The Interrogate Flow</h2>
<p>GRR maintains an elaborate model of client data. For example, GRR
collects and maintains a list of clients' network interfaces, users,
user's home directory etc. This information is maintained in elaborate
protobufs and stored in the database in many rows.</p>
<p>While some of this information is needed for client searching, GRR
maintains vastly more information than necessary in this data
model. The client data model is built during the interrogate phase (A
periodic flow run on the clients to refresh server side data).</p>
<p>Maintaining such a complex data model results in a very rigid
design. For example, if a user wanted to collect more information from
clients they would need to modify protobufs, update the interrogate
flow, recompile the code and redeploy. These modifications are also
very invasive as once code has been heavily modified, there is an
overhead of keeping these modifications in sync with newer upstream
versions.</p>
<p>Velociraptor also maintains client information via its Interrogate
flow. However, Velociraptor's interrogate flow simply issues a series
of VQL queries, and these responses are stored directly in the
database with minimal interpretation. Indexes are maintained for some
information which users should be able to search on, but there is no
attempt to build or maintain a client data model at all (You can see
details of the model described below in the FileBaseDataStore post).</p>
<p>The advantage of this approach is that users can simply add extra VQL
queries to the interrogate phase to collect more tailored site
specific information. This does not require compiling of any code or
redeploying the server. The following example illustrates the power of
this technique.</p>
</div>
<div class="section" id="customizing-the-interrogate-flow">
<h2>Customizing the Interrogate flow.</h2>
<p>Normally Velociraptor collects minimal information from the client
upon interrogation (i.e. when the client first enrols or when
interrogated periodically). However it is very easy to customize this
collection depending on local site requirements. In this section we
work through a step by step example of extending the Velociraptor
interrogate flow.</p>
<p>Suppose that in our deployment we wanted to check if a machine is able
to be logged into remotely. For a Linux machine we want to see all
authorized_keys files on every machine that enrolls. Collecting this
information allows us to quickly see which machines a compromised user
account could spread to.</p>
<p>We know we need to issue a VQL query but we are not 100% sure which
one. Luckily we can use Velociraptor itself to run the query locally
using the syntax &quot;velociraptor query &lt;query&gt;&quot;.</p>
<p>Start with a simple glob query to find all authorized_keys files:</p>
<pre class="code sql literal-block">
<span class="keyword">SELECT</span> <span class="name">FullPath</span> <span class="keyword">from</span> <span class="name">glob</span><span class="punctuation">(</span><span class="name">globs</span><span class="operator">=</span><span class="literal string symbol">&quot;/home/*/.ssh/authorized_keys&quot;</span><span class="punctuation">)</span>
</pre>
<p>Suppose we now want to actually grab a copy of all files so we can
archive them on the server This will keep a record of the authorized
keys on the server for each Interrogate flow. If we run the flow
periodically we will end up with a time based evolution of the
authorized keys files on each host. Pretty handy!</p>
<pre class="code sql literal-block">
<span class="keyword">SELECT</span> <span class="name">FullPath</span><span class="punctuation">,</span>
   <span class="keyword">timestamp</span><span class="punctuation">(</span><span class="name">epoch</span><span class="operator">=</span><span class="name">Sys</span><span class="punctuation">.</span><span class="name">Mtim</span><span class="punctuation">.</span><span class="name">Sec</span><span class="punctuation">)</span> <span class="keyword">as</span> <span class="name">Mtime</span><span class="punctuation">,</span>
   <span class="name">upload</span><span class="punctuation">(</span><span class="name">file</span><span class="operator">=</span><span class="name">FullPath</span><span class="punctuation">)</span> <span class="keyword">as</span> <span class="name">Upload</span>
<span class="keyword">FROM</span> <span class="name">glob</span><span class="punctuation">(</span><span class="name">globs</span><span class="operator">=</span><span class="literal string symbol">&quot;/home/*/.ssh/authorized_keys&quot;</span><span class="punctuation">)</span>
</pre>
<p>We can run the query locally using the Velociraptor tool:</p>
<pre class="code bash literal-block">
mic&#64;localhost:/tmp&gt; velociraptor query <span class="literal string double">&quot;select FullPath, \
   timestamp(epoch=Sys.Mtim.Sec) as Mtime, \
   upload(file=FullPath) as Upload \
   FROM glob(globs=['/home/*/.ssh/authorized_keys'])&quot;</span>

velociraptor: Uploaded home/mic/.ssh/authorized_keys <span class="operator">(</span><span class="literal number">395</span> bytes<span class="operator">)</span>
<span class="operator">[</span>
 <span class="operator">{</span>
  <span class="literal string double">&quot;FullPath&quot;</span>: <span class="literal string double">&quot;/home/mic/.ssh/authorized_keys&quot;</span>,
  <span class="literal string double">&quot;Mtime&quot;</span>: <span class="literal string double">&quot;2018-08-03T18:20:19+10:00&quot;</span>,
  <span class="literal string double">&quot;Upload&quot;</span>: <span class="operator">{</span>
    <span class="literal string double">&quot;Path&quot;</span>: <span class="literal string double">&quot;home/mic/.ssh/authorized_keys&quot;</span>,
    <span class="literal string double">&quot;Size&quot;</span>: <span class="literal number">395</span>
 <span class="operator">}</span>
<span class="operator">}</span>
<span class="operator">]</span>
</pre>
<p>Velociraptor's query command enables us to run the query directly on
the local host and observe the results. When the same query is issued
to the Velociraptor client, the same result will be generated and sent
to the server. This enables us to interactively develop and test our
queries without needing to run a full client/server.</p>
<p>Note the upload() VQL function which causes the file to be uploaded to
the server. (When run locally the file will be copied to the upload
directory as can be seen by the upload confirmation message), but when
run within the Velociraptor client, the file will be uploaded to the
server and stored within the flow.</p>
<p>We can now add the query to all Interrogate flows that will be run
from now on. We simply add it to the configuration file under the
Interrogate.additional_queries key:</p>
<pre class="code yaml literal-block">
<span class="name tag">Interrogate.additional_queries</span><span class="punctuation">:</span>
 <span class="name tag">Query</span><span class="punctuation">:</span>
   <span class="punctuation indicator">-</span> <span class="name tag">Name</span><span class="punctuation">:</span> <span class="literal scalar plain">Authorized Keys</span>
     <span class="name tag">VQL</span><span class="punctuation">:</span> <span class="punctuation indicator">&gt;</span>
       <span class="name constant">select FullPath, timestamp(epoch=Mtime.Sec) as Mtime,</span>
       <span class="name constant">upload(file=FullPath) as Upload</span>
       <span class="name constant">from glob(globs='/home/*/.ssh/authorized_keys')</span>
</pre>
<p>From now on the additional query will be recorded for all clients. The
GUI shows it in the client information page:</p>
<img alt="image6.png" src="image6.png" />
</div>
</div>

    
    
          <footer class=" footline" >
	
</footer>
  </div>
</div>

<div id="navigation">
<a class="nav nav-prev" href="/docs/presentations/nzitf2018/" title="New Zealand Internet Task Force Conference 2018"> <i class="fa fa-chevron-left"></i><label>New Zealand Internet Task Force Conference 2018</label></a>
    <a class="nav nav-next" href="/about/" title="About Velociraptor" style="margin-right: 0px;"><label>About Velociraptor</label><i class="fa fa-chevron-right"></i></a></div>

</section>
<div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
  <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
</div>    

<script src="/js/clipboard.min.js"></script>
<script src="/js/featherlight.min.js"></script>
<script src="/js/html5shiv-printshiv.min.js"></script>

<script src="/js/modernizr.custom.71422.js"></script>
<script src="/js/docdock.js"></script>
<script src="/theme-original/script.js"></script>


    

    
    

    
  </body>
</html>