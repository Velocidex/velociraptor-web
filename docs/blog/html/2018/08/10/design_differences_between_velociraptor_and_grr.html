<!DOCTYPE html>
<html>
  <head>
    <title>Velociraptor - Digging Deeper!</title>
    
      <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Design differences between Velociraptor and GRR :: Velociraptor - Digging Deeper!</title>
<link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link rel="stylesheet" href="/css/bootstrap.min.css">
<link href="/css/nucleus.css" rel="stylesheet">
<link href="/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/hybrid.css" rel="stylesheet">
<link href="/css/featherlight.min.css" rel="stylesheet">
<link href="/css/auto-complete.css" rel="stylesheet">
<link href="/theme-original/style.css" rel="stylesheet">

  <link href="/theme-original/variant-mine.css" rel="stylesheet">


<script src="/js/jquery-2.x.min.js"></script>
<style type="text/css">
  :root #header + #content > #left > #rlblock_left {
    display:none !important;
  }
</style>
<link rel="stylesheet" href="/css/theme-mine.css">
<script src="/js/custom.js"></script>


    
  </head>
  <body data-url="/blog/html/2018/08/10/design_differences_between_velociraptor_and_grr.html">
    
      <div id="headermain"></div>
<nav id="sidebar" class="">



<div class="highlightable">
  <div id="header-wrapper">
    <div id="header">
      
	
  
    <a href="/">
  <img src="/images/logo.svg">
</a>
  


    </div>
        <div class="searchbox">
		    <label for="search-by"><i class="fa fa-search"></i></label>
		    <input data-search-input id="search-by" type="text" placeholder="Search...">
		    <span data-search-clear=""><i class="fa fa-close"></i></span>
		</div>
		<script type="text/javascript" src="/js/lunr.min.js"></script>
		<script type="text/javascript" src="/js/auto-complete.js"></script>
		<script type="text/javascript">
        
            var baseurl = "\/";
        
		</script>
		<script type="text/javascript" src="/js/search.js"></script>
  </div>

      <ul class="topics">
    <li data-nav-id="/about/" class="dd-item haschildren
        ">
      <div>
      <a href="/about/">About Velociraptor</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/about/license/" class="dd-item">
        <div>
          <a href="/about/license/">
            License
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/">Velociraptor Documentation</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/getting-started/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/getting-started/">Getting Started</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/getting-started/stand_alone/" class="dd-item">
        <div>
          <a href="/docs/getting-started/stand_alone/">
            Standalone Deployment
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/getting-started/deploying_clients/" class="dd-item">
        <div>
          <a href="/docs/getting-started/deploying_clients/">
            Deploying Clients
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/getting-started/cloud/" class="dd-item">
        <div>
          <a href="/docs/getting-started/cloud/">
            Deploying in the cloud
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/getting-started/triaging/" class="dd-item">
        <div>
          <a href="/docs/getting-started/triaging/">
            Triaging
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/user-interface/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/">User Interface</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/user-interface/investigating_clients/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/investigating_clients/">Investigating Clients</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/user-interface/investigating_clients/searching_clients/" class="dd-item">
        <div>
          <a href="/docs/user-interface/investigating_clients/searching_clients/">
            Searching for clients
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/investigating_clients/virtual_filesystem/" class="dd-item">
        <div>
          <a href="/docs/user-interface/investigating_clients/virtual_filesystem/">
            Client VFS
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/user-interface/artifacts/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/artifacts/">Velociraptor Artifacts</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/user-interface/artifacts/client_artifacts/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/client_artifacts/">
            Client Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/client_events/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/client_events/">
            Client Event Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/server_artifacts/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/server_artifacts/">
            Server Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/server_events/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/server_events/">
            Server Event Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/add_artifacts/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/add_artifacts/">
            Customizing Artifacts
          </a>
        </div>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/vql_reference/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/vql_reference/">VQL Reference</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/vql_reference/plugins/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/plugins/">
            VQL PLugins
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/event_plugins/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/event_plugins/">
            VQL Event PLugins
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/server/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/server/">
            VQL Server Plugins
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/functions/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/functions/">
            VQL Functions
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/templates/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/templates/">
            Report Templates
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/tips/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/tips/">
            Artifact Tips
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/filesystem_accessors/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/filesystem_accessors/">
            Filesystem Accessors
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/artifacts/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/artifacts/">Artifact Reference</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/artifacts/linux/" class="dd-item">
        <div>
          <a href="/docs/artifacts/linux/">
            Linux Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/windows_system/" class="dd-item">
        <div>
          <a href="/docs/artifacts/windows_system/">
            Windows System
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/server/" class="dd-item">
        <div>
          <a href="/docs/artifacts/server/">
            Server Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/triage/" class="dd-item">
        <div>
          <a href="/docs/artifacts/triage/">
            Windows Triage
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/detection/" class="dd-item">
        <div>
          <a href="/docs/artifacts/detection/">
            Windows Detection
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/events/" class="dd-item">
        <div>
          <a href="/docs/artifacts/events/">
            Windows Monitoring
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/misc/" class="dd-item">
        <div>
          <a href="/docs/artifacts/misc/">
            Miscelaneous
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/linux/linux/" class="dd-item">
        <div>
          <a href="/docs/artifacts/linux/linux/">
            Linux Artifacts
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/presentations/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/presentations/">Presentations and Workshops</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/presentations/rsa/" class="dd-item">
        <div>
          <a href="/docs/presentations/rsa/">
            RSA APJ 2019
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/crikeycon2019/" class="dd-item">
        <div>
          <a href="/docs/presentations/crikeycon2019/">
            Crikeycon 2019
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/nzitf2018/" class="dd-item">
        <div>
          <a href="/docs/presentations/nzitf2018/">
            NZITF 2018
          </a>
        </div>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li data-nav-id="/blog/" class="dd-item parent haschildren
        ">
      <div>
      <a href="/blog/">Velociraptor Blog</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i>
      </div>
        <ul>
        </ul>
    </li>




    <hr />
    <li></li>
    
    </ul>

 <section id="footer">
    </section>
  </div>
</nav>



<section id="body">
<div id="overlay"></div>
<div class="padding highlightable">

  <div id="top-bar">
    <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
        <span id="sidebar-toggle-span">
          <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
            <i class="fa fa-bars"></i>
          </a>
        </span>
        <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
        <span class="links">
        







 <a href='/'>Velociraptor - Digging Deeper!</a> > <a href='/blog/'>Velociraptor Blog</a> > Design differences between Velociraptor and GRR

 

 

   
        </span>
    </div>
    
    
    <div class="progress">
        <div class="wrapper">
    
        </div>
    </div>
    

  </div>


<div id="body-inner">
  
    <h1>Design differences between Velociraptor and GRR</h1>
  



    
    
    
    <div class="document">


<div class="section" id="velociraptor-clients-run-full-vql-queries">
<h2>Velociraptor Clients run full VQL queries</h2>
<p>GRR's design started off with the assumption that the client should be
minimalist and only support a few simple primitives (such as
ListDirectory, ListProcesses etc). The intention was that most of the
processing would be executed on the server inside a &quot;Flow&quot;. The main
motivation for this design choice was the observation that it is
difficult to upgrade the client in practice, and so with a minimal
client, it would be possible to develop more sophisticated Flows,
server side, without needing to update the clients.</p>
<p>After running GRR for a while we noticed that this design choice was
problematic, since it leads to many client round trips. For example
the FileFinder flow searches the client's filesystem for files by
name, date etc. GRR's original file finder uses a complex algorithm to
issue ListDirectory requests to the client, receive their responses,
filter and recurse into directories by communicating with the client
again. This leads to many round trips and has a huge performance hit
on both the server and client.</p>
<p>Velociraptor does away with all that by including rich client side
functionality (through VQL plugins), and implementing VQL queries to
perform the filtering. This means that in reality, Velociraptor has
very few client round trips, generally just one: The VQL query is sent
to the client, and the result is received by the server.</p>
<p>Some types of analysis require the results of one operation to feed
into the next operation. For example, suppose we wanted to upload all
executables that are run from a temp directory. This requires listing
all processes, then filtering the ones running from a temp directory,
and finally uploading those to the server.</p>
<p>GRR's model requires writing a new flow for this - the flow first
issues a ListProcesses request to the client, then receives all
processes where the filtering happens on the server. The server then
issues upload commands for each matching process. Performing this
analysis requires writing and deploying new code making it difficult
to adapt rapidly to changing threats.</p>
<p>With Velociraptor one simply issues the following VQL query:</p>
<pre class="code sql literal-block">
<span class="name">LET</span> <span class="name">files</span> <span class="operator">=</span> <span class="keyword">SELECT</span> <span class="name">Exe</span><span class="punctuation">,</span> <span class="name">Cmdline</span><span class="punctuation">,</span> <span class="name">Username</span> <span class="keyword">FROM</span> <span class="name">pslist</span><span class="punctuation">()</span>
        <span class="keyword">WHERE</span> <span class="name">Exe</span> <span class="operator">=~</span> <span class="literal string single">'(?i)temp'</span>
<span class="keyword">SELECT</span> <span class="name">Exe</span><span class="punctuation">,</span> <span class="name">Cmdline</span><span class="punctuation">,</span> <span class="name">Username</span><span class="punctuation">,</span> <span class="name">upload</span><span class="punctuation">(</span><span class="name">file</span><span class="operator">=</span><span class="name">Exe</span><span class="punctuation">)</span> <span class="keyword">AS</span> <span class="name">Upload</span>
  <span class="keyword">FROM</span> <span class="name">files</span>
</pre>
<p>VQL avoids this round trip completely, since VQL queries can be nested
and chained together. Therefore one simply runs the first query (list
all processes running from temp directory), and sends the results to
the next query (download the matching files) inside the same VQL
client request. It is rare that Velociraptor flows run multiple client
round trips, resulting in lightweight and fast completing flows.</p>
</div>
<div class="section" id="worker-and-database-queues">
<h2>Worker and Database queues.</h2>
<p>The GRR model of long running flows with multiple client/server
interactions required more complex design. Since client messages can
be delivered in multiple POST requests, and a single request can
result in multiple responses, GRR must queue responses somewhere until
they are all ready to be processed. Otherwise writing GRR flows would
be difficult because one would need to account for incomplete
responses.</p>
<p>GRR uses a complex request/response protocol to ensure messages are
delivered in order, reminiscent of the TCP stack's packet reassembling
algorithms.</p>
<p>Consider the simple request &quot;ListDirectory&quot;. The client request may
elicit thousands of responses (one for each file) and may span
multiple POST operations. The GRR frontend queues all the responses in
the database until it receives a STATUS response, and then fet
once. So even if the client sends the responses over multiple packets,
the flow only sees a single list. When a status message is seen by the
frontend, it notifies the worker via a worker queue, which collects
all responses, orders them by response ID and delivers to the flow
object.</p>
<p>This design is necessary if flows are long lived and need to handle
thousands of responses for each request. However in practice this
design has a couple of serious problems:</p>
<ol class="arabic simple">
<li>The frontend receives responses and just writes them into the
database in special queue rows, then the worker reads them from the
queue rows for processing (after which they must be deleted from
the database). This leads to a lot of unnecessary read/write/delete
cycles and extra load on the database.</li>
<li>The worker queue rows are used by all clients and all flows. This
leads to a lot of database contention on these rows. Extra care
must be taken to ensure no race conditions, through careful
management of database locks. Extra locks slow down the database
and typically for a busy system queue contention is a huge
bottleneck.</li>
</ol>
<p>This is easy to observe in practice on a busy GRR system (i.e. one
that is running many flows or hunts) by simply looking at the output
from top. Typically the mysql process uses as much CPU or more than
the frontends and workers combined. This indicates a huge load on the
database and limits scalability. Increasing the number of frontends
only helps marginally because the database throughput becomes the
limiting factor. In fact, increasing the number of workers can
deteriorate performance because workers poll on their queues while
holding locks thereby increasing row lock contention even more.</p>
<p>Velociraptor takes a different approach. Since Velociraptor flows are
very simple and typically only consist of a few request/response
cycles, the server does not bother to reorder replies that come in
different packets. Therefore there is no need to temporarily store or
queue responses. Responses can be delivered to the flow as soon as
they are received - and flows typically just write them to the
database in their final storage location.</p>
<p>Therefore Velociraptor does not have a dedicated worker, nor does it
have database queues. The frontend itself runs the flows directly on
the received packets while serving the client's poll request. This
completely eliminates the need for worker queues and their associated
database contention issues. Removing the worker queues eliminates a
significant amount of very complex and delicate code. Additionally,
since the responses are not written/read to the queue, the total load
on the database is significantly reduced. (In fact because database
lock contention is so low, Velociraptor can work very well with plain
files through the FileBaseDataStore, even at large scale!)</p>
<p>The following illustration demonstrates how significant this is for
the simple example of a ListDirectory request of a directory with 1000
files in it (e.g. the c:windows directory). The equivalent VQL is
<cite>select * from glob(paths='c:/windows/*')</cite> and only produces a single
response packet containing all the files in the one table, whereas
GRR's ListDirectory client action produces a single response for each
file, which is then queued and stored independently in the database.</p>
<p>The overall effect, in the GRR case, is that 2000 database rows are
created, of which 1000 rows are immediately deleted - a significant
database load. Compare this with the Velociraptor equivalent flow -
the VQL request is sent to the client once, then the response is
returned to the frontend in a single POST operation. Since
Velociraptor does not have a separate worker and does not need to
queue messages to it, the frontend immediately runs the flow which
just writes the result into a single DB row - total database
operations: 1 row written.</p>
<img alt="image1.png" src="image1.png" />
<p>Eliminating the need for a separate worker process also simplifies
deployment significantly. GRR needs to deploy separate frontends and
worker processes, and it is often difficult to know which one to scale
up. Scaling up the frontend will allow more packets to be received but
actually increases the load on the database. Not having sufficient
workers will leave many requests on the queue for a long time and will
prolong the execution of the flow since a worker must run the flow in
order to issue the next set of requests. This leads to flows which
take many hours to complete and even hung flows (if the client reboots
or disconnects before the flow finished).</p>
<p>Velociraptor deployment is much simpler - there is only a single
binary and it can be scaled and load balanced as needed. Since
database load is much lower, the frontend can handle a much larger
load. Furthermore, the flows typically execute in very short time
(since there is only one round trip). The overall result is that flow
throughput is much increased and resource usage is reduced.</p>
</div>
</div>

    
    
          <footer class=" footline" >
	
</footer>
  </div>
</div>

<div id="navigation">
<a class="nav nav-prev" href="/docs/presentations/nzitf2018/" title="New Zealand Internet Task Force Conference 2018"> <i class="fa fa-chevron-left"></i><label>New Zealand Internet Task Force Conference 2018</label></a>
    <a class="nav nav-next" href="/about/" title="About Velociraptor" style="margin-right: 0px;"><label>About Velociraptor</label><i class="fa fa-chevron-right"></i></a></div>

</section>
<div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
  <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
</div>    

<script src="/js/clipboard.min.js"></script>
<script src="/js/featherlight.min.js"></script>
<script src="/js/html5shiv-printshiv.min.js"></script>

<script src="/js/modernizr.custom.71422.js"></script>
<script src="/js/docdock.js"></script>
<script src="/theme-original/script.js"></script>


    

    
    

    
  </body>
</html>