<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.56.0-DEV" />
    <meta name="description" content="The latest release of Velociraptor introduces the ability to access
raw NTFS volumes, allowing users to read files which are normally
locked by the operating system such as registry hives, pagefile and
other locked files.
">


    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>Velorciraptor&#39;s filesystem&#39;s accessors :: Velociraptor - Hunt Evil!</title>

    
    <link href="/css/nucleus.css" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css" rel="stylesheet">
    <link href="/css/hybrid.css" rel="stylesheet">
    <link href="/css/featherlight.min.css" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css" rel="stylesheet">
    <link href="/css/auto-complete.css" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css" rel="stylesheet">
    <link href="/css/theme.css" rel="stylesheet">
    <link href="/css/hugo-theme.css" rel="stylesheet">
    
      <link href="/css/theme-mine.css" rel="stylesheet">
    

    <script src="/js/jquery-3.3.1.min.js"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/blog/html/2018/09/30/velorciraptor_s_filesystem_s_accessors.html">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a href="/">
  <img src="/images/logo.svg" />
</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js"></script>
<script type="text/javascript" src="/js/auto-complete.js"></script>
<script type="text/javascript">
    
        var baseurl = "\/";
    
</script>
<script type="text/javascript" src="/js/search.js"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/about/" title="About Velociraptor" class="dd-item 
        
        
        
        ">
      <a href="/about/">
          Overview
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/about/features/" title="Velociraptor Features" class="dd-item ">
        <a href="/about/features/">
        Velociraptor Features
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/about/license/" title="GNU Affero General Public License" class="dd-item ">
        <a href="/about/license/">
        License
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/docs/" title="Velociraptor Documentation" class="dd-item 
        
        
        
        ">
      <a href="/docs/">
          Velociraptor Documentation
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/docs/getting-started/" title="Getting Started" class="dd-item 
        
        
        
        ">
      <a href="/docs/getting-started/">
          Getting Started
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/docs/getting-started/stand_alone/" title="Standalone Deployment" class="dd-item ">
        <a href="/docs/getting-started/stand_alone/">
        Standalone Deployment
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/getting-started/deploying_clients/" title="Deploying Clients" class="dd-item ">
        <a href="/docs/getting-started/deploying_clients/">
        Deploying Clients
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/getting-started/cloud/" title="Deploying in the cloud" class="dd-item ">
        <a href="/docs/getting-started/cloud/">
        Deploying in the cloud
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/getting-started/triaging/" title="Triaging" class="dd-item ">
        <a href="/docs/getting-started/triaging/">
        Triaging
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/docs/user-interface/" title="User Interface" class="dd-item 
        
        
        
        ">
      <a href="/docs/user-interface/">
          User Interface
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/docs/user-interface/flows/" title="Velociraptor Artifacts" class="dd-item ">
        <a href="/docs/user-interface/flows/">
        Velociraptor Artifacts
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/user-interface/gui/" title="Searching for clients" class="dd-item ">
        <a href="/docs/user-interface/gui/">
        Searching for clients
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/docs/use_cases/" title="Use Cases" class="dd-item 
        
        
        
        ">
      <a href="/docs/use_cases/">
          Use Cases
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/docs/presentations/" title="Presentations and Workshops" class="dd-item 
        
        
        
        ">
      <a href="/docs/presentations/">
          Presentations and Workshops
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/docs/presentations/crikeycon2019/" title="Crikeycon 2019 Training Workshop" class="dd-item ">
        <a href="/docs/presentations/crikeycon2019/">
        CrikeyCon 2019
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/presentations/nzitf2018/" title="New Zealand Internet Task Force Conference 2018" class="dd-item ">
        <a href="/docs/presentations/nzitf2018/">
        NZITF2018
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/docs/vql_reference/" title="VQL Reference" class="dd-item 
        
        
        
        ">
      <a href="/docs/vql_reference/">
          VQL Reference
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/docs/vql_reference/templates/" title="Report Templates" class="dd-item ">
        <a href="/docs/vql_reference/templates/">
        Report Templates
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/vql_reference/event_plugins/" title="VQL Event PLugins" class="dd-item ">
        <a href="/docs/vql_reference/event_plugins/">
        VQL Event PLugins
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/vql_reference/functions/" title="VQL Functions" class="dd-item ">
        <a href="/docs/vql_reference/functions/">
        VQL Functions
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/vql_reference/plugins/" title="VQL PLugins" class="dd-item ">
        <a href="/docs/vql_reference/plugins/">
        VQL PLugins
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/vql_reference/server/" title="VQL Server Plugins" class="dd-item ">
        <a href="/docs/vql_reference/server/">
        VQL Server Plugins
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/tutorial/" title="Tutorial" class="dd-item ">
        <a href="/docs/tutorial/">
        Tutorial
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/docs/artifacts/" title="Artifact Reference" class="dd-item 
        
        
        
        ">
      <a href="/docs/artifacts/">
          Artifact Reference
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/docs/artifacts/linux/linux/" title="Linux Artifacts" class="dd-item ">
        <a href="/docs/artifacts/linux/linux/">
        Linux Artifacts
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/artifacts/misc/" title="Miscelaneous Artifacts" class="dd-item ">
        <a href="/docs/artifacts/misc/">
        Miscelaneous
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/artifacts/server/" title="Server Artifacts" class="dd-item ">
        <a href="/docs/artifacts/server/">
        Server Artifacts
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/artifacts/detection/" title="Windows Malware Detection" class="dd-item ">
        <a href="/docs/artifacts/detection/">
        Windows Detection
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/artifacts/events/" title="Windows Event Monitoring" class="dd-item ">
        <a href="/docs/artifacts/events/">
        Windows Monitoring
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/artifacts/windows_system/" title="Windows System" class="dd-item ">
        <a href="/docs/artifacts/windows_system/">
        Windows System
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/docs/artifacts/triage/" title="Windows Triage Artifacts" class="dd-item ">
        <a href="/docs/artifacts/triage/">
        Windows Triage
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/blog/" title="Velociraptor Blog" class="dd-item 
        parent
        
        
        ">
      <a href="/blog/">
          Velociraptor Blog
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2019/03/02/agentless_hunting_with_velociraptor.html" title="Agentless hunting with Velociraptor" class="dd-item ">
        <a href="/blog/html/2019/03/02/agentless_hunting_with_velociraptor.html">
        Agentless hunting with Velociraptor
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2019/02/14/alerting_on_event_patterns.html" title="Alerting on event patterns" class="dd-item ">
        <a href="/blog/html/2019/02/14/alerting_on_event_patterns.html">
        Alerting on event patterns
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2019/02/10/velociraptor_performance.html" title="Velociraptor Performance" class="dd-item ">
        <a href="/blog/html/2019/02/10/velociraptor_performance.html">
        Velociraptor Performance
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2019/02/09/velociraptor_python_api.html" title="The Velociraptor Python API" class="dd-item ">
        <a href="/blog/html/2019/02/09/velociraptor_python_api.html">
        The Velociraptor Python API
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/09/03/velociraptor_s_client_communications.html" title="Velociraptor&#39;s client communications" class="dd-item ">
        <a href="/blog/html/2018/09/03/velociraptor_s_client_communications.html">
        Velociraptor&#39;s client communications
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/12/23/deploying_velociraptor_with_oauth_sso.html" title="Deploying Velociraptor with OAuth SSO" class="dd-item ">
        <a href="/blog/html/2018/12/23/deploying_velociraptor_with_oauth_sso.html">
        Deploying Velociraptor with OAuth SSO
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/12/22/configuring_velociraptor_for_ssl.html" title="Configuring Velociraptor for SSL" class="dd-item ">
        <a href="/blog/html/2018/12/22/configuring_velociraptor_for_ssl.html">
        Configuring Velociraptor for SSL
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/12/11/velociraptor_interactive_shell.html" title="Velociraptor Interactive Shell" class="dd-item ">
        <a href="/blog/html/2018/12/11/velociraptor_interactive_shell.html">
        Velociraptor Interactive Shell
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/12/10/server_side_vql_queries_and_events.html" title="Server side VQL queries and Escalation Events" class="dd-item ">
        <a href="/blog/html/2018/12/10/server_side_vql_queries_and_events.html">
        Server side VQL queries and Escalation Events
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/12/09/more_on_client_event_collection.html" title="More on client event collection" class="dd-item ">
        <a href="/blog/html/2018/12/09/more_on_client_event_collection.html">
        More on client event collection
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/11/13/velociraptor_training_at_nzitf.html" title="Velociraptor training at NZITF" class="dd-item ">
        <a href="/blog/html/2018/11/13/velociraptor_training_at_nzitf.html">
        Velociraptor training at NZITF
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/11/09/event_queries_and_endpoint_monitoring.html" title="Event Queries and Endpoint Monitoring" class="dd-item ">
        <a href="/blog/html/2018/11/09/event_queries_and_endpoint_monitoring.html">
        Event Queries and Endpoint Monitoring
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/09/30/velorciraptor_s_filesystem_s_accessors.html" title="Velorciraptor&#39;s filesystem&#39;s accessors" class="dd-item active">
        <a href="/blog/html/2018/09/30/velorciraptor_s_filesystem_s_accessors.html">
        Velorciraptor&#39;s filesystem&#39;s accessors
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/09/29/detecting_powershell_persistence_with_velociraptor_and_yara.html" title="Detecting powershell persistence with Velociraptor and Yara" class="dd-item ">
        <a href="/blog/html/2018/09/29/detecting_powershell_persistence_with_velociraptor_and_yara.html">
        Detecting powershell persistence with Velociraptor and Yara
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/09/03/velociraptor_walk_through_and_demo.html" title="Velociraptor walk through and demo" class="dd-item ">
        <a href="/blog/html/2018/09/03/velociraptor_walk_through_and_demo.html">
        Velociraptor walk through and demo
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/08/20/velociraptor_artifacts.html" title="Velociraptor Artifacts" class="dd-item ">
        <a href="/blog/html/2018/08/20/velociraptor_artifacts.html">
        Velociraptor Artifacts
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/08/10/browsing_around_the_filesystem.html" title="Browsing around the filesystem." class="dd-item ">
        <a href="/blog/html/2018/08/10/browsing_around_the_filesystem.html">
        Browsing around the filesystem.
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/08/10/design_differences_between_velociraptor_and_grr.html" title="Design differences between Velociraptor and GRR" class="dd-item ">
        <a href="/blog/html/2018/08/10/design_differences_between_velociraptor_and_grr.html">
        Design differences between Velociraptor and GRR
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/02/09/files_files_everything_is_just_a_file.html" title="Files, files everything is just a file!" class="dd-item ">
        <a href="/blog/html/2018/02/09/files_files_everything_is_just_a_file.html">
        Files, files everything is just a file!
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/08/10/hunting_what_velociraptors_do_best.html" title="Hunting - What Velociraptors do best!" class="dd-item ">
        <a href="/blog/html/2018/08/10/hunting_what_velociraptors_do_best.html">
        Hunting - What Velociraptors do best!
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/08/10/interrogation_make_the_endpoint_tell_us_what_it_knows.html" title="Interrogation - Make the endpoint tell us what it knows!" class="dd-item ">
        <a href="/blog/html/2018/08/10/interrogation_make_the_endpoint_tell_us_what_it_knows.html">
        Interrogation - Make the endpoint tell us what it knows!
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/08/10/the_velocidex_query_language.html" title="Velocidex Query Language (VQL)" class="dd-item ">
        <a href="/blog/html/2018/08/10/the_velocidex_query_language.html">
        Velocidex Query Language (VQL)
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/blog/html/2018/08/10/introducing_velociraptor.html" title="Introducing Velociraptor" class="dd-item ">
        <a href="/blog/html/2018/08/10/introducing_velociraptor.html">
        Introducing Velociraptor
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
         
    </ul>

    
    

    
    <section id="footer">
      
    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/'>Velociraptor - Hunt Evil!</a> > <a href='/blog/'>Velociraptor Blog</a> > Velorciraptor's filesystem's accessors
          
         
          
         
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">

    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Velorciraptor&#39;s filesystem&#39;s accessors
            </h1>
          

        



<div class="document">


<p>In addition, Velociraptor can now also read <a class="reference external" href="https://docs.microsoft.com/en-us/windows/desktop/vss/volume-shadow-copy-service-portal">Volume Shadow Copy</a>
snapshots. The gives a kind of time-machine ability to allow the
investigator to look through the drive content at a previous point in
the past.</p>
<p>This blog post introduces the new features and describe how
Velociraptor's filesystem accessors work to provide data from multiple
sources to VQL queries.</p>
<p>We have previously seen that Velociraptor can list and download files
from the client's filesystem, as well as registry keys and values. The
client's filesystem is made available to VQL plugins such as glob()
allowing many Artifacts to be written that work on files, registry
keys and raw NTFS volumes.</p>
<p>While Velociraptor is a great remote response tool, everything that it
can do remotely, it can also do locally using a command line
interface. This gives the user an opportunity to interactively test
their VQL queries while writing artifacts.</p>
<p>The latest release adds a couple of convenient command line options
which allow the user to interact with the filesystem accessors. For
example, to list the files in a directory we can use the &quot;velociraptor
fs ls&quot; command:</p>
<pre class="code console literal-block">
<span class="generic output">F:\&gt;velociraptor.exe fs ls
+------+------+------------+---------------------------+---------------------------------+
| Name | Size |    Mode    |           mtime           |              Data               |
+------+------+------------+---------------------------+---------------------------------+
| C:   |    0 | d--------- | 1969-12-31T16:00:00-08:00 | Description: Local Fixed Disk   |
|      |      |            |                           | DeviceID: C:                    |
|      |      |            |                           | FreeSpace: 12686422016          |
|      |      |            |                           | Size: 33833349120               |
|      |      |            |                           | SystemName: DESKTOP-IOME2K5     |
|      |      |            |                           | VolumeName:                     |
|      |      |            |                           | VolumeSerialNumber: 9459F443    |
| D:   |    0 | d--------- | 1969-12-31T16:00:00-08:00 | Description: CD-ROM Disc        |
|      |      |            |                           | DeviceID: D:                    |
|      |      |            |                           | FreeSpace: 0                    |
|      |      |            |                           | Size: 57970688                  |
|      |      |            |                           | SystemName: DESKTOP-IOME2K5     |
|      |      |            |                           | VolumeName: VBox_GAs_5.2.11     |
|      |      |            |                           | VolumeSerialNumber: A993F576    |
+------+------+------------+---------------------------+---------------------------------+
SELECT Name, Size, Mode.String AS Mode, timestamp(epoch=Mtime.Sec) AS mtime,
   Data FROM glob(globs=path, accessor=accessor)</span>
</pre>
<p>The &quot;fs ls&quot; command instructs Velociraptor to list directories using
its internal filesystem accessors. By default it will use the &quot;file&quot;
accessor - which simply uses the usual Win32 api filesystem calls
(i.e. CreateFile, FindFirstFile etc).</p>
<p>On windows, the file accessor lists the drive letters at the root of
the filesystem, then allows subdirectories to be listed under each
letter. The above output shows some metadata for each drive letter
(like its size etc) and below the table we can see the VQL query that
was used to generate the table. To be clear, the &quot;fs ls&quot; command is
simply a shortcut for producing a VQL query that ultimately uses the
filesystem accessor in the glob() VQL plugin. Therefore, we can enter
any glob expression to find files:</p>
<pre class="code console literal-block">
<span class="generic output">F:\&gt;velociraptor.exe fs ls -v &quot;c:\program files\**\*.exe&quot;
+--------------------------------+----------+------------+---------------------------+------+
|            FullPath            |   Size   |    Mode    |           mtime           | Data |
+--------------------------------+----------+------------+---------------------------+------+
| C:\Program Files\Windows Defen |  4737448 | -rw-rw-rw- | 2018-07-14T17:56:49-07:00 |      |
| der Advanced Threat Protection |          |            |                           |      |
| \MsSense.exe                   |          |            |                           |      |
| C:\Program Files\Windows Defen |   791384 | -rw-rw-rw- | 2018-07-14T17:56:43-07:00 |      |
| der Advanced Threat Protection |          |            |                           |      |
| \SenseCncProxy.exe             |          |            |                           |      |
| C:\Program Files\Windows Defen |  3832016 | -rw-rw-rw- | 2018-07-14T17:56:50-07:00 |      |
| der Advanced Threat Protection |          |            |                           |      |
| \SenseIR.exe                   |          |            |                           |      |
| C:\Program Files\Windows Defen |  2147192 | -rw-rw-rw- | 2018-07-14T18:05:00-07:00 |      |
| der Advanced Threat Protection |          |            |                           |      |
| \SenseSampleUploader.exe       |          |            |                           |      |
........
+--------------------------------+----------+------------+---------------------------+------+
SELECT FullPath, Size, Mode.String AS Mode, timestamp(epoch=Mtime.Sec) AS mtime, Data FROM
glob(globs=path, accessor=accessor)</span>
</pre>
<p>When using the registry filesystem accessor, the registry appears like
a filesystem, allowing us to run glob expressions against registry
keys and values (Note that the registry accessor provides the value in
the metadata):</p>
<pre class="code console literal-block">
<span class="generic output">F:\&gt;velociraptor.exe fs --accessor reg ls &quot;HKEY_USERS\*\Software\Microsoft\Windows\CurrentVersion\{Run,RunOnce}\*&quot;
+---------------+------+------------+---------------------------+---------------------------------+
|     Name      | Size |    Mode    |           mtime           |             Data                |
+---------------+------+------------+---------------------------+---------------------------------+
| OneDriveSetup |  104 | -rwxr-xr-x | 2018-09-03T02:48:53-07:00 | type: SZ                        |
|               |      |            |                           | value: C:\Windows\SysWOW64\     |
|               |      |            |                           | OneDriveSetup.exe /thfirstsetup |
| OneDriveSetup |  104 | -rwxr-xr-x | 2018-09-03T02:48:47-07:00 | type: SZ                        |
|               |      |            |                           | value:   C:\Windows\SysWOW64\   |
|               |      |            |                           | OneDriveSetup.exe /thfirstsetup |
+---------------+------+------------+---------------------------+---------------------------------+
SELECT Name, Size, Mode.String AS Mode, timestamp(epoch=Mtime.Sec) AS mtime,
Data FROM glob(globs=path, accessor=accessor)</span>
</pre>
<p>Finally, the NTFS accessor can access files by parsing the NTFS
filesystem directly. At the top level, the accessor shows all NTFS
formatted partitions. These include regular drives as well as Volume
Shadow Copies:</p>
<pre class="code console literal-block">
<span class="generic output">F:\&gt;velociraptor.exe fs --accessor ntfs ls
+--------------------------------+------+------------+---------------------------------------------------------+
|              Name              | Size |    Mode    |                             Data                        |
+--------------------------------+------+------------+---------------------------------------------------------+
| \\.\C:                         |    0 | d--------- | Description: Local Fixed Disk                           |
|                                |      |            | DeviceID: C:                                            |
|                                |      |            | FreeSpace: 11802157056                                  |
|                                |      |            | Size: 33833349120                                       |
|                                |      |            | SystemName: DESKTOP-IOME2K5                             |
|                                |      |            | VolumeName:                                             |
|                                |      |            | VolumeSerialNumber: 9459F443                            |
| \\?\GLOBALROOT\Device\Harddisk |    0 | d--------- | DeviceObject: \\?\GLOBALROOT\Device\                    |
|                                |      |            |             HarddiskVolumeShadowCopy1                   |
| VolumeShadowCopy1              |      |            | ID: {CAF25144-8B70-4F9E-B4A9-5CC702281FA1}              |
|                                |      |            | InstallDate: 20180926154712.490617-420                  |
|                                |      |            | OriginatingMachine: DESKTOP-IOME2K5                     |
|                                |      |            | VolumeName: \\?\Volume{3dc4b590-0000-000-501f00000000}\ |
| \\?\GLOBALROOT\Device\Harddisk |    0 | d--------- | DeviceObject: \\?\GLOBALROOT\Device\                    |
|                                |      |            |            HarddiskVolumeShadowCopy2                    |
| VolumeShadowCopy2              |      |            | ID: {E48BFDD7-7D1D-40AE-918C-36FCBB009941}              |
|                                |      |            | InstallDate: 20180927174025.893104-420                  |
|                                |      |            | OriginatingMachine: DESKTOP-IOME2K5                     |
|                                |      |            | VolumeName: \\?\Volume{3dc4b590-0000-000-501f00000000}\ |
+--------------------------------+------+------------+---------------------------------------------------------+
SELECT Name, Size, Mode.String AS Mode, timestamp(epoch=Mtime.Sec) AS mtime,, Data FROM glob(globs=path, accessor=accessor) WHERE Sys.name_type != 'DOS'</span>
</pre>
<p>The above example shows two volume shadow copies that Windows has
takens on two different dates (highlighted above). We can browse these
snapshots just like they were another drive (We can also apply any
glob expressions to this path):</p>
<pre class="code console literal-block">
<span class="generic output">F:\&gt;velociraptor.exe fs --accessor ntfs ls &quot;\\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\
Users\test\*.exe&quot;
+------------------+----------+------------+---------------------------+------------------+
|       Name       |   Size   |    Mode    |           mtime           |       Data       |
+------------------+----------+------------+---------------------------+------------------+
| velociraptor.exe | 12521472 | -rwxr-xr-x | 2018-08-19T23:37:01-07:00 | mft: 39504-128-0 |
|                  |          |            |                           | name_type: Win32 |
| winpmem.exe      |  3619260 | -rwxr-xr-x | 2017-12-28T21:17:50-08:00 | mft: 39063-128-1 |
|                  |          |            |                           | name_type: POSIX |
+------------------+----------+------------+---------------------------+------------------+
SELECT Name, Size, Mode.String AS Mode, timestamp(epoch=Mtime.Sec) AS mtime, Data FROM
glob(globs=path, accessor=accessor) WHERE Sys.name_type != 'DOS'</span>
</pre>
<p>Volume shadow copies are like a time machine - they can reveal data
that was stored on the drive days or weeks prior to the time we
inspected it which makes them very useful for some investigations.</p>
<div class="section" id="using-filesystem-accessors-remotely-the-velociraptor-vfs">
<h2>Using filesystem accessors remotely - The Velociraptor VFS</h2>
<p>The above description shows how Velociraptor's command line interface
can be used to interact with the various filesystem accessors. This is
important for writing and collecting artifacts for triage and general
system state exploration.</p>
<p>However, how do filesystem accessors appear in the Velociraptor GUI?</p>
<img alt="vfs1.png" src="vfs1.png" />
<p>The nice thing about Velociraptor's GUI is that it is just a way to
present the same information that the &quot;fs ls&quot; command is getting by
using the same VQL queries. Therefore the view is very familiar:</p>
<ol class="arabic simple">
<li>The top level of the Velociraptor VFS represents all the filesystem
accessors implemented in the client.</li>
<li>Each of these accessors shows its own view:<ol class="arabic">
<li>The file accessor uses the OS APIs to list files and
directories. Its top level is a list of mounted drives (which
may be CDROM's or even network shares).</li>
<li>The NTFS accessor shows all NTFS volumes accessible, including
local drives and Volume Shadow Copies.</li>
<li>The registry accessor uses Win32 APIs to access the registry and
shows at the top level a list of all system hives currently
attached.</li>
</ol>
</li>
<li>For each file listed, the accessor also includes a Data
attribute. This contains accessor specific metadata about the file
(for example the MFT entry).</li>
</ol>
<p>In the below screenshot we can see how the user may navigate into the
Volume Shadow Copy and retrieve files from it:</p>
<img alt="vfs2.png" src="vfs2.png" />
</div>
<div class="section" id="a-note-about-filenames">
<h2>A note about filenames.</h2>
<p>NTFS can have several different names to the same file. Typically, a
short DOS 8.3 style filename (e.g. PROGRA~1), as well as a Win32 long
filename (e.g. Program Files). You can see the short name for a file
using the API GetShortPathName() (or the command dir /x), but a
program needs to deliberately ask for it. Most programs do not
explicitly collect or show the short filename of a file.</p>
<p>This can cause problems for DFIR applications. For example, Imagine we
discovered a Run key to <cite>C:\Users\test\runme.exe</cite>. If we only
considered the long filename (as for example returned by the Win32API
FindFile() or the output of the dir command), then we would assume the
file has been removed and the run key is not active. In reality
however, the file may be called &quot;This is some long filename.exe&quot; with
a DOS name of &quot;runme.exe&quot;. Explorer (and most tools) will only show
the long filename by default, but the runkey will still execute by
referring to the DOS filename!</p>
<p>Usually the short filename is some variation of the long filename with
a ~1 or ~2 at the end. In reality it can be anything. In the snippet
below, I am setting the short filename for the velociraptor.exe binary
to be something completely unrelated, then I am running the binary
using the unrelated filename:</p>
<pre class="code console literal-block">
<span class="generic output">C:\Users\test&gt;fsutil file setshortname velociraptor.exe runme.exe
C:\Users\test&gt;dir /x *.exe
 Volume in drive C has no label.
 Volume Serial Number is 9459-F443

 Directory of C:\Users\test

08/19/2018  11:37 PM        12,521,472 RUNME.EXE    velociraptor.exe
               2 File(s)     16,140,732 bytes
               0 Dir(s)  11,783,704,576 bytes free
C:\Users\test&gt;runme.exe -h
usage: velociraptor [&lt;flags&gt;] &lt;command&gt; [&lt;args&gt; ...]

An advanced incident response and monitoring agent.</span>
</pre>
<p>You can see that Windows explorer shows no trace of the runme.exe file
since it only displays the Win32 long file name:</p>
<img alt="vfs3.png" src="vfs3.png" />
<p>It is important for DFIR investigators to be aware of this and test
your tools! You can see that sysinternals' autoruns program won't have
any of these shenanigans when I added a runkey to &quot;runme.exe&quot;. It
shows the real filename velociraptor.exe even though the runkey
indicates runme.exe:</p>
<img alt="vfs4.png" src="vfs4.png" />
<p>Velocirpator treats a file's DOS name and Win32 Name as distinct
entries in the NTFS directory listing. This allows us to find any
references to the file by it's DOS name as well as its Win32 name.</p>
</div>
<div class="section" id="conclusions">
<h2>Conclusions</h2>
<p>As Velociraptor gains more functionality, we envision more filesystem
accessors to become available. The nice thing about these accessors is
that they just slot in to the rest of the VQL plugins. By providing a
new accessor, we are able to glob, hash, yara scan etc the new
abstraction. For example, to yara scan a registry key one simply calls
the VQL plugin yara with an accessor of reg: <cite>yara(rules=myRules,
files=my_reg_keys, accessor=&quot;reg&quot;)</cite></p>
</div>
</div>

<footer class=" footline" >
	
</footer>


        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/blog/html/2018/11/09/event_queries_and_endpoint_monitoring.html" title="Event Queries and Endpoint Monitoring"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/blog/html/2018/09/29/detecting_powershell_persistence_with_velociraptor_and_yara.html" title="Detecting powershell persistence with Velociraptor and Yara" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js"></script>
    <script src="/js/perfect-scrollbar.min.js"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js"></script>
    <script src="/js/jquery.sticky.js"></script>
    <script src="/js/featherlight.min.js"></script>
    <script src="/js/html5shiv-printshiv.min.js"></script>
    <script src="/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js"></script>
    <script src="/js/learn.js"></script>
    <script src="/js/hugo-learn.js"></script>

    <link href="/mermaid/mermaid.css" rel="stylesheet" />
    <script src="/mermaid/mermaid.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    

  </body>
</html>

