<!DOCTYPE html>
<html>
  <head>
    <title>Velociraptor / Dig deeper</title>
    
      <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Detecting powershell persistence with Velociraptor and Yara :: Velociraptor / Dig deeper</title>
<link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link rel="stylesheet" href="/css/bootstrap.min.css">
<link href="/css/nucleus.css" rel="stylesheet">
<link href="/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/hybrid.css" rel="stylesheet">
<link href="/css/featherlight.min.css" rel="stylesheet">
<link href="/css/auto-complete.css" rel="stylesheet">
<link href="/theme-original/style.css" rel="stylesheet">

  <link href="/theme-original/variant-mine.css" rel="stylesheet">


<script src="/js/jquery-2.x.min.js"></script>
<style type="text/css">
  :root #header + #content > #left > #rlblock_left {
    display:none !important;
  }
</style>
<link rel="stylesheet" href="/css/theme-mine.css">
<script src="/js/custom.js"></script>


    
  </head>
  <body data-url="/blog/html/2018/09/29/detecting_powershell_persistence_with_velociraptor_and_yara.html">
    
      <div id="headermain"></div>
<nav id="sidebar" class="">



<div class="highlightable">
  <div id="header-wrapper">
    <div id="header">
      
	
  
    <a href="/">
  <img src="/images/logo.svg">
</a>
  


    </div>
        <div class="searchbox">
		    <label for="search-by"><i class="fa fa-search"></i></label>
		    <input data-search-input id="search-by" type="text" placeholder="Search...">
		    <span data-search-clear=""><i class="fa fa-close"></i></span>
		</div>
		<script type="text/javascript" src="/js/lunr.min.js"></script>
		<script type="text/javascript" src="/js/auto-complete.js"></script>
		<script type="text/javascript">
        
            var baseurl = "\/";
        
		</script>
		<script type="text/javascript" src="/js/search.js"></script>
  </div>

      <ul class="topics">
    <li data-nav-id="/about/" class="dd-item haschildren
        ">
      <div>
      <a href="/about/">About Velociraptor</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/about/features/" class="dd-item">
        <div>
          <a href="/about/features/">
            Velociraptor Features
          </a>
        </div>
    </li>
      <li data-nav-id="/about/license/" class="dd-item">
        <div>
          <a href="/about/license/">
            License
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/">Velociraptor Documentation</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/getting-started/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/getting-started/">Getting Started</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/getting-started/stand_alone/" class="dd-item">
        <div>
          <a href="/docs/getting-started/stand_alone/">
            Standalone Deployment
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/getting-started/deploying_clients/" class="dd-item">
        <div>
          <a href="/docs/getting-started/deploying_clients/">
            Deploying Clients
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/getting-started/cloud/" class="dd-item">
        <div>
          <a href="/docs/getting-started/cloud/">
            Deploying in the cloud
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/getting-started/triaging/" class="dd-item">
        <div>
          <a href="/docs/getting-started/triaging/">
            Triaging
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/user-interface/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/">User Interface</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/user-interface/investigating_clients/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/investigating_clients/">Investigating Clients</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/user-interface/investigating_clients/searching_clients/" class="dd-item">
        <div>
          <a href="/docs/user-interface/investigating_clients/searching_clients/">
            Searching for clients
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/investigating_clients/virtual_filesystem/" class="dd-item">
        <div>
          <a href="/docs/user-interface/investigating_clients/virtual_filesystem/">
            Client VFS
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/user-interface/artifacts/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/artifacts/">Velociraptor Artifacts</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/user-interface/artifacts/client_artifacts/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/client_artifacts/">
            Client Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/client_events/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/client_events/">
            Client Event Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/server_artifacts/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/server_artifacts/">
            Server Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/server_events/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/server_events/">
            Server Event Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/add_artifacts/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/add_artifacts/">
            Customizing Artifacts
          </a>
        </div>
    </li>
        </ul>
    </li>
      <li data-nav-id="/docs/user-interface/api/" class="dd-item">
        <div>
          <a href="/docs/user-interface/api/">
            The Velociraptor API
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/vql_reference/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/vql_reference/">VQL Reference</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/vql_reference/plugins/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/plugins/">
            VQL PLugins
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/event_plugins/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/event_plugins/">
            VQL Event PLugins
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/server/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/server/">
            VQL Server Plugins
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/functions/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/functions/">
            VQL Functions
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/templates/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/templates/">
            Report Templates
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/tips/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/tips/">
            Artifact Tips
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/filesystem_accessors/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/filesystem_accessors/">
            Filesystem Accessors
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/artifacts/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/artifacts/">Artifact Reference</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/artifacts/linux/" class="dd-item">
        <div>
          <a href="/docs/artifacts/linux/">
            Linux Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/windows_system/" class="dd-item">
        <div>
          <a href="/docs/artifacts/windows_system/">
            Windows System
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/server/" class="dd-item">
        <div>
          <a href="/docs/artifacts/server/">
            Server Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/triage/" class="dd-item">
        <div>
          <a href="/docs/artifacts/triage/">
            Windows Triage
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/detection/" class="dd-item">
        <div>
          <a href="/docs/artifacts/detection/">
            Windows Detection
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/events/" class="dd-item">
        <div>
          <a href="/docs/artifacts/events/">
            Windows Monitoring
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/misc/" class="dd-item">
        <div>
          <a href="/docs/artifacts/misc/">
            Miscelaneous
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/linux/linux/" class="dd-item">
        <div>
          <a href="/docs/artifacts/linux/linux/">
            Linux Artifacts
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/presentations/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/presentations/">Presentations and Workshops</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/presentations/sans_dfir_summit2019/" class="dd-item">
        <div>
          <a href="/docs/presentations/sans_dfir_summit2019/">
            SANS 2019
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/rsa/" class="dd-item">
        <div>
          <a href="/docs/presentations/rsa/">
            RSA APJ 2019
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/crikeycon2019/" class="dd-item">
        <div>
          <a href="/docs/presentations/crikeycon2019/">
            Crikeycon 2019
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/nzitf2018/" class="dd-item">
        <div>
          <a href="/docs/presentations/nzitf2018/">
            NZITF 2018
          </a>
        </div>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li data-nav-id="/blog/" class="dd-item parent haschildren
        ">
      <div>
      <a href="/blog/">Velociraptor Blog</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/blog/medium/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/">
            Recovering deleted NTFS Files with Velociraptor
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-11-12_windows-event-logs-d8d8e615c9ca/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-11-12_windows-event-logs-d8d8e615c9ca/">
            Windows Event Logs
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/">
            Triage with Velociraptor — Pt 3
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-10-04_triage-with-velociraptor-pt-2-d0f79066ca0e/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-10-04_triage-with-velociraptor-pt-2-d0f79066ca0e/">
            Triage with Velociraptor — Pt 2
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-10-02_triage-with-velociraptor-pt-1-253f57ce96c0/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-10-02_triage-with-velociraptor-pt-1-253f57ce96c0/">
            Triage with Velociraptor — Pt 1
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-09-11_velociraptor-s-client-side-buffer-3ce03697a4e6/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-09-11_velociraptor-s-client-side-buffer-3ce03697a4e6/">
            Velociraptor’s client side buffer
          </a>
        </div>
    </li>
        </ul>
    </li>




    <hr />
    <li></li>
    
    </ul>

 <section id="footer">
    </section>
  </div>
</nav>



<section id="body">
<div id="overlay"></div>
<div class="padding highlightable">

  <div id="top-bar">
    <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
        <span id="sidebar-toggle-span">
          <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
            <i class="fa fa-bars"></i>
          </a>
        </span>
        <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
        <span class="links">
        







 <a href='/'>Velociraptor / Dig deeper</a> > <a href='/blog/'>Velociraptor Blog</a> > Detecting powershell persistence with Velociraptor and Yara

 

 

   
        </span>
    </div>
    
    
    <div class="progress">
        <div class="wrapper">
    <nav id="TableOfContents">
<ul>
<li><a href="#preparation">Preparation</a></li>
<li><a href="#defining-the-artifact">Defining the Artifact.</a></li>
<li><a href="#testing-the-artifact">Testing the artifact</a></li>
<li><a href="#but-wait-there-is-a-problem">But wait! There is a problem!</a>
<ul>
<li><a href="#how-does-hkey-users-hive-work">How does HKEY_USERS hive work?</a></li>
<li><a href="#how-to-fix-this">How to fix this?</a></li>
<li><a href="#conclusions">Conclusions</a></li>
</ul></li>
</ul>
</nav>
        </div>
    </div>
    

  </div>


<div id="body-inner">
  
    <h1>Detecting powershell persistence with Velociraptor and Yara</h1>
  



    
    
    
    

<p>::: {.admonition}
Update</p>

<p>As of the latest release of Velociraptor we have raw registry parsing
which can also be done via raw NTFS to get around file locking. It is no
longer necessary to run yara scans and parse with regripper as shown
here.
:::</p>

<p>I was watching the SANS DFIR Summit 2018 videos on youtube and came
across Mari DeGrazia\&rsquo;s talk titled <a href="https://www.youtube.com/watch?v=JWC7fzhvAY8">\&ldquo;Finding and Decoding Malicious
Powershell Scripts\&rdquo;</a>. This
is an excellent talk and it really contains a wealth of information. It
seems that Powershell is really popular these days, allowing attacker to
\&ldquo;live off the land\&rdquo; by installing fully functional reverse shells and
backdoors, in a few lines of obfuscated scripts.</p>

<p>Mari went through a number of examples and also expanded on some in her
blog post <a href="http://az4n6.blogspot.com/2018/06/malicious-powershell-in-registry.html">Malicious PowerShell in the Registry:
Persistence</a>,
where she documents persistence through an autorun key launching
powershell to execute a payload within another registry key.</p>

<p>A similar persistence mechanism is documented by David Kennedy from
Binary defence in his post <a href="https://blog.binarydefense.com/powershell-injection-diskless-persistence-bypass-techniques">PowerShell Injection with Fileless Payload
Persistence and Bypass
Techniques</a>.
In that case an msha.exe link was stored in the user\&rsquo;s Run key which
executed a payload from another registry key.</p>

<p>I was eager to write a Velociraptor artifact to attempt to detect such
keys using a YARA signature. Of course signature based detection is not
as robust as behavioural analysis but it is quick and usually quite
effective.</p>

<p>I thought it was still quite instructive to document how one can develop
the VQL queries for a simple Velociraptor artifact. We will be
developing the artifact interactively on a Windows system.</p>

<h1 id="preparation">Preparation</h1>

<p>Our artifact will attempt to detect the persistence mechanism detailed
in the above posts. We start by adding a value to our test user account
under the key</p>

<pre><code class="language-.sourceCode">Key: &quot;HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run&quot;
Value: &quot;C:\Windows\system32\mshta.exe&quot;
Data:
  about:&lt;script&gt;c1hop=&quot;X642N10&quot;;R3I=new%20ActiveXObject(&quot;WScript.Shell&quot;);
  QR3iroUf=&quot;I7pL7&quot;;k9To7P=R3I.RegRead(&quot;HKCU\\software\\bkzlq\\zsdnhepyzs&quot;);
  J7UuF1n=&quot;Q2LnLxas&quot;;eval(k9To7P);JUe5wz3O=&quot;zSfmLod&quot;;&lt;/script&gt;
</code></pre>

<h1 id="defining-the-artifact">Defining the Artifact.</h1>

<p>We create a directory called \&ldquo;artifacts\&rdquo; then create a new file inside
it called powershell_persistence.yaml. Velociraptor artifacts are just
YAML files that can be loaded at runtime using the --definitions flag.</p>

<p>Every artifact has a name, by convention the name is separated into its
major categories. We will call ours Windows.Persistence.Powershell:</p>

<pre><code class="language-.sourceCode">name: Windows.Persistence.Powershell
</code></pre>

<p>This is the minimum required for Velociraptor to identify it. We can see
a listing of all artifacts Velociraptor knows about using the
\&ldquo;artifacts list\&rdquo; command:</p>

<pre><code class="language-.sourceCode">F:\&gt;velociraptor.exe --definitions artifacts artifacts list
INFO:2018/09/28 07:59:40 Loaded 34 built in artifacts
Linux.Applications.Chrome.Extensions
Linux.Applications.Chrome.Extensions.Upload
…
Windows.Persistence.Powershell
...
Windows.Sys.Users
</code></pre>

<p>We can collect the artifact simply by using the \&ldquo;artifacts collect\&rdquo;
command:</p>

<pre><code class="language-.sourceCode">F:\&gt;velociraptor.exe --definitions artifacts artifacts collect Windows.Persistence.Powershell
INFO:2018/09/28 20:01:32 Loaded 34 built in artifacts
</code></pre>

<p>Ok so Velociraptor can load and collect this new artifact, but as yet it
does nothing! We need to think about what exactly we want to collect.</p>

<p>We know we want to search for all values in the Run/RunOnce hive of all
the users. Let\&rsquo;s first see if we can retrieve all the values using a
glob:</p>

<pre><code class="language-.sourceCode">name: Windows.Persistence.Powershell
parameters:
  - name: keyGlob
    default: &quot;HKEY_USERS\\*\\Software\\Microsoft\\Windows\
    \\CurrentVersion\\{Run,RunOnce}\\*&quot;
sources:
 - precondition:
    SELECT OS from info() where OS = &quot;windows&quot;
   queries:
   - |
    SELECT FullPath from glob(
       globs=keyGlob,
       accessor=&quot;reg&quot;
    )
</code></pre>

<p>This artifact demonstrates a few concepts:</p>

<ol>
<li>We can define parameters by name, and reference them from within the
VQL query. This keeps the VQL query clean and more readable.</li>
<li>We can define a precondition on the artifact. If the precondition is
not met, the VQL query will not be run.</li>
</ol>

<p>Lets run this artifact:</p>

<pre><code class="language-.sourceCode">F:\&gt;velociraptor.exe --definitions artifacts artifacts collect Windows.Persistence.Powershell
INFO:2018/09/28 20:51:47 Loaded 34 built in artifacts
+--------------------------------+
|            FullPath            |
+--------------------------------+
| HKEY_USERS\S-1-5-19\Software\M |
| icrosoft\Windows\CurrentVersio |
| n\Run\OneDriveSetup            |
| HKEY_USERS\S-1-5-20\Software\M |
| icrosoft\Windows\CurrentVersio |
| n\Run\OneDriveSetup            |
| HKEY_USERS\S-1-5-21-546003962- |
| 2713609280-610790815-1001\Soft |
| ware\Microsoft\Windows\Current |
| Version\Run\&quot;C:\Windows\system |
| 32\mshta.exe&quot;                  |
+--------------------------------+
Artifact:
Windows.Persistence.Powershell
</code></pre>

<p>It returns a couple of results so there are two Run/RunOnce values
defined. For this artifact, we only want to return those entries which
match a specific yara signature. We can work later on improving the yara
signature, but for now let\&rsquo;s just detect uses of the eval() powershell
command within 500 characters of an ActiveXObject instantiation. We will
try to match each value returned from the Run keys with this object:</p>

<pre><code class="language-.sourceCode">name: Windows.Persistence.Powershell
parameters:
  - name: keyGlob
    default: &quot;HKEY_USERS\\*\\Software\\Microsoft\\Windows\
             \\CurrentVersion\\{Run,RunOnce}\\*&quot;
  - name: yaraRule
    default: |
      rule Powershell {
        strings:
        $ = /ActiveXObject.{,500}eval/ nocase
        $ = /ActiveXObject.{,500}eval/ wide nocase
        condition:
        any of them
      }
sources:
 - precondition:
    SELECT OS from info() where OS = &quot;windows&quot;
   queries:
   - |
     // This is a stored query
     LET file = SELECT FullPath from glob(
       globs=keyGlob,
       accessor=&quot;reg&quot;
     )
   - |
     SELECT * FROM yara(
       rules=yaraRule,
       files=file.FullPath,   // This will expand to a list of paths.
       accessor=&quot;reg&quot;)
</code></pre>

<p>This version recovers the FullPath of all the Run/RunOnce values and
stores them in a stored query. We then issue another query that applies
the yara rule on these values:</p>

<pre><code class="language-.sourceCode">F:\&gt;velociraptor.exe --definitions artifacts artifacts collect Windows.Persistence.Powershell
INFO:2018/09/28 21:29:10 Loaded 34 built in artifacts
+------------+------+------+--------------------------------+--------------------------------+
|    Rule    | Meta | Tags |            Strings             |              File              |
+------------+------+------+--------------------------------+--------------------------------+
| Powershell |      |      | {&quot;Name&quot;:&quot;$&quot;,&quot;Offset&quot;:40,&quot;HexDa | {&quot;FullPath&quot;:&quot;HKEY_USERS\\S-1-5 |
|            |      |      | ta&quot;:[&quot;00000000  41 63 74 69 76 | -21-546003962-2713609280-61079 |
|            |      |      |  65 58 4f  62 6a 65 63 74 28 2 | 0815-1001\\Software\\Microsoft |
|            |      |      | 2 57  |ActiveXObject(\&quot;W|&quot;,&quot;00 | \\Windows\\CurrentVersion\\Run |
|            |      |      | 000010  53 63 72 69 70 74 2e 5 | \\\&quot;C:\\Windows\\system32\\msh |
|            |      |      | 3  68 65 6c 6c 22 29 3b 51  |S | ta.exe\&quot;&quot;,&quot;Type&quot;:&quot;SZ&quot;,&quot;Data&quot;:{ |
|            |      |      | cript.Shell\&quot;);Q|&quot;,&quot;00000020   | &quot;type&quot;:&quot;SZ&quot;,&quot;value&quot;:&quot;about:\u0 |
|            |      |      | 52 33 69 72 6f 55 66 3d  22 49 | 03cscript\u003ec1hop=\&quot;X642N10 |
|            |      |      |  37 70 4c 37 22 3b  |R3iroUf=\ | \&quot;;R3I=new%20ActiveXObject(\&quot;W |
|            |      |      | &quot;I7pL7\&quot;;|&quot;,&quot;00000030  6b 39 5 | Script.Shell\&quot;);QR3iroUf=\&quot;I7p |
|            |      |      | 4 6f 37 50 3d 52  33 49 2e 52  | L7\&quot;;k9To7P=R3I.RegRead(\&quot;HKCU |
|            |      |      | 65 67 52 65  |k9To7P=R3I.RegRe | \\\\software\\\\bkzlq\\\\zsdnh |
|            |      |      | |&quot;,&quot;00000040  61 64 28 22 48 4 | epyzs\&quot;);J7UuF1n=\&quot;Q2LnLxas\&quot;; |
|            |      |      | b 43 55  5c 5c 73 6f 66 74 77  | eval(k9To7P);JUe5wz3O=\&quot;zSfmLo |
|            |      |      | 61  |ad(\&quot;HKCU\\\\softwa|&quot;,&quot;00 | d\&quot;;\u003c/script\u003e&quot;},&quot;Mti |
|            |      |      | 000050  72 65 5c 5c 62 6b 7a 6 | me&quot;:{&quot;sec&quot;:1538191253,&quot;usec&quot;:1 |
|            |      |      | c  71 5c 5c 7a 73 64 6e 68  |r | 538191253231489700},&quot;Ctime&quot;:{&quot; |
|            |      |      | e\\\\bkzlq\\\\zsdnh|&quot;,&quot;0000006 | sec&quot;:1538191253,&quot;usec&quot;:1538191 |
|            |      |      | 0  65 70 79 7a 73 22 29 3b  4a | 253231489700},&quot;Atime&quot;:{&quot;sec&quot;:1 |
|            |      |      |  37 55 75 46 31 6e 3d  |epyzs\ | 538191253,&quot;usec&quot;:1538191253231 |
|            |      |      | &quot;);J7UuF1n=|&quot;,&quot;00000070  22 51 | 489700}}                       |
</code></pre>

<p>We can see that the last query returns 5 columns, but each column
actually contains objects with quite a lot of additional information.
For example, the File column returns information about the file that
matched the yara rule (its filename, timestamps etc). The output is a
bit confusing so we just return the relevant columns. We can replace the
* in the last query with a curated list of columns to return:</p>

<pre><code class="language-.sourceCode">SELECT File.FullPath as ValueName, File.Data.value as Contents,
  timestamp(epoch=File.Mtime.Sec) as ModTime
FROM yara(rules=yaraRule,
          files=file.FullPath,
          accessor=&quot;reg&quot;)
</code></pre>

<p>Which results in the quite readable:</p>

<pre><code class="language-.sourceCode">F:\&gt;velociraptor.exe --definitions artifacts artifacts collect Windows.Persistence.Powershell
INFO:2018/09/28 21:42:18 Loaded 34 built in artifacts
+--------------------------------+--------------------------------+---------------------------+
|           ValueName            |            Contents            |          ModTime          |
+--------------------------------+--------------------------------+---------------------------+
| HKEY_USERS\S-1-5-21-546003962- | about:&lt;script&gt;c1hop=&quot;X642N10&quot;; | 2018-09-28T20:20:53-07:00 |
| 2713609280-610790815-1001\Soft | R3I=new%20ActiveXObject(&quot;WScri |                           |
| ware\Microsoft\Windows\Current | pt.Shell&quot;);QR3iroUf=&quot;I7pL7&quot;;k9 |                           |
| Version\Run\&quot;C:\Windows\system | To7P=R3I.RegRead(&quot;HKCU\\softwa |                           |
| 32\mshta.exe&quot;                  | re\\bkzlq\\zsdnhepyzs&quot;);J7UuF1 |                           |
|                                | n=&quot;Q2LnLxas&quot;;eval(k9To7P);JUe5 |                           |
|                                | wz3O=&quot;zSfmLod&quot;;&lt;/script&gt;       |                           |
+--------------------------------+--------------------------------+---------------------------+
Artifact: Windows.Persistence.Powershell
</code></pre>

<p>Great! This works and only returns values that match the yara signature
we developed.</p>

<h1 id="testing-the-artifact">Testing the artifact</h1>

<p>Let\&rsquo;s test this artifact for real now. We restart the frontend with the
--definition flag and this makes the new artifact available in the GUI
under the Artifact Collector flow. The GUI also shows the entire
artifact we defined so we can see what VQL will be run:</p>

<p><img src="powershell1.png" alt="image" /></p>

<p>Launching the flow appears to work and shows exactly the same result as
we collected on the command line:</p>

<p><img src="powershell2.png" alt="image" /></p>

<h1 id="but-wait-there-is-a-problem">But wait! There is a problem!</h1>

<p>When we log out of the machine, and then rerun the artifact it returns
no results!</p>

<p><img src="powershell3.png" alt="image" /></p>

<p>Why is that? Experienced incident responders would recognize that any
artifact that works from the HKEY_USERS registry hive is inherently
unreliable. This is because the HKEY_USERS hive is not a real hive -it
is a place where Windows mounts the user\&rsquo;s hive when the user logs in.</p>

<h2 id="how-does-hkey-users-hive-work">How does HKEY_USERS hive work?</h2>

<p>Windows implements the concept of user profiles. Each user has a
personal registry hive that stores user specific settings. It is
actually a file stored on their home directory called ntuser.dat. When a
user logs into the workstation, the file may be synced from the domain
controller and then it is mounted under the HKEY_USERS\&lt;sid&gt;
registry hive.</p>

<p>This means that when the user logs out, their user registry hive is
unmounted and does not appear in HKEY_USERS any longer. Any artifacts
based around the HKEY_USERS hive will work only if the collection is
run when a user is logged in.</p>

<p>This is obviously not what we want when we hunt for persistence! We want
to make sure that none of the users on the system have this persistence
mechanism installed. You can imagine a case where a system has been
cleaned up but then a user logs into the machine, thereby reinfecting
it!</p>

<h2 id="how-to-fix-this">How to fix this?</h2>

<p>Yara is a very powerful tool because it allows us to search for patterns
in amorphous data (such as process memory and structured files) without
having to fully understand the structure of the data we are searching
for. Of course this has its limitations, but yara can raise a red flag
if the signature matches the file, and we can analyse this file more
carefully later.</p>

<p>In this case, we can not rely on globbing the HKEY_USER registry hive,
so maybe we can just search the files that back these hives? We know
that each user on the system has an NTUSER.DAT file in their home
directory (usually C:\\Users\\&lt;username&gt;), so let\&rsquo;s write an
artifact to find these files. We can reuse the artifact
Windows.Sys.Users that reports all user accounts on a system (we display
it as JSON to enhance readability):</p>

<pre><code class="language-.sourceCode">F:\&gt;velociraptor.exe artifacts collect Windows.Sys.Users --format json
INFO:2018/09/28 22:44:26 Loaded 34 built in artifacts
{
 &quot;Description&quot;: &quot;&quot;,
 &quot;Directory&quot;: &quot;C:\\Users\\test&quot;,
 &quot;Gid&quot;: 513,
 &quot;Name&quot;: &quot;test&quot;,
 &quot;Type&quot;: &quot;local&quot;,
 &quot;UUID&quot;: &quot;S-1-5-21-546003962-2713609280-610790815-1001&quot;,
 &quot;Uid&quot;: 1001
},
{
 &quot;Description&quot;: &quot;&quot;,
 &quot;Directory&quot;: &quot;C:\\Users\\user1&quot;,
 &quot;Gid&quot;: 513,
 &quot;Name&quot;: &quot;user1&quot;,
 &quot;Type&quot;: &quot;local&quot;,
 &quot;UUID&quot;: &quot;S-1-5-21-546003962-2713609280-610790815-1003&quot;,
 &quot;Uid&quot;: 1003
},
</code></pre>

<p>So we just want to YARA scan the NTUSER.DAT file in each home directory:</p>

<pre><code class="language-.sourceCode">SELECT * from foreach(
row={
   SELECT Name, Directory as HomeDir
     FROM Artifact.Windows.Sys.Users()
    WHERE Directory.value and Gid
},
query={
  SELECT File.FullPath As FullPath,
         Strings.Offset AS Off,
         Strings.HexData As Hex,
          upload(file=File.FullPath, accessor=&quot;ntfs&quot;) AS Upload
      FROM yara(
            files=&quot;\\\\.\\&quot; + HomeDir + &quot;\\ntuser.dat&quot;,
            accessor=&quot;ntfs&quot;,
            rules=yaraRule, context=10)
      })
</code></pre>

<p>This query:</p>

<ol>
<li>Selects all the usernames and their home directory from the
Windows.Sys.Users artifact.</li>
<li>For each directory prepends \\\\.\\ and appends
\&ldquo;ntuser.dat\&ldquo;. For example c:\\Users\\test becomes
\\\\.\\c:\\Users\\test\\NTUSER.dat</li>
<li>The file is accessed using the NTFS filesystem accessor. This is
necessary because the registry hive is locked if the user is logged
in. Therefore we must access it using raw NTFS parsing to bypass the
OS locking.</li>
<li>For each file that matches the yara expression, we upload the file
to the server for further analysis.</li>
</ol>

<p>Lets run this new artifact on the server:</p>

<p><img src="powershell5.png" alt="image" /></p>

<p>Unlike the previous artifact, this one simply returns the YARA hit, but
because we do not have any context on which value contained the
signature, or even if it had been deleted. Luckily we uploaded the raw
registry hive for further analysis, and we can use a tool such as
RegRipper to extract more information from the hive:</p>

<pre><code class="language-.sourceCode">$ wine rip.exe -p user_run -r
/tmp/velociraptor/clients/C.c916a7e445eb0868/uploads/F.078739d6/ntfs/
%5C%5C.%5CC%3A%5CUsers%5Cuser1%5CNTUSER.DAT
Launching user_run v.20140115
user_run v.20140115
(NTUSER.DAT) [Autostart] Get autostart key contents from NTUSER.DAT hive

Software\Microsoft\Windows\CurrentVersion\Run
LastWrite Time Thu Sep 27 01:19:08 2018 (UTC)
 OneDrive: &quot;C:\Users\user1\AppData\Local\Microsoft\OneDrive\OneDrive.exe&quot;
   /background
 c:\windows\system32\mshta.exe: about:&lt;script&gt;c1hop=&quot;X642N10&quot;;
   R3I=new%20ActiveXObject(&quot;WScript.Shell&quot;);
   QR3iroUf=&quot;I7pL7&quot;;k9To7P=R3I.RegRead(&quot;HKCU\\software\\
   bkzlq\\zsdnhepyzs&quot;);J7UuF1n=&quot;Q2LnLxas&quot;;eval(k9To7P);JUe5wz3O=&quot;zSfmLod&quot;;&lt;/script&gt;
</code></pre>

<p>Note above how we can simply retrieve the uploaded file from
Velociraptor\&rsquo;s filestore. Velociraptor stores uploaded files on the
filesystem within the flow\&rsquo;s directory.</p>

<h2 id="conclusions">Conclusions</h2>

<p>In this blog post we saw how to utilize YARA to find suspicious
powershell persistence mechanisms. YARA is a powerful tool and using
Velociraptor\&rsquo;s artifacts we can apply it to files, registry values, and
raw NTFS files such as locked registry hives and the pagefile.</p>

<p>We also saw some of the inherent problems with relying on the
HKEY_USERS registry hive for detection - the hive is only present when
a user is logged in so when we hunt, we might miss those users who are
currently logged out. We saw how YARA can be used to detect suspicious
patterns in raw registry hive files and how artifacts may retrieve those
files for further analysis.</p>


    
    
          <footer class=" footline" >
	
</footer>
  </div>
</div>

<div id="navigation">
<a class="nav nav-prev" href="/docs/presentations/nzitf2018/" title="New Zealand Internet Task Force Conference 2018"> <i class="fa fa-chevron-left"></i><label>New Zealand Internet Task Force Conference 2018</label></a>
    <a class="nav nav-next" href="/blog/medium/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/" title="Recovering deleted NTFS Files with Velociraptor" style="margin-right: 0px;"><label>Recovering deleted NTFS Files with Velociraptor</label><i class="fa fa-chevron-right"></i></a></div>

</section>
<div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
  <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
</div>    

<script src="/js/clipboard.min.js"></script>
<script src="/js/featherlight.min.js"></script>
<script src="/js/html5shiv-printshiv.min.js"></script>

<script src="/js/modernizr.custom.71422.js"></script>
<script src="/js/docdock.js"></script>
<script src="/theme-original/script.js"></script>


    

    
    

    
  </body>
</html>