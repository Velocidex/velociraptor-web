<!DOCTYPE html>
<html>
  <head>
    <title>Velociraptor / Dig deeper</title>
    
      <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Recovering deleted NTFS Files with Velociraptor :: Velociraptor / Dig deeper</title>
<link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link rel="stylesheet" href="/css/bootstrap.min.css">
<link href="/css/nucleus.css" rel="stylesheet">
<link href="/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/hybrid.css" rel="stylesheet">
<link href="/css/featherlight.min.css" rel="stylesheet">
<link href="/css/auto-complete.css" rel="stylesheet">
<link href="/theme-original/style.css" rel="stylesheet">

  <link href="/theme-original/variant-mine.css" rel="stylesheet">


<script src="/js/jquery-2.x.min.js"></script>
<style type="text/css">
  :root #header + #content > #left > #rlblock_left {
    display:none !important;
  }
</style>
<link rel="stylesheet" href="/css/theme-mine.css">
<script src="/js/custom.js"></script>


    
  </head>
  <body data-url="/blog/medium/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/">
    
      <div id="headermain"></div>
<nav id="sidebar" class="">



<div class="highlightable">
  <div id="header-wrapper">
    <div id="header">
      
	
  
    <a href="/">
  <img src="/images/logo.svg">
</a>

  


    </div>
        <div class="searchbox">
                    <label for="search-by"><i class="fa fa-search"></i></label>
                    <input data-search-input id="search-by" type="text" placeholder="Search...">
                    <span data-search-clear=""><i class="fa fa-close"></i></span>
                </div>
                <script type="text/javascript" src="/js/lunr.min.js"></script>
                <script type="text/javascript" src="/js/auto-complete.js"></script>
                <script type="text/javascript">
        
            var baseurl = "\/";
        
                </script>
                <script type="text/javascript" src="/js/search.js"></script>
  </div>

      <ul class="topics">
    <li data-nav-id="/about/" class="dd-item haschildren
        ">
      <div>
      <a href="/about/">About Velociraptor</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/about/features/" class="dd-item">
        <div>
          <a href="/about/features/">
            Velociraptor Features
          </a>
        </div>
    </li>
      <li data-nav-id="/about/license/" class="dd-item">
        <div>
          <a href="/about/license/">
            License
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/">Velociraptor Documentation</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/getting-started/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/getting-started/">Getting Started</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/getting-started/stand_alone/" class="dd-item
        ">
      <div>
      <a href="/docs/getting-started/stand_alone/">Standalone Deployment</a>
      </div>
    </li>
    <li data-nav-id="/docs/getting-started/deploying_clients/" class="dd-item
        ">
      <div>
      <a href="/docs/getting-started/deploying_clients/">Deploying Clients</a>
      </div>
    </li>
    <li data-nav-id="/docs/getting-started/cloud/" class="dd-item
        ">
      <div>
      <a href="/docs/getting-started/cloud/">Deploying in the cloud</a>
      </div>
    </li>
    <li data-nav-id="/docs/getting-started/performance/" class="dd-item
        ">
      <div>
      <a href="/docs/getting-started/performance/">Performance</a>
      </div>
    </li>
    <li data-nav-id="/docs/getting-started/triaging/" class="dd-item
        ">
      <div>
      <a href="/docs/getting-started/triaging/">Triaging</a>
      </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/user-interface/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/">User Interface</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/user-interface/investigating_clients/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/investigating_clients/">Investigating Clients</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/user-interface/investigating_clients/searching_clients/" class="dd-item
        ">
      <div>
      <a href="/docs/user-interface/investigating_clients/searching_clients/">Searching for clients</a>
      </div>
    </li>
    <li data-nav-id="/docs/user-interface/investigating_clients/virtual_filesystem/" class="dd-item
        ">
      <div>
      <a href="/docs/user-interface/investigating_clients/virtual_filesystem/">The Virtual File System</a>
      </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/user-interface/artifacts/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/artifacts/">Velociraptor Artifacts</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/user-interface/artifacts/client_artifacts/" class="dd-item
        ">
      <div>
      <a href="/docs/user-interface/artifacts/client_artifacts/">Client Artifacts</a>
      </div>
    </li>
    <li data-nav-id="/docs/user-interface/artifacts/client_events/" class="dd-item
        ">
      <div>
      <a href="/docs/user-interface/artifacts/client_events/">Client Event Artifacts</a>
      </div>
    </li>
    <li data-nav-id="/docs/user-interface/artifacts/server_artifacts/" class="dd-item
        ">
      <div>
      <a href="/docs/user-interface/artifacts/server_artifacts/">Server Artifacts</a>
      </div>
    </li>
    <li data-nav-id="/docs/user-interface/artifacts/server_events/" class="dd-item
        ">
      <div>
      <a href="/docs/user-interface/artifacts/server_events/">Server Event Artifacts</a>
      </div>
    </li>
    <li data-nav-id="/docs/user-interface/artifacts/add_artifacts/" class="dd-item
        ">
      <div>
      <a href="/docs/user-interface/artifacts/add_artifacts/">Customizing Artifacts</a>
      </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/user-interface/api/" class="dd-item
        ">
      <div>
      <a href="/docs/user-interface/api/">The Velociraptor API</a>
      </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/vql_reference/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/vql_reference/">VQL Reference</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/vql_reference/basic/" class="dd-item
        ">
      <div>
      <a href="/docs/vql_reference/basic/">Basic VQL functions and plugins</a>
      </div>
    </li>
    <li data-nav-id="/docs/vql_reference/windows/" class="dd-item
        ">
      <div>
      <a href="/docs/vql_reference/windows/">Windows Specific Functionality</a>
      </div>
    </li>
    <li data-nav-id="/docs/vql_reference/parsers/" class="dd-item
        ">
      <div>
      <a href="/docs/vql_reference/parsers/">Parsers and data extractors</a>
      </div>
    </li>
    <li data-nav-id="/docs/vql_reference/server/" class="dd-item
        ">
      <div>
      <a href="/docs/vql_reference/server/">Server Side Functionality</a>
      </div>
    </li>
    <li data-nav-id="/docs/vql_reference/plugin/" class="dd-item
        ">
      <div>
      <a href="/docs/vql_reference/plugin/">Client Side Functionality</a>
      </div>
    </li>
    <li data-nav-id="/docs/vql_reference/event/" class="dd-item
        ">
      <div>
      <a href="/docs/vql_reference/event/">Event Plugins</a>
      </div>
    </li>
    <li data-nav-id="/docs/vql_reference/experimental/" class="dd-item
        ">
      <div>
      <a href="/docs/vql_reference/experimental/">Experimental Functionality</a>
      </div>
    </li>
    <li data-nav-id="/docs/vql_reference/filesystem_accessors/" class="dd-item
        ">
      <div>
      <a href="/docs/vql_reference/filesystem_accessors/">Filesystem Accessors</a>
      </div>
    </li>
    <li data-nav-id="/docs/vql_reference/templates/" class="dd-item
        ">
      <div>
      <a href="/docs/vql_reference/templates/">Report Templates</a>
      </div>
    </li>
    <li data-nav-id="/docs/vql_reference/tips/" class="dd-item
        ">
      <div>
      <a href="/docs/vql_reference/tips/">Artifact Tips</a>
      </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/artifacts/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/artifacts/">Artifact Reference</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/artifacts/linux/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/linux/">Linux Artifacts</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/artifacts/windows_system/">Windows</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/artifacts/windows_system/events/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/events/">Event Logs</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/system/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/system/">System</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/registry/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/registry/">Registry</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/network/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/network/">Network</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/applications/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/applications/">Applications</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/detection/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/detection/">Malware Detection</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/triage/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/triage/">Triage Artifacts</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/remediation/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/remediation/">Remdiation</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/monitoring/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/monitoring/">Event Monitoring</a>
      </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/artifacts/server/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/server/">Server Artifacts</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/misc/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/misc/">Miscelaneous Artifacts</a>
      </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/presentations/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/presentations/">Presentations and Workshops</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/presentations/auscert_2020/" class="dd-item
        ">
      <div>
      <a href="/docs/presentations/auscert_2020/">Auscert 2020 Tutorial</a>
      </div>
    </li>
    <li data-nav-id="/docs/presentations/comfycon.2020/" class="dd-item
        ">
      <div>
      <a href="/docs/presentations/comfycon.2020/">Comfycon 2020</a>
      </div>
    </li>
    <li data-nav-id="/docs/presentations/training_2020/" class="dd-item
        ">
      <div>
      <a href="/docs/presentations/training_2020/">Enterprise Hunting and Incident Response with Velociraptor 2020</a>
      </div>
    </li>
    <li data-nav-id="/docs/presentations/linux.conf.au.2020/" class="dd-item
        ">
      <div>
      <a href="/docs/presentations/linux.conf.au.2020/">Linux.Conf.Au 2020</a>
      </div>
    </li>
    <li data-nav-id="/docs/presentations/sans_dfir_summit2019/" class="dd-item
        ">
      <div>
      <a href="/docs/presentations/sans_dfir_summit2019/">SANS Summit 2019</a>
      </div>
    </li>
    <li data-nav-id="/docs/presentations/rsa/" class="dd-item
        ">
      <div>
      <a href="/docs/presentations/rsa/">RSA Asia Pacific and Japan 2019</a>
      </div>
    </li>
    <li data-nav-id="/docs/presentations/crikeycon2019/" class="dd-item
        ">
      <div>
      <a href="/docs/presentations/crikeycon2019/">Crikeycon 2019 Training Workshop</a>
      </div>
    </li>
    <li data-nav-id="/docs/presentations/nzitf2018/" class="dd-item
        ">
      <div>
      <a href="/docs/presentations/nzitf2018/">New Zealand Internet Task Force Conference 2018</a>
      </div>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li data-nav-id="/blog/" class="dd-item parent haschildren
        ">
      <div>
      <a href="/blog/">Velociraptor Blog</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/blog/medium/2020-12-26-slack-and-velociraptor-b63803ba4b16/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-12-26-slack-and-velociraptor-b63803ba4b16/">
            Slack and Velociraptor
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-12-13-velociraptor-and-osquery-2a4306dd23c/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-12-13-velociraptor-and-osquery-2a4306dd23c/">
            Velociraptor and OSQuery
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-11-13-the-windows-usn-journal-f0c55c9010e/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-11-13-the-windows-usn-journal-f0c55c9010e/">
            The Windows USN Journal
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-09-28-velociraptor-network-communications-30568624043a/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-09-28-velociraptor-network-communications-30568624043a/">
            Velociraptor Communications
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-08-17-velociraptor-sso-authentication-6dd68d46dccf/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-08-17-velociraptor-sso-authentication-6dd68d46dccf/">
            Velociraptor SSO Authentication
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-08-16-profiling-the-beast-58913437fd16/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-08-16-profiling-the-beast-58913437fd16/">
            Profiling the beast
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-07-14-triage-with-velociraptor-pt-4-cf0e60810d1e/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-07-14-triage-with-velociraptor-pt-4-cf0e60810d1e/">
            Triage with Velociraptor — Pt 4
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-07-13-velociraptor-in-the-tool-age-d896dfe71b9/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-07-13-velociraptor-in-the-tool-age-d896dfe71b9/">
            Velociraptor in the tool age
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-06-19-the-velociraptor-query-language-pt-2-fe92bb7aa150/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-06-19-the-velociraptor-query-language-pt-2-fe92bb7aa150/">
            The Velociraptor Query Language Pt 2
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-06-14-the-velociraptor-query-language-pt-1-d721bff100bf/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-06-14-the-velociraptor-query-language-pt-1-d721bff100bf/">
            The Velociraptor Query Language Pt 1
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-04-16-velociraptor-e48a47e0317d/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-04-16-velociraptor-e48a47e0317d/">
            Velociraptor
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-03-29-velociraptors-acl-model-7f497575daee/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-03-29-velociraptors-acl-model-7f497575daee/">
            Velociraptor’s ACL model
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-03-28-velociraptor-notebooks-d02e0bd11230/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-03-28-velociraptor-notebooks-d02e0bd11230/">
            Velociraptor notebooks
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-03-07-extending-vql-plugins-7fb004cb6ec4/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-03-07-extending-vql-plugins-7fb004cb6ec4/">
            Extending VQL plugins
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-03-06-velociraptor-post-processing-with-jupyter-notebook-and-pandas-8a344d05ee8c/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-03-06-velociraptor-post-processing-with-jupyter-notebook-and-pandas-8a344d05ee8c/">
            Velociraptor Post-processing with Jupyter Notebook and Pandas
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-01-12_hunting-malware-using-mutants-ea08e86dfc19/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-01-12_hunting-malware-using-mutants-ea08e86dfc19/">
            Hunting Malware using Mutants
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-12-31_digging-into-the-system-resource-usage-monitor-srum-afbadb1a375/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-12-31_digging-into-the-system-resource-usage-monitor-srum-afbadb1a375/">
            Digging into the System Resource Usage Monitor (SRUM)
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-12-08-velociraptor-to-elasticsearch-3a9fc02c6568/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-12-08-velociraptor-to-elasticsearch-3a9fc02c6568/">
            Velociraptor to Elasticsearch
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/" class="dd-item active">
        <div>
          <a href="/blog/medium/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/">
            Recovering deleted NTFS Files with Velociraptor
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-11-12_windows-event-logs-d8d8e615c9ca/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-11-12_windows-event-logs-d8d8e615c9ca/">
            Windows Event Logs
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/">
            Triage with Velociraptor — Pt 3
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-10-04_triage-with-velociraptor-pt-2-d0f79066ca0e/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-10-04_triage-with-velociraptor-pt-2-d0f79066ca0e/">
            Triage with Velociraptor — Pt 2
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-10-02_triage-with-velociraptor-pt-1-253f57ce96c0/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-10-02_triage-with-velociraptor-pt-1-253f57ce96c0/">
            Triage with Velociraptor — Pt 1
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-09-11_velociraptor-s-client-side-buffer-3ce03697a4e6/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-09-11_velociraptor-s-client-side-buffer-3ce03697a4e6/">
            Velociraptor’s client side buffer
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/training/" class="dd-item haschildren
        ">
      <div>
      <a href="/training/">Training Schedule</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/training/gold_coast_jan_20_2020/" class="dd-item
        ">
      <div>
      <a href="/training/gold_coast_jan_20_2020/">Gold Coast Velociraptor Training</a>
      </div>
    </li>
    <li data-nav-id="/training/online_oct_27_2020/" class="dd-item
        ">
      <div>
      <a href="/training/online_oct_27_2020/">Velociraptor training (Online Edition EMEA times)</a>
      </div>
    </li>
    <li data-nav-id="/training/online_february_2021/" class="dd-item
        ">
      <div>
      <a href="/training/online_february_2021/">Velociraptor training (Online Edition)</a>
      </div>
    </li>
    <li data-nav-id="/training/online_march_2_2021/" class="dd-item
        ">
      <div>
      <a href="/training/online_march_2_2021/">Velociraptor training (Online Edition)</a>
      </div>
    </li>
    <li data-nav-id="/training/online_oct_6_2020/" class="dd-item
        ">
      <div>
      <a href="/training/online_oct_6_2020/">Velociraptor training (Online Edition)</a>
      </div>
    </li>
    <li data-nav-id="/training/melbourne_march_2020/" class="dd-item
        ">
      <div>
      <a href="/training/melbourne_march_2020/">Velociraptor training in Melbourne, Australia</a>
      </div>
    </li>
    <li data-nav-id="/training/sydney_feb_2020/" class="dd-item
        ">
      <div>
      <a href="/training/sydney_feb_2020/">Velociraptor training in Sydney, Australia</a>
      </div>
    </li>
        </ul>
    </li>




    <hr />
    <li></li>

    </ul>

 <section id="footer">
    </section>
  </div>
</nav>



<section id="body">
<div id="overlay"></div>
<div class="padding highlightable">

  <div id="top-bar">
    <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
        <span id="sidebar-toggle-span">
          <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
            <i class="fa fa-bars"></i>
          </a>
        </span>
        <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
        <span class="links">
        







 <a href='/'>Velociraptor / Dig deeper</a> > <a href='/blog/'>Velociraptor Blog</a> > Recovering deleted NTFS Files with Velociraptor






        </span>
    </div>

    
    <div class="progress">
        <div class="wrapper">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>
</nav>
        </div>
    </div>
    

  </div>


<div id="body-inner">
  
      <h1>Recovering deleted NTFS Files with Velociraptor</h1>
      
        <h4 class="subtitle"> Deep forensics on the endpoint </h4>
      
  



    
    
    
    <h4 id="by-mike-cohen">By Mike Cohen</h4>
<p><img src="../img/1__UeLogCK7iLyCv__VWc7RMRA.jpeg" alt=""></p>
<p>On a recent engagement we responded to an intrusion where the attacker has added a new scheduled task to the Windows Task Scheduler directory (<em>%systemroot%\System32\Task</em>) some time ago. This is a common TTP for achieving persistence (See <a href="https://attack.mitre.org/techniques/T1053/">Mitre Att&amp;ck</a>). Unfortunately the actual task file was later removed and event logs were cycled past the time of interest.</p>
<p>In that case we were able to use Velociraptor to employ some deep forensic techniques and with a bit of luck were able to recover the deleted task file.</p>
<p>In this post I will explain the technique and demonstrate it on a deliberately deleted file. It should be noted that this technique relies on the file not being overwritten and the MFT entry not being reused by the system. So there is a rather large probability that it won’t work for any specific file. It is worth knowing though, just in case you get lucky and are able to recover a file critical to your incident!</p>
<h4 id="ntfs-and-the-master-filetable">NTFS and The Master File Table</h4>
<p>On Windows systems the most common filesystem is the NTFS filesystem. I won’t go into details about NTFS as there are many great references — the following description is extremely simplified and mentions just the concepts required to follow the discussion.</p>
<p>NTFS uses a large file called the $MFT — the master file table, containing the metadata of all files on the volume. This file is essentially an array of equal sized structures called MFT entries. Each entry has an MFT ID (which is the index of the entry in the array). Thus MFT Entry 0 is the first entry in the $MFT file, entry 100 is the 100th entry and so on.</p>
<p>Each file on disk is represented by one or more MFT entries. In NTFS, files contain multiple attributes, such as the file’s names (long name and/or short names) and standard information like timestamps etc. The file’s MFT entry contains information about the file’s attributes. One of the most important attributes for a file in NTFS is the $DATA attribute — which is also stored in the MFT entry for the file. The $DATA attribute contains the file’s runlist — essentially a list of clusters (disk sectors) containing the file’s actual data.</p>
<p>When a file is deleted, the MFT Entry for the file is marked as unallocated and is free to be used by the Operating System to store another file. If we are lucky though, the OS has not reused the MFT entry for the deleted file of interest, and we would be able to still read the data.</p>
<p>Additionally, when a file is deleted, the blocks that store the file’s data are also marked as unallocated, and are free for reuse — but they are not actually wiped and so might be available for recovery.</p>
<p>This post is about trying to recover such deleted files from NTFS. This is the realm of deep forensic analysis but Velociraptor allows us to perform this analysis instantly and remotely on the live system — giving a unique capability for recovering evidence of intrusions quickly and efficiently.</p>
<h4 id="scenario">Scenario</h4>
<p>To demonstrate this scenario I will create a file called “secret_file.txt”. I will paste a familiar text into the file. I will then delete the file and try to recover it using deep NTFS forensic analysis.</p>
<h4 id="the-setup">The setup</h4>
<p><img src="../img/1__WfcNInJv6JcYN2CL__dJAgg.png" alt=""></p>
<p>I will now dump the MFT from the endpoint by collecting the <strong>Windows.NTFS.MFT</strong> artifact.</p>
<p><img src="../img/1__g4O0YGpky5hH__P2TScT7zQ.png" alt=""></p>
<p>This artifact will cause the endpoint to parse the $MFT file and emit a single row for each MFT entry that represents a file on disk. The VQL Query shown above simply calls on the <em>parse_mft()</em> VQL plugin. Note that this is different than simply collecting the $MFT file as can be done with the <strong>Windows.KapeFiles.Targets</strong> artifact — in that case we still need to parse the $MFT with another tool. This time we parse the $MFT on the endpoint itself and simply stream the results to the server.</p>
<p>The nice thing about parsing the entire $MFT is that we now have a complete record of all files on the system (without having to walk directories etc). However this table is rather large! On my test system the produced CSV file is over 130mb in size (Being text it compresses really well though!).</p>
<h4 id="performance-check">Performance check</h4>
<p>This particular collection is rather heavy so I always check Velociraptor’s impact on the endpoint when I run such heavy collections. I simply open the <strong>Host Information</strong> screen and click the <strong>VQL Drilldown</strong> to see the client’s CPU and memory footprint as the query is running (Velociraptor collects its own footprint telemetry constantly).</p>
<p>In this case the query took around 5 minutes to fully complete, the CPU load spiked up to 150% for about 1 minute and the rest of the time was spent sending the large payload to the server with minimal CPU utilization. Top memory footprint was 120Mb for a few minutes falling to the baseline of 30mb quickly after the query completed.</p>
<p><img src="../img/1__HZsiiepiiL__PYUIz7zuHUA.png" alt=""></p>
<blockquote>
<p>If the collection was taking too long or using up too many resource on the endpoint, I can always cancel it by clicking the “Stop” button in the <strong>Collected Artifacts</strong> GUI. Velociraptor will immediately abort the query on the endpoint when the collection is cancelled in the GUI.</p>
</blockquote>
<h4 id="viewing-theresults">Viewing the results</h4>
<p>We can view the results of the query by clicking the Results tab. We see a number of useful columns including the EntryNumber (i.e. the MFT ID we discussed before), the InUse column indicates if the file is still in use or deleted as well as the full path of the file stored at that MFT ID. Note that this artifact simply prints the file stored at each consecutive MFT entry — there are over 255,000 rows in our example! (Not shown are created and modified timestamps as well for each file)</p>
<p><img src="../img/1__zKoK8jx__DiM17yhyDofLTQ.png" alt=""></p>
<p>The Velociraptor GUI only displays the first 500 rows from each artifact in order to keep the GUI fast and responsive. Because this query returned over 250k rows, we would need to download the data and post-process it. The easiest way is to prepare a download package and download it from the provided link. The CSV file can then be extracted and processed with other tools (e.g. grep or a database).</p>
<p><img src="../img/1__GWpawiYVVZxrUgkmD__moBg.png" alt=""></p>
<h4 id="tweaking-thequery">Tweaking the query</h4>
<p>In this exercise we already know the name of the file we are after is <strong>secret.txt</strong> so we do not really need a complete dump of the entire MFT — we only want all the MFT entries with the filename containing the word “secret”. We can therefore customize the artifact by adding a VQL <strong>WHERE</strong> clause after the query to only send interesting rows to the server. We will add a new parameter <strong>FullPathRegex</strong> allowing the user to customize the filtering terms in the future (for example search for deletions in the Tasks directory).</p>
<p><img src="../img/1__AQwNLywmhyRkWS4jwhzeow.png" alt=""></p>
<p>Now we can collect the customized artifact specifying that only rows matching “secret” will be retrieved.</p>
<p><img src="../img/1__yaJsmM9lSFeGU8xW__q5qmA.png" alt=""></p>
<p>The result is similar to the full dump above but now only 5 rows are returned from the endpoint. This is much faster than getting all 130mb CSV file and post processing it (Collection time is less than 1 minute now). By refining the artifact we have made Velociraptor more surgical in its approach — only returning the data we really want</p>
<p><img src="../img/1__hH7zhLQt__TK2JgWOVFvrDw.png" alt=""></p>
<p>We can see in the above that the file is deleted (InUse is false) and its EntryNumber is 86474. We can use this to try and recover the file’s data by collecting the <strong>Windows.NTFS.Recover</strong> artifact for this MFT entry</p>
<p><img src="../img/1__ndPT5EnGcAm5fJYaHmbcAg.png" alt=""></p>
<p>The <strong>Windows.NTFS.Recover</strong> simply uploads to the server all NTFS streams belonging to the MFT entry specified. We can see both $FILE_NAME attributes (long and short names) and the $DATA attribute.</p>
<p><img src="../img/1__OaIiPJRPjqFi75nqQ6pOZw.png" alt=""></p>
<p>Since the file is deleted, the MFT Entry is not allocated and a new file may be written in this MFT entry at any time. Therefore the contents of the $DATA stream may be completely unrelated to the file we are looking for. We can use the content of the $FILE_NAME and $STANDARD_INFORMATION to double check the validity of the file and confirm it is the file we expect.</p>
<p>To view the file we simple prepare a download as before and use an archiving tool to open the ZIP file. We then extract the $DATA stream and confirm it is the file we expected.</p>
<p><img src="../img/1__znDhPzuQ3Uy0hKkR0xPc7Q.png" alt="">
<img src="../img/1__Z__8h6SVkmkKVc6xSJlJtuA.png" alt=""></p>
<h4 id="conclusions">Conclusions</h4>
<p>Velociraptor provides access to low level NTFS analysis techniques within VQL. This means we can build VQL artifacts to automate some of the low level analysis — such as the recovery of deleted files, and scanning the MFT for remnants of old deleted files.</p>
<p>There are two pieces of information we can gather from such low level analysis:</p>
<ol>
<li>The deleted file metadata is found in the unallocated MFT entry and includes the file’s creation and modification timestamps.</li>
<li>The data of the file may still exist on disk.</li>
</ol>
<p>In practice, MFT entries are reused pretty quickly and so there is a high chance that the old deleted entry will not remain. Additionally $DATA blocks may also be reused so it is likely that even if we identify a deleted file we may not be able to recover its data using this technique.</p>
<p>So in practice, we use the <strong>Windows.NTFS.MFT</strong> artifact to collect metadata about deleted files, even though we are usually not able to recover their data.</p>
<p>If the system has an SSD rather than a spinning disk we are unlikely to recover any deleted file’s data. This is because SSDs aggressively reclaim unused blocks and wipe the block so it can be remapped in the wear leveling pool [see <a href="https://blog.elcomsoft.com/2019/01/life-after-trim-using-factory-access-mode-for-imaging-ssd-drives/">here</a>].</p>
<p>Do you commonly use this technique in your investigations? Share your thoughts below.</p>


    
    
          <footer class=" footline" >
	
</footer>
  </div>
</div>

<div id="navigation">
<a class="nav nav-prev" href="/blog/medium/2019-12-08-velociraptor-to-elasticsearch-3a9fc02c6568/" title="Velociraptor to Elasticsearch"> <i class="fa fa-chevron-left"></i><label>Velociraptor to Elasticsearch</label></a>
    <a class="nav nav-next" href="/blog/medium/2019-11-12_windows-event-logs-d8d8e615c9ca/" title="Windows Event Logs" style="margin-right: 0px;"><label>Windows Event Logs</label><i class="fa fa-chevron-right"></i></a></div>

</section>
<div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
  <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
</div>    

<script src="/js/clipboard.min.js"></script>
<script src="/js/featherlight.min.js"></script>
<script src="/js/html5shiv-printshiv.min.js"></script>

<script src="/js/modernizr.custom.71422.js"></script>
<script src="/js/docdock.js"></script>
<script src="/theme-original/script.js"></script>


    

    
    

    
  </body>
</html>