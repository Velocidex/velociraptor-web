<!DOCTYPE html>
<html>
  <head>
    <title>Velociraptor / Dig deeper</title>
    
      <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Server Artifacts :: Velociraptor / Dig deeper</title>
<link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link rel="stylesheet" href="/css/bootstrap.min.css">
<link href="/css/nucleus.css" rel="stylesheet">
<link href="/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/hybrid.css" rel="stylesheet">
<link href="/css/featherlight.min.css" rel="stylesheet">
<link href="/css/auto-complete.css" rel="stylesheet">
<link href="/theme-original/style.css" rel="stylesheet">

  <link href="/theme-original/variant-mine.css" rel="stylesheet">


<script src="/js/jquery-2.x.min.js"></script>
<style type="text/css">
  :root #header + #content > #left > #rlblock_left {
    display:none !important;
  }
</style>
<link rel="stylesheet" href="/css/theme-mine.css">
<script src="/js/custom.js"></script>


    
  </head>
  <body data-url="/docs/artifacts/server/">
    
      <div id="headermain"></div>
<nav id="sidebar" class="">



<div class="highlightable">
  <div id="header-wrapper">
    <div id="header">
      
	
  
    <a href="/">
  <img src="/images/logo.svg">
</a>

  


    </div>
        <div class="searchbox">
                    <label for="search-by"><i class="fa fa-search"></i></label>
                    <input data-search-input id="search-by" type="text" placeholder="Search...">
                    <span data-search-clear=""><i class="fa fa-close"></i></span>
                </div>
                <script type="text/javascript" src="/js/lunr.min.js"></script>
                <script type="text/javascript" src="/js/auto-complete.js"></script>
                <script type="text/javascript">
        
            var baseurl = "\/";
        
                </script>
                <script type="text/javascript" src="/js/search.js"></script>
  </div>

      <ul class="topics">
    <li data-nav-id="/about/" class="dd-item haschildren
        ">
      <div>
      <a href="/about/">About Velociraptor</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/about/features/" class="dd-item">
        <div>
          <a href="/about/features/">
            Velociraptor Features
          </a>
        </div>
    </li>
      <li data-nav-id="/about/license/" class="dd-item">
        <div>
          <a href="/about/license/">
            License
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/" class="dd-item parent haschildren
        ">
      <div>
      <a href="/docs/">Velociraptor Documentation</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/getting-started/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/getting-started/">Getting Started</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/getting-started/stand_alone/" class="dd-item
        ">
      <div>
      <a href="/docs/getting-started/stand_alone/">Standalone Deployment</a>
      </div>
    </li>
    <li data-nav-id="/docs/getting-started/deploying_clients/" class="dd-item
        ">
      <div>
      <a href="/docs/getting-started/deploying_clients/">Deploying Clients</a>
      </div>
    </li>
    <li data-nav-id="/docs/getting-started/cloud/" class="dd-item
        ">
      <div>
      <a href="/docs/getting-started/cloud/">Deploying in the cloud</a>
      </div>
    </li>
    <li data-nav-id="/docs/getting-started/performance/" class="dd-item
        ">
      <div>
      <a href="/docs/getting-started/performance/">Performance</a>
      </div>
    </li>
    <li data-nav-id="/docs/getting-started/triaging/" class="dd-item
        ">
      <div>
      <a href="/docs/getting-started/triaging/">Triaging</a>
      </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/user-interface/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/">User Interface</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/user-interface/investigating_clients/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/investigating_clients/">Investigating Clients</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/user-interface/investigating_clients/searching_clients/" class="dd-item
        ">
      <div>
      <a href="/docs/user-interface/investigating_clients/searching_clients/">Searching for clients</a>
      </div>
    </li>
    <li data-nav-id="/docs/user-interface/investigating_clients/virtual_filesystem/" class="dd-item
        ">
      <div>
      <a href="/docs/user-interface/investigating_clients/virtual_filesystem/">The Virtual File System</a>
      </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/user-interface/artifacts/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/artifacts/">Velociraptor Artifacts</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/user-interface/artifacts/client_artifacts/" class="dd-item
        ">
      <div>
      <a href="/docs/user-interface/artifacts/client_artifacts/">Client Artifacts</a>
      </div>
    </li>
    <li data-nav-id="/docs/user-interface/artifacts/client_events/" class="dd-item
        ">
      <div>
      <a href="/docs/user-interface/artifacts/client_events/">Client Event Artifacts</a>
      </div>
    </li>
    <li data-nav-id="/docs/user-interface/artifacts/server_artifacts/" class="dd-item
        ">
      <div>
      <a href="/docs/user-interface/artifacts/server_artifacts/">Server Artifacts</a>
      </div>
    </li>
    <li data-nav-id="/docs/user-interface/artifacts/server_events/" class="dd-item
        ">
      <div>
      <a href="/docs/user-interface/artifacts/server_events/">Server Event Artifacts</a>
      </div>
    </li>
    <li data-nav-id="/docs/user-interface/artifacts/add_artifacts/" class="dd-item
        ">
      <div>
      <a href="/docs/user-interface/artifacts/add_artifacts/">Customizing Artifacts</a>
      </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/user-interface/api/" class="dd-item
        ">
      <div>
      <a href="/docs/user-interface/api/">The Velociraptor API</a>
      </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/vql_reference/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/vql_reference/">VQL Reference</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/vql_reference/basic/" class="dd-item
        ">
      <div>
      <a href="/docs/vql_reference/basic/">Basic VQL functions and plugins</a>
      </div>
    </li>
    <li data-nav-id="/docs/vql_reference/windows/" class="dd-item
        ">
      <div>
      <a href="/docs/vql_reference/windows/">Windows Specific Functionality</a>
      </div>
    </li>
    <li data-nav-id="/docs/vql_reference/parsers/" class="dd-item
        ">
      <div>
      <a href="/docs/vql_reference/parsers/">Parsers and data extractors</a>
      </div>
    </li>
    <li data-nav-id="/docs/vql_reference/server/" class="dd-item
        ">
      <div>
      <a href="/docs/vql_reference/server/">Server Side Functionality</a>
      </div>
    </li>
    <li data-nav-id="/docs/vql_reference/plugin/" class="dd-item
        ">
      <div>
      <a href="/docs/vql_reference/plugin/">Client Side Functionality</a>
      </div>
    </li>
    <li data-nav-id="/docs/vql_reference/event/" class="dd-item
        ">
      <div>
      <a href="/docs/vql_reference/event/">Event Plugins</a>
      </div>
    </li>
    <li data-nav-id="/docs/vql_reference/experimental/" class="dd-item
        ">
      <div>
      <a href="/docs/vql_reference/experimental/">Experimental Functionality</a>
      </div>
    </li>
    <li data-nav-id="/docs/vql_reference/filesystem_accessors/" class="dd-item
        ">
      <div>
      <a href="/docs/vql_reference/filesystem_accessors/">Filesystem Accessors</a>
      </div>
    </li>
    <li data-nav-id="/docs/vql_reference/templates/" class="dd-item
        ">
      <div>
      <a href="/docs/vql_reference/templates/">Report Templates</a>
      </div>
    </li>
    <li data-nav-id="/docs/vql_reference/tips/" class="dd-item
        ">
      <div>
      <a href="/docs/vql_reference/tips/">Artifact Tips</a>
      </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/artifacts/" class="dd-item parent haschildren
        ">
      <div>
      <a href="/docs/artifacts/">Artifact Reference</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/artifacts/linux/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/linux/">Linux Artifacts</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/artifacts/windows_system/">Windows</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/artifacts/windows_system/events/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/events/">Event Logs</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/system/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/system/">System</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/registry/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/registry/">Registry</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/network/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/network/">Network</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/applications/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/applications/">Applications</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/detection/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/detection/">Malware Detection</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/triage/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/triage/">Triage Artifacts</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/remediation/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/remediation/">Remdiation</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/monitoring/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/monitoring/">Event Monitoring</a>
      </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/artifacts/server/" class="dd-item parent active
        ">
      <div>
      <a href="/docs/artifacts/server/">Server Artifacts</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/misc/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/misc/">Miscelaneous Artifacts</a>
      </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/presentations/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/presentations/">Presentations and Workshops</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/presentations/comfycon.2020/" class="dd-item
        ">
      <div>
      <a href="/docs/presentations/comfycon.2020/">Comfycon 2020</a>
      </div>
    </li>
    <li data-nav-id="/docs/presentations/training_2020/" class="dd-item
        ">
      <div>
      <a href="/docs/presentations/training_2020/">Enterprise Hunting and Incident Response with Velociraptor 2020</a>
      </div>
    </li>
    <li data-nav-id="/docs/presentations/linux.conf.au.2020/" class="dd-item
        ">
      <div>
      <a href="/docs/presentations/linux.conf.au.2020/">Linux.Conf.Au 2020</a>
      </div>
    </li>
    <li data-nav-id="/docs/presentations/sans_dfir_summit2019/" class="dd-item
        ">
      <div>
      <a href="/docs/presentations/sans_dfir_summit2019/">SANS Summit 2019</a>
      </div>
    </li>
    <li data-nav-id="/docs/presentations/rsa/" class="dd-item
        ">
      <div>
      <a href="/docs/presentations/rsa/">RSA Asia Pacific and Japan 2019</a>
      </div>
    </li>
    <li data-nav-id="/docs/presentations/crikeycon2019/" class="dd-item
        ">
      <div>
      <a href="/docs/presentations/crikeycon2019/">Crikeycon 2019 Training Workshop</a>
      </div>
    </li>
    <li data-nav-id="/docs/presentations/nzitf2018/" class="dd-item
        ">
      <div>
      <a href="/docs/presentations/nzitf2018/">New Zealand Internet Task Force Conference 2018</a>
      </div>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li data-nav-id="/blog/" class="dd-item haschildren
        ">
      <div>
      <a href="/blog/">Velociraptor Blog</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/blog/medium/2020-08-17-velociraptor-sso-authentication-6dd68d46dccf/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-08-17-velociraptor-sso-authentication-6dd68d46dccf/">
            Velociraptor SSO Authentication
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-08-16-profiling-the-beast-58913437fd16/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-08-16-profiling-the-beast-58913437fd16/">
            Profiling the beast
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-07-14-triage-with-velociraptor-pt-4-cf0e60810d1e/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-07-14-triage-with-velociraptor-pt-4-cf0e60810d1e/">
            Triage with Velociraptor — Pt 4
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-07-13-velociraptor-in-the-tool-age-d896dfe71b9/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-07-13-velociraptor-in-the-tool-age-d896dfe71b9/">
            Velociraptor in the tool age
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-06-19-the-velociraptor-query-language-pt-2-fe92bb7aa150/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-06-19-the-velociraptor-query-language-pt-2-fe92bb7aa150/">
            The Velociraptor Query Language Pt 2
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-06-14-the-velociraptor-query-language-pt-1-d721bff100bf/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-06-14-the-velociraptor-query-language-pt-1-d721bff100bf/">
            The Velociraptor Query Language Pt 1
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-04-16-velociraptor-e48a47e0317d/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-04-16-velociraptor-e48a47e0317d/">
            Velociraptor
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-03-29-velociraptors-acl-model-7f497575daee/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-03-29-velociraptors-acl-model-7f497575daee/">
            Velociraptor’s ACL model
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-03-28-velociraptor-notebooks-d02e0bd11230/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-03-28-velociraptor-notebooks-d02e0bd11230/">
            Velociraptor notebooks
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-03-07-extending-vql-plugins-7fb004cb6ec4/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-03-07-extending-vql-plugins-7fb004cb6ec4/">
            Extending VQL plugins
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-03-06-velociraptor-post-processing-with-jupyter-notebook-and-pandas-8a344d05ee8c/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-03-06-velociraptor-post-processing-with-jupyter-notebook-and-pandas-8a344d05ee8c/">
            Velociraptor Post-processing with Jupyter Notebook and Pandas
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2020-01-12_hunting-malware-using-mutants-ea08e86dfc19/" class="dd-item">
        <div>
          <a href="/blog/medium/2020-01-12_hunting-malware-using-mutants-ea08e86dfc19/">
            Hunting Malware using Mutants
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-12-31_digging-into-the-system-resource-usage-monitor-srum-afbadb1a375/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-12-31_digging-into-the-system-resource-usage-monitor-srum-afbadb1a375/">
            Digging into the System Resource Usage Monitor (SRUM)
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-12-08-velociraptor-to-elasticsearch-3a9fc02c6568/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-12-08-velociraptor-to-elasticsearch-3a9fc02c6568/">
            Velociraptor to Elasticsearch
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/">
            Recovering deleted NTFS Files with Velociraptor
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-11-12_windows-event-logs-d8d8e615c9ca/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-11-12_windows-event-logs-d8d8e615c9ca/">
            Windows Event Logs
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/">
            Triage with Velociraptor — Pt 3
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-10-04_triage-with-velociraptor-pt-2-d0f79066ca0e/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-10-04_triage-with-velociraptor-pt-2-d0f79066ca0e/">
            Triage with Velociraptor — Pt 2
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-10-02_triage-with-velociraptor-pt-1-253f57ce96c0/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-10-02_triage-with-velociraptor-pt-1-253f57ce96c0/">
            Triage with Velociraptor — Pt 1
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-09-11_velociraptor-s-client-side-buffer-3ce03697a4e6/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-09-11_velociraptor-s-client-side-buffer-3ce03697a4e6/">
            Velociraptor’s client side buffer
          </a>
        </div>
    </li>
        </ul>
    </li>




    <hr />
    <li></li>

    </ul>

 <section id="footer">
    </section>
  </div>
</nav>



<section id="body">
<div id="overlay"></div>
<div class="padding highlightable">

  <div id="top-bar">
    <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
        <span id="sidebar-toggle-span">
          <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
            <i class="fa fa-bars"></i>
          </a>
        </span>
        <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
        <span class="links">
        










 <a href='/'>Velociraptor / Dig deeper</a> > <a href='/docs/'>Velociraptor Documentation</a> > <a href='/docs/artifacts/'>Artifact Reference</a> > Server Artifacts








        </span>
    </div>

    
    <div class="progress">
        <div class="wrapper">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#serveralertspsexec">Server.Alerts.PsExec</a></li>
    <li><a href="#serveralertswinpmem">Server.Alerts.WinPmem</a></li>
    <li><a href="#serverhuntslist">Server.Hunts.List</a></li>
    <li><a href="#serverhuntsresults">Server.Hunts.Results</a></li>
    <li><a href="#serverinformationclients">Server.Information.Clients</a></li>
    <li><a href="#serverinformationusers">Server.Information.Users</a></li>
    <li><a href="#serverinternalartifactdescription">Server.Internal.ArtifactDescription</a></li>
    <li><a href="#serverinternalartifactmodification">Server.Internal.ArtifactModification</a></li>
    <li><a href="#serverinternalenrollment">Server.Internal.Enrollment</a></li>
    <li><a href="#serverinternalinterrogate">Server.Internal.Interrogate</a></li>
    <li><a href="#serverinternallabel">Server.Internal.Label</a></li>
    <li><a href="#serverinternalnotifications">Server.Internal.Notifications</a></li>
    <li><a href="#servermonitorhealth">Server.Monitor.Health</a></li>
    <li><a href="#servermonitorprofile">Server.Monitor.Profile</a></li>
    <li><a href="#servermonitorshell">Server.Monitor.Shell</a></li>
    <li><a href="#servermonitorvelometrics">Server.Monitor.VeloMetrics</a></li>
    <li><a href="#servermonitoringclientcount">Server.Monitoring.ClientCount</a></li>
    <li><a href="#serverpowershellencodedcommand">Server.Powershell.EncodedCommand</a></li>
    <li><a href="#serverutilscreatecollector">Server.Utils.CreateCollector</a></li>
    <li><a href="#systemflowarchive">System.Flow.Archive</a></li>
    <li><a href="#systemflowcompletion">System.Flow.Completion</a></li>
    <li><a href="#systemhuntparticipation">System.Hunt.Participation</a></li>
    <li><a href="#systemuploadcompletion">System.Upload.Completion</a></li>
    <li><a href="#systemvfsdownloadfile">System.VFS.DownloadFile</a></li>
    <li><a href="#systemvfslistdirectory">System.VFS.ListDirectory</a></li>
    <li><a href="#adminclientupgrade">Admin.Client.Upgrade</a></li>
    <li><a href="#admineventspostprocessuploads">Admin.Events.PostProcessUploads</a></li>
    <li><a href="#adminsystemcompressuploads">Admin.System.CompressUploads</a></li>
  </ul>
</nav>
        </div>
    </div>
    

  </div>


<div id="body-inner">
  
      <h1>Server Artifacts</h1>
      
        <h4 class="subtitle"> These artifacts are intended to run on the server. </h4>
      
  



    
    
    

<h2 id="serveralertspsexec">Server.Alerts.PsExec</h2>
<p>Send an email if execution of the psexec service was detected on
any client. This is a server side artifact.</p>
<p>Note this requires that the Windows.Event.ProcessCreation
monitoring artifact be collected from clients.</p>
<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>EmailAddress</td>
<td><a href="mailto:admin@example.com">admin@example.com</a></td>
<td></td>
</tr>
<tr>
<td>MessageTemplate</td>
<td>PsExec execution detected at %v: %v for client %v\ &hellip;</td>
<td></td>
</tr>
</tbody>
</table>
<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
          View Artifact Source
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">name: Server.Alerts.PsExec
description: |
   Send an email if execution of the psexec service was detected on
   any client. This is a server side artifact.

   Note this requires that the Windows.Event.ProcessCreation
   monitoring artifact be collected from clients.

type: SERVER_EVENT

parameters:
  - name: EmailAddress
    default: admin@example.com
  - name: MessageTemplate
    default: |
      PsExec execution detected at %v: %v for client %v

sources:
  - queries:
      - |
        SELECT * FROM foreach(
          row={
            SELECT * from watch_monitoring(
              artifact=&#39;Windows.Events.ProcessCreation&#39;)
            WHERE Name =~ &#39;(?i)psexesvc&#39;
          },
          query={
            SELECT * FROM mail(
              to=EmailAddress,
              subject=&#39;PsExec launched on host&#39;,
              period=60,
              body=format(
              format=MessageTemplate,
              args=[Timestamp, CommandLine, ClientId])
          )
        })
</code></pre></div>   </div>
</div>
<h2 id="serveralertswinpmem">Server.Alerts.WinPmem</h2>
<p>Send an email if the pmem service has been installed on any of the
endpoints.</p>
<p>Note this requires that the Windows.Event.ServiceCreation
monitoring artifact be collected from clients.</p>
<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>EmailAddress</td>
<td><a href="mailto:admin@example.com">admin@example.com</a></td>
<td></td>
</tr>
</tbody>
</table>
<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
          View Artifact Source
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">name: Server.Alerts.WinPmem
description: |
   Send an email if the pmem service has been installed on any of the
   endpoints.

   Note this requires that the Windows.Event.ServiceCreation
   monitoring artifact be collected from clients.

type: SERVER_EVENT

parameters:
  - name: EmailAddress
    default: admin@example.com

sources:
  - queries:
      - |
        SELECT * FROM foreach(
          row={
            SELECT * from watch_monitoring(
              artifact=&#39;Windows.Events.ServiceCreation&#39;)
            WHERE ServiceName =~ &#39;pmem&#39;
          },
          query={
            SELECT * FROM mail(
              to=EmailAddress,
              subject=&#39;Pmem launched on host&#39;,
              period=60,
              body=format(
                 format=&#34;WinPmem execution detected at %s for client %v&#34;,
                 args=[Timestamp, ClientId]
              )
          )
        })
</code></pre></div>   </div>
</div>
<h2 id="serverhuntslist">Server.Hunts.List</h2>
<p>List Hunts currently scheduled on the server.</p>
<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
          View Artifact Source
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">name: Server.Hunts.List
description: |
  List Hunts currently scheduled on the server.

type: SERVER

sources:
  - precondition:
      SELECT * from server_config

    query: |
      SELECT HuntId, timestamp(epoch=create_time/1000000) as Created,
             join(array=start_request.artifacts, sep=&#34;,&#34;) as Artifact,
             State
      FROM hunts()
</code></pre></div>   </div>
</div>
<h2 id="serverhuntsresults">Server.Hunts.Results</h2>
<p>Show the results from each artifact collection hunt.</p>
<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>huntId</td>
<td>H.d05b2482</td>
<td></td>
</tr>
<tr>
<td>ArtifactName</td>
<td>Linux.Mounts</td>
<td></td>
</tr>
</tbody>
</table>
<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
          View Artifact Source
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">name: Server.Hunts.Results
description: |
  Show the results from each artifact collection hunt.
parameters:
  - name: huntId
    default: H.d05b2482
  - name: ArtifactName
    default: Linux.Mounts

type: SERVER

sources:
  - precondition:
      SELECT * from server_config

    queries:
      - |
        SELECT * FROM hunt_results(hunt_id=huntId, artifact=ArtifactName)
</code></pre></div>   </div>
</div>
<h2 id="serverinformationclients">Server.Information.Clients</h2>
<p>This artifact returns the total list of clients, their hostnames and
the last times they were seen.</p>
<p>We also include a list of usernames on this machine, as gathered by
the last Windows.Sys.Users artifact that was collected. Note that
the list of usernames may be outdated if that artifact was not
collected recently.</p>
<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
          View Artifact Source
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">name: Server.Information.Clients
description: |
  This artifact returns the total list of clients, their hostnames and
  the last times they were seen.

  We also include a list of usernames on this machine, as gathered by
  the last Windows.Sys.Users artifact that was collected. Note that
  the list of usernames may be outdated if that artifact was not
  collected recently.

type: SERVER

sources:
  - queries:
      - |
        /* Collect information about each client. */
        LET client_info = SELECT client_id,
               os_info.fqdn as HostName,
               os_info.system as OS,
               os_info.release as Release,
               timestamp(epoch=last_seen_at/ 1000000).String as LastSeenAt,
               last_ip AS LastIP,
               last_seen_at AS _LastSeenAt
        FROM clients()
        ORDER BY _LastSeenAt DESC

      - |
        LET names = SELECT Name FROM Artifact.Server.Information.Users(
               ClientId=client_id)

      - |
        /* For each client, also list its users. */
        SELECT client_id,
               HostName, OS, Release, LastSeenAt, LastIP,
               join(array=names.Name, sep=&#34;,&#34;) AS Users
        FROM client_info
</code></pre></div>   </div>
</div>
<h2 id="serverinformationusers">Server.Information.Users</h2>
<p>List the user names and SIDs on each machine. We get this
information from the last time we collected Windows.Sys.Users. If we
never collected it for this machine, there will be no results.</p>
<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>ClientId</td>
<td>C.56a8dfd31eb1fa6f</td>
<td></td>
</tr>
<tr>
<td>StandardUserAccounts</td>
<td>(-5..$</td>
<td>S-1-5-18</td>
</tr>
</tbody>
</table>
<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
          View Artifact Source
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">name: Server.Information.Users
description: |
  List the user names and SIDs on each machine. We get this
  information from the last time we collected Windows.Sys.Users. If we
  never collected it for this machine, there will be no results.

type: SERVER

parameters:
  - name: ClientId
    default: C.56a8dfd31eb1fa6f

  - name: StandardUserAccounts
    description: Well known SIDs to hide from the output.
    default: &#34;(-5..$|S-1-5-18|S-1-5-19|S-1-5-20)&#34;

sources:
  - query: |
        // Get the most recent collection of our user listing.
        LET last_user_listing = SELECT session_id AS flow_id
           FROM flows(client_id=ClientId)
           WHERE artifacts_with_results =~&#39;Windows.Sys.Users&#39;
           ORDER BY LastActive
           DESC LIMIT 1

        /* For each Windows.Sys.Users collection, extract the user
           names, but hide standard SIDs.
        */
        SELECT * FROM foreach(
            row=last_user_listing,
            query={
              SELECT Name, UUID from source(
                 flow_id=flow_id,
                 artifact=&#39;Windows.Sys.Users&#39;,
                 client_id=ClientId)
              WHERE NOT UUID =~ StandardUserAccounts
            })
</code></pre></div>   </div>
</div>
<h2 id="serverinternalartifactdescription">Server.Internal.ArtifactDescription</h2>
<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
          View Artifact Source
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">name: Server.Internal.ArtifactDescription

type: INTERNAL

reports:
  - type: INTERNAL
    template: |
      {{ $artifact := Scope &#34;artifact&#34; }}

      ## {{ $artifact.Name }}

      #### Type: {{ $artifact.Type }}

      {{ if $artifact.Author }}
      ##### by {{ $artifact.Author }}
      {{end}}

      {{ $artifact.Description }}

      {{ if $artifact.Parameters }}

      ### Parameters

      &lt;table class=&#34;table table-striped table-hover&#34;&gt;
      &lt;thead&gt;
         &lt;tr&gt;
           &lt;th&gt;Name&lt;/th&gt;
           &lt;th&gt;Type&lt;/th&gt;
           &lt;th&gt;Default&lt;/th&gt;
         &lt;/tr&gt;
      &lt;/thead&gt;
      &lt;tbody&gt;
      {{- range $item := $artifact.Parameters -}}
         {{- if not (eq $item.Type &#34;hidden&#34;) -}}
           &lt;tr&gt;
               &lt;td&gt; {{ $item.Name }}&lt;/td&gt;
               &lt;td&gt;{{ $item.Type }}&lt;/td&gt;
               &lt;td&gt;&lt;pre&gt;{{ $item.Default }}&lt;/pre&gt;&lt;/td&gt;
           &lt;/tr&gt;
         {{- end -}}
      {{- end -}}
      &lt;/tbody&gt;&lt;/table&gt;

      {{ end }}

      {{ range $source := $artifact.Sources }}

      ### Source {{ $source.Name }}
      {{ if $source.Query }}

      ```vql
      {{ $source.Query }}
      ```

      {{- else -}}

      ```vql
      {{ range $query := $source.Queries -}}
      {{- $query -}}
      {{ end }}
      ```
      {{ end }}

      {{ end }}
</code></pre></div>   </div>
</div>
<h2 id="serverinternalartifactmodification">Server.Internal.ArtifactModification</h2>
<p>This event artifact is an internal event stream over which
notifications of artifact modifications are sent. Interested parties
can watch for new artifact modification events and rebuild caches
etc.</p>
<p>Note: This is an automated system artifact. You do not need to start it.</p>
<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
          View Artifact Source
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">name: Server.Internal.ArtifactModification
description: |
  This event artifact is an internal event stream over which
  notifications of artifact modifications are sent. Interested parties
  can watch for new artifact modification events and rebuild caches
  etc.

  Note: This is an automated system artifact. You do not need to start it.

type: SERVER_EVENT
</code></pre></div>   </div>
</div>
<h2 id="serverinternalenrollment">Server.Internal.Enrollment</h2>
<p>This event artifact is an internal event stream over which client
enrollments are sent. You can watch this event queue to be notified
on any new clients enrolling for the first time.</p>
<p>Note: This is an automated system artifact. You do not need to start it.</p>
<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
          View Artifact Source
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">name: Server.Internal.Enrollment
description: |
  This event artifact is an internal event stream over which client
  enrollments are sent. You can watch this event queue to be notified
  on any new clients enrolling for the first time.

  Note: This is an automated system artifact. You do not need to start it.

type: SERVER_EVENT
</code></pre></div>   </div>
</div>
<h2 id="serverinternalinterrogate">Server.Internal.Interrogate</h2>
<p>An internal artifact used track new client interrogations by the
Interrogation service.</p>
<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
          View Artifact Source
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">name: Server.Internal.Interrogate
description: |
  An internal artifact used track new client interrogations by the
  Interrogation service.

type: SERVER_EVENT

sources:
  - queries:
      - SELECT * FROM foreach(
          row={
             SELECT ClientId, Flow, FlowId
             FROM watch_monitoring(artifact=&#39;System.Flow.Completion&#39;)
             WHERE Flow.artifacts_with_results =~ &#39;Generic.Client.Info&#39;
          },
          query={
            SELECT * FROM switch(
              a={
                  SELECT ClientId,
                    FlowId,
                    Architecture,
                    BuildTime,
                    Fqdn,
                    Hostname,
                    KernelVersion,
                    Labels,
                    Name,
                    OS,
                    Platform,
                    PlatformVersion
                 FROM source(
                    client_id=ClientId,
                    flow_id=FlowId,
                    source=&#34;BasicInformation&#34;,
                    artifact=&#34;Custom.Generic.Client.Info&#34;,
                    mode=&#34;CLIENT&#34;)
               },
            b={
                SELECT ClientId,
                  FlowId,
                  Architecture,
                  BuildTime,
                  Fqdn,
                  Hostname,
                  KernelVersion,
                  Labels,
                  Name,
                  OS,
                  Platform,
                  PlatformVersion
               FROM source(
                  client_id=ClientId,
                  flow_id=FlowId,
                  source=&#34;BasicInformation&#34;,
                  artifact=&#34;Generic.Client.Info&#34;,
                  mode=&#34;CLIENT&#34;)
            })
          })
</code></pre></div>   </div>
</div>
<h2 id="serverinternallabel">Server.Internal.Label</h2>
<p>An internal artifact used to track new labeling events.</p>
<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
          View Artifact Source
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">name: Server.Internal.Label
description: |
  An internal artifact used to track new labeling events.

type: SERVER_EVENT
</code></pre></div>   </div>
</div>
<h2 id="serverinternalnotifications">Server.Internal.Notifications</h2>
<p>This event artifact is an internal event stream over which client
notifications are sent. A frontend will watch for events over this
stream and if a client is actively connected to this frontend, the
client will be notified that new work is available to it.</p>
<p>Note: This is an automated system artifact. You do not need to start it.</p>
<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
          View Artifact Source
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">name: Server.Internal.Notifications
description: |
  This event artifact is an internal event stream over which client
  notifications are sent. A frontend will watch for events over this
  stream and if a client is actively connected to this frontend, the
  client will be notified that new work is available to it.

  Note: This is an automated system artifact. You do not need to start it.

type: SERVER_EVENT
</code></pre></div>   </div>
</div>
<h2 id="servermonitorhealth">Server.Monitor.Health</h2>
<p>This is the main server health dashboard. It is shown on the
homescreen and enabled by default on all new installs.</p>
<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
          View Artifact Source
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">name: Server.Monitor.Health
description: |
  This is the main server health dashboard. It is shown on the
  homescreen and enabled by default on all new installs.

type: SERVER_EVENT

sources:
  - name: Prometheus

    # This artifact is populated by the frontend service using the
    # total of all frontend metrics.
    query: SELECT * FROM info() WHERE FALSE

reports:
  - type: SERVER_EVENT
    # Only allow the report to run for 10 seconds - this is plenty for
    # the GUI.
    timeout: 10
    parameters:
      - name: Sample
        default: &#34;4&#34;

    template: |
      {{ define &#34;CPU&#34; }}
          SELECT _ts as Timestamp,
              CPUPercent,
              MemoryUse / 1048576 AS MemoryUse
          FROM source(source=&#34;Prometheus&#34;,
                      artifact=&#34;Server.Monitor.Health&#34;)
      {{ end }}

      {{ define &#34;CurrentConnections&#34; }}
           SELECT * FROM sample(
             n=atoi(string=Sample),
             query={
               SELECT _ts as Timestamp,
                  client_comms_current_connections
               FROM source(source=&#34;Prometheus&#34;,
                           artifact=&#34;Server.Monitor.Health&#34;)
            })
      {{ end }}

      ## Server status

      The following are total across all frontends.

      &lt;span class=&#34;container&#34;&gt;
        &lt;span class=&#34;row&#34;&gt;
          &lt;span class=&#34;col-sm panel&#34;&gt;
           CPU and Memory Utilization
           {{ Query &#34;CPU&#34; | LineChart &#34;xaxis_mode&#34; &#34;time&#34; &#34;RSS.yaxis&#34; 2 }}
          &lt;/span&gt;
          &lt;span class=&#34;col-sm panel&#34;&gt;
           Currently Connected Clients
           {{ Query &#34;CurrentConnections&#34; | LineChart &#34;xaxis_mode&#34; &#34;time&#34; &#34;RSS.yaxis&#34; 2 }}
          &lt;/span&gt;
        &lt;/span&gt;
      &lt;/span&gt;


      ## Users

      {{ Query &#34;SELECT Name, Permissions FROM gui_users()&#34; | Table }}

      ## Server version

      {{ Query &#34;SELECT Version FROM server_config&#34; | Table }}
</code></pre></div>   </div>
</div>
<h2 id="servermonitorprofile">Server.Monitor.Profile</h2>
<p>This artifact collects profiling information from the running
server. This is useful when you notice a high CPU load in the server
and want to know why.</p>
<p>The following options are most useful:</p>
<ol>
<li>
<p>Goroutines: This shows the backtraces of all currently running
goroutines. It will generally show most of the code working in the
current running set of queries.</p>
</li>
<li>
<p>Heap: This shows all allocations currently in use and where they
are allocated from. This is useful if the server is taking too
much memory.</p>
</li>
<li>
<p>Profile: This takes a CPU profile of the running process for the
number of seconds specified in the Duration parameter. You can
read profiles using:</p>
</li>
</ol>
<pre><code>go tool pprof -callgrind -output=profile.grind profile.bin
kcachegrind profile.grind
</code></pre><table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Allocs</td>
<td></td>
<td>A sampling of all past memory allocations</td>
</tr>
<tr>
<td>Block</td>
<td></td>
<td>Stack traces that led to blocking on synchronization primitives</td>
</tr>
<tr>
<td>Goroutine</td>
<td></td>
<td>Stack traces of all current goroutines</td>
</tr>
<tr>
<td>Heap</td>
<td></td>
<td>A sampling of memory allocations of live objects</td>
</tr>
<tr>
<td>Mutex</td>
<td></td>
<td>Stack traces of holders of contended mutexes</td>
</tr>
<tr>
<td>Profile</td>
<td></td>
<td>CPU profile</td>
</tr>
<tr>
<td>Trace</td>
<td></td>
<td>CPU trace</td>
</tr>
<tr>
<td>Verbose</td>
<td></td>
<td>Print more detail</td>
</tr>
<tr>
<td>Duration</td>
<td>30</td>
<td>Duration of sampling for Profile and Trace.</td>
</tr>
</tbody>
</table>
<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
          View Artifact Source
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">name: Server.Monitor.Profile
description: |
  This artifact collects profiling information from the running
  server. This is useful when you notice a high CPU load in the server
  and want to know why.

  The following options are most useful:

  1. Goroutines: This shows the backtraces of all currently running
     goroutines. It will generally show most of the code working in the
     current running set of queries.

  2. Heap: This shows all allocations currently in use and where they
     are allocated from. This is useful if the server is taking too
     much memory.

  3. Profile: This takes a CPU profile of the running process for the
     number of seconds specified in the Duration parameter. You can
     read profiles using:

</code></pre></div><p>go tool pprof -callgrind -output=profile.grind profile.bin
kcachegrind profile.grind</p>
<pre><code>
type: SERVER

parameters:
- name: Allocs
  description: A sampling of all past memory allocations
  type: bool
- name: Block
  description: Stack traces that led to blocking on synchronization primitives
  type: bool
- name: Goroutine
  description: Stack traces of all current goroutines
  type: bool
- name: Heap
  description: A sampling of memory allocations of live objects
  type: bool
- name: Mutex
  description: Stack traces of holders of contended mutexes
  type: bool
- name: Profile
  description: CPU profile
  type: bool
- name: Trace
  description: CPU trace
  type: bool
- name: Verbose
  description: Print more detail
  type: bool
- name: Duration
  description: Duration of sampling for Profile and Trace.
  default: &quot;30&quot;

sources:
- query: |
    SELECT Type, upload(name=Type + &quot;.bin&quot;, file=FullPath) AS File
    FROM profile(allocs=Allocs, block=Block, goroutine=Goroutine,
                 heap=Heap, mutex=Mutex, profile=Profile, trace=Trace,
                 debug=if(condition=Verbose, then=2, else=1),
                 duration=atoi(string=Duration))
</code></pre>   </div>
</div>
<h2 id="servermonitorshell">Server.Monitor.Shell</h2>
<p>Velociraptor can get an interactive shell on the endpoint by using
the shell command. In order to use it, the user must be directly
logged on the server.</p>
<p>Obviously being able to run arbitrary commands on the end point is
a powerful feature and should be used sparingly. There is an audit
trail for shell commands executed and their output available by
streaming all shell commands to the &ldquo;Shell&rdquo; client evnt monitoring
artifact.</p>
<p>This server event artifact centralizes all shell access from all
clients into the same log file.</p>
<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
          View Artifact Source
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">name: Server.Monitor.Shell
description: |
   Velociraptor can get an interactive shell on the endpoint by using
   the shell command. In order to use it, the user must be directly
   logged on the server.

   Obviously being able to run arbitrary commands on the end point is
   a powerful feature and should be used sparingly. There is an audit
   trail for shell commands executed and their output available by
   streaming all shell commands to the &#34;Shell&#34; client evnt monitoring
   artifact.

   This server event artifact centralizes all shell access from all
   clients into the same log file.

# Can be CLIENT, EVENT, SERVER, SERVER_EVENT
type: SERVER_EVENT

sources:
  - query: |
      -- Watch for shell flow completions.
      LET collections = SELECT Flow
         FROM watch_monitoring(artifact=&#34;System.Flow.Completion&#34;)
         WHERE Flow.artifacts_with_results =~ &#34;Windows.System.PowerShell|Windows.System.CmdShell&#34;

      -- Dump the command and the results.
      SELECT * FROM foreach(row=collections,
      query={
         SELECT Flow.session_id AS FlowId,
             Flow.client_id AS ClientId,
             client_info(client_id=Flow.client_id).os_info.fqdn AS Hostname,
             timestamp(epoch=Flow.create_time / 1000000) AS Created,
             timestamp(epoch=Flow.active_time / 1000000) AS LastActive,
             Flow.request.parameters.env[0].value AS Command,
             Stdout, Stderr FROM source(
                 client_id=Flow.client_id,
                 flow_id=Flow.session_id,
                 artifact=Flow.artifacts_with_results[0])
      })


# Reports can be MONITORING_DAILY, CLIENT
reports:
  - type: SERVER_EVENT
    template: |
      {{ .Description }}

      {{ $rows := Query &#34;SELECT ClientId, Hostname, \
           timestamp(epoch=LastActive) AS Timestamp, Command, Stdout FROM source()&#34; }}

      {{ range $row := $rows }}

      * On {{ Get $row &#34;Timestamp&#34; }} we ran {{ Get $row &#34;Command&#34; }} on {{ Get $row &#34;Hostname&#34; }}

      ```text
      {{ Get $row &#34;Stdout&#34; }}
      ```

      {{end}}
</code></pre></div>   </div>
</div>
<h2 id="servermonitorvelometrics">Server.Monitor.VeloMetrics</h2>
<p>Get Velociraptor server metrics.</p>
<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>MetricsURL</td>
<td>http://localhost:8003/metrics</td>
<td></td>
</tr>
</tbody>
</table>
<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
          View Artifact Source
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">name: Server.Monitor.VeloMetrics
description: |
  Get Velociraptor server metrics.

type: SERVER

parameters:
  - name: MetricsURL
    default: http://localhost:8003/metrics

sources:
  - queries:
      - |
        LET stats = SELECT parse_string_with_regex(string=Content,
           regex=[
             &#39;client_comms_concurrency (?P&lt;client_comms_concurrency&gt;[^\\s]+)&#39;,
             &#39;client_comms_current_connections (?P&lt;client_comms_current_connections&gt;[^\\s]+)&#39;,
             &#39;flow_completion (?P&lt;flow_completion&gt;[^\\s]+)&#39;,
             &#39;process_open_fds (?P&lt;process_open_fds&gt;[^\\s]+)&#39;,
             &#39;uploaded_bytes (?P&lt;uploaded_bytes&gt;[^\\s]+)&#39;,
             &#39;uploaded_files (?P&lt;uploaded_files&gt;[^\\s]+)&#39;,
             &#39;stats_client_one_day_actives{version=&#34;[^&#34;]+&#34;} (?P&lt;one_day_active&gt;[^\\s]+)&#39;,
             &#39;stats_client_seven_day_actives{version=&#34;[^&#34;]+&#34;} (?P&lt;seven_day_active&gt;[^\\s]+)&#39;
           ]) AS Stat, {
              // On Windows Prometheus does not provide these so we get our own.
              SELECT Times.user + Times.system as CPU,
                     MemoryInfo.RSS as RSS
              FROM pslist(pid=getpid())
           } AS PslistStats
        FROM  http_client(url=MetricsURL, chunk_size=50000)

      - |
        SELECT now() AS Timestamp,
               PslistStats.RSS AS process_resident_memory_bytes,
               parse_float(string=Stat.client_comms_concurrency)
                      AS client_comms_concurrency,
               parse_float(string=Stat.client_comms_current_connections)
                      AS client_comms_current_connections,
               parse_float(string=Stat.flow_completion) AS flow_completion,
               parse_float(string=Stat.uploaded_bytes) AS uploaded_bytes,
               parse_float(string=Stat.uploaded_files) AS uploaded_files,
               parse_float(string=Stat.process_open_fds)
                     AS process_open_fds,
               PslistStats.CPU AS process_cpu_seconds_total,
               parse_float(string=Stat.one_day_active)
                     AS one_day_active,
               parse_float(string=Stat.seven_day_active)
                     AS seven_day_active
        FROM stats
</code></pre></div>   </div>
</div>
<h2 id="servermonitoringclientcount">Server.Monitoring.ClientCount</h2>
<p>An artifact that sends an email every hour of the current state of
the deployment.</p>
<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>EmailAddress</td>
<td><a href="mailto:admin@example.com">admin@example.com</a></td>
<td></td>
</tr>
<tr>
<td>CCAddress</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>Subject</td>
<td>Deployment statistics for Velociraptor</td>
<td></td>
</tr>
<tr>
<td>Period</td>
<td>3600</td>
<td></td>
</tr>
</tbody>
</table>
<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
          View Artifact Source
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">name: Server.Monitoring.ClientCount

description: |
   An artifact that sends an email every hour of the current state of
   the deployment.

type: SERVER_EVENT

parameters:
   - name: EmailAddress
     default: admin@example.com
   - name: CCAddress
     default:
   - name: Subject
     default: &#34;Deployment statistics for Velociraptor&#34;
   - name: Period
     default: &#34;3600&#34;

sources:
  - queries:
    - |
      LET metrics = SELECT * FROM Artifact.Server.Monitor.VeloMetrics()

    - |
      SELECT * FROM foreach(
        row={
            SELECT * FROM clock(period=atoi(string=Period))
        },
        query={
             SELECT * FROM mail(
                to=EmailAddress,
                cc=CCAddress,
                subject=Subject,
                period=60,
                body=format(format=&#39;Total clients currently connected %v&#39;,
                     args=[metrics.client_comms_current_connections])
            )
        })
</code></pre></div>   </div>
</div>
<h2 id="serverpowershellencodedcommand">Server.Powershell.EncodedCommand</h2>
<p>It is possible to pass powershell an encoded script. This artifact
decodes the scripts.</p>
<p>NOTE: The client must be running the Windows.Events.ProcessCreation
event artifact to retrieve process execution logs.</p>
<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
          View Artifact Source
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">name: Server.Powershell.EncodedCommand
description: |
  It is possible to pass powershell an encoded script. This artifact
  decodes the scripts.

  NOTE: The client must be running the Windows.Events.ProcessCreation
  event artifact to retrieve process execution logs.

type: SERVER_EVENT

sources:
  - queries:
     - |
       SELECT ClientId, ParentInfo, CommandLine, Timestamp, utf16(
          string=base64decode(
             string=parse_string_with_regex(
                string=CommandLine,
                regex=&#39;-((?i)(en|enc|encode|encodedCommand)) (?P&lt;Encoded&gt;[^ ]+)&#39;
             ).Encoded)) AS Script
        FROM watch_monitoring(artifact=&#39;Windows.Events.ProcessCreation&#39;)
        WHERE CommandLine =~ &#39;-(en|enc|encode|encodedCommand)&#39;

reports:
  - type: SERVER_EVENT
    template: |

      Encoded Powershell
      ==================

      {{ .Description }}

      ## Decoded Powershell commands.

      {{ Query &#34;SELECT ClientId, { SELECT os_info.Fqdn from clients(client_id=ClientId) } AS FQDN, Script FROM source()&#34; | Table }}
</code></pre></div>   </div>
</div>
<h2 id="serverutilscreatecollector">Server.Utils.CreateCollector</h2>
<p>A utility artifact to create a stand alone collector.</p>
<p>This artifact is actually invoked by the Offline collector GUI and
that is the recommended way to launch it. You can find the Offline
collector builder in the <code>Server Artifacts</code> section of the GUI.</p>
<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>OS</td>
<td>Windows</td>
<td></td>
</tr>
<tr>
<td>artifacts</td>
<td>[&ldquo;Generic.Client.Info&rdquo;]\n</td>
<td>A list of artifacts to collect</td>
</tr>
<tr>
<td>template</td>
<td>Reporting.Default</td>
<td>The HTML report template to use.</td>
</tr>
<tr>
<td>Password</td>
<td></td>
<td>If set we encrypt collected zip files with this password.</td>
</tr>
<tr>
<td>parameters</td>
<td>{}\n</td>
<td>A dict containing the parameters to set.</td>
</tr>
<tr>
<td>target</td>
<td>ZIP</td>
<td>Output type</td>
</tr>
<tr>
<td>target_args</td>
<td>{}</td>
<td>Type Dependent args</td>
</tr>
<tr>
<td>FetchBinaryOverride</td>
<td>LET temp_binary &lt;= tempfile(extension=&quot;.exe&quot;,\n    &hellip;</td>
<td>A replacement for Generic.Utils.FetchBinary which\ngrabs files from the local archive.\n</td>
</tr>
</tbody>
</table>
<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
          View Artifact Source
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">name: Server.Utils.CreateCollector
description: |
  A utility artifact to create a stand alone collector.

  This artifact is actually invoked by the Offline collector GUI and
  that is the recommended way to launch it. You can find the Offline
  collector builder in the `Server Artifacts` section of the GUI.

type: SERVER

tools:
  - name: VelociraptorWindows
    github_project: Velocidex/velociraptor
    github_asset_regex: windows-amd64.exe
    serve_locally: true

  - name: VelociraptorWindows_x86
    github_project: Velocidex/velociraptor
    github_asset_regex: windows-386.exe
    serve_locally: true

  - name: VelociraptorLinux
    github_project: Velocidex/velociraptor
    github_asset_regex: linux-amd64
    serve_locally: true

  - name: VelociraptorDarwin
    github_project: Velocidex/velociraptor
    github_asset_regex: darwin-amd64
    serve_locally: true

parameters:
  - name: OS
    default: Windows
    type: choices
    choices:
      - Windows
      - Linux
      - MacOS

  - name: artifacts
    description: A list of artifacts to collect
    type: json_array
    default: |
      [&#34;Generic.Client.Info&#34;]

  - name: template
    default: Reporting.Default
    description: The HTML report template to use.

  - name: Password
    description: If set we encrypt collected zip files with this password.

  - name: parameters
    description: A dict containing the parameters to set.
    type: json
    default: |
      {}

  - name: target
    description: Output type
    type: choices
    default: ZIP
    choices:
      - ZIP
      - GCS
      - S3

  - name: target_args
    description: Type Dependent args
    type: json
    default: &#34;{}&#34;

  - name: StandardCollection
    type: hidden
    default: |
      LET Artifacts &lt;= parse_json_array(data=Artifacts)
      LET Parameters &lt;= parse_json(data=Parameters)
      LET baseline &lt;= SELECT Fqdn FROM info()

      // Make the filename safe on windows.
      LET filename &lt;= regex_replace(
          source=format(format=&#34;Collection-%s-%s&#34;,
                        args=[baseline[0].Fqdn, timestamp(epoch=now())]),
          re=&#34;[^0-9A-Za-z\\-.]&#34;, replace=&#34;_&#34;)

      LET _ &lt;= log(message=&#34;Will collect package &#34; + filename)

      SELECT * FROM collect(artifacts=Artifacts, report=filename + &#34;.html&#34;,
          args=Parameters, output=filename + &#34;.zip&#34;, template=Template,
          password=Password)

  - name: S3Collection
    type: hidden
    default: |
      LET Artifacts &lt;= parse_json_array(data=Artifacts)
      LET Parameters &lt;= parse_json(data=Parameters)
      LET baseline &lt;= SELECT Fqdn FROM info()
      LET TargetArgs &lt;= parse_json(data=target_args)

      // Make the filename safe on windows.
      LET filename &lt;= regex_replace(
          source=format(format=&#34;Collection-%s-%s&#34;,
                        args=[baseline[0].Fqdn, timestamp(epoch=now())]),
          re=&#34;[^0-9A-Za-z\\-.]&#34;, replace=&#34;_&#34;)

      LET _ &lt;= log(message=&#34;Will collect package &#34; + filename +
         &#34; and upload to s3 bucket &#34; + TargetArgs.bucket)

      SELECT upload_s3(file=Container,
          bucket=TargetArgs.bucket,
          name=filename + &#34;.zip&#34;,
          credentialskey=TargetArgs.credentialsKey,
          credentialssecret=TargetArgs.credentialsSecret,
          region=TargetArgs.region) AS Upload,
       upload_s3(file=Report,
          bucket=TargetArgs.bucket,
          name=filename + &#34;.html&#34;,
          credentialskey=TargetArgs.credentialsKey,
          credentialssecret=TargetArgs.credentialsSecret,
          region=TargetArgs.region) AS ReportUpload
      FROM collect(artifacts=Artifacts, report=tempfile(extension=&#34;.html&#34;),
          args=Parameters, output=tempfile(extension=&#34;.zip&#34;), template=Template,
          password=Password)

  - name: GCSCollection
    type: hidden
    default: |
      LET Artifacts &lt;= parse_json_array(data=Artifacts)
      LET Parameters &lt;= parse_json(data=Parameters)
      LET baseline &lt;= SELECT Fqdn FROM info()
      LET TargetArgs &lt;= parse_json(data=target_args)
      LET GCSBlob &lt;= parse_json(data=TargetArgs.GCSKey)

      // Make the filename safe on windows.
      LET filename &lt;= regex_replace(
          source=format(format=&#34;Collection-%s-%s&#34;,
                        args=[baseline[0].Fqdn, timestamp(epoch=now())]),
          re=&#34;[^0-9A-Za-z\\-.]&#34;, replace=&#34;_&#34;)

      LET _ &lt;= log(message=&#34;Will collect package &#34; + filename +
         &#34; and upload to GCS bucket &#34; + TargetArgs.bucket)

      SELECT upload_gcs(file=Container,
          bucket=TargetArgs.bucket,
          project=GCSBlob.project_id,
          name=filename + &#34;.zip&#34;,
          credentials=TargetArgs.GCSKey
      ) AS Upload,
      upload_gcs(file=Report,
          bucket=TargetArgs.bucket,
          project=GCSBlob.project_id,
          name=filename + &#34;.html&#34;,
          credentials=TargetArgs.GCSKey
      ) AS ReportUpload
      FROM collect(artifacts=Artifacts, report=tempfile(extension=&#34;.html&#34;),
          args=Parameters, output=tempfile(extension=&#34;.zip&#34;), template=Template,
          password=Password)

  - name: PackageToolsArtifact
    description: Collects and uploads third party binaries.
    type: hidden
    default: |
      name: PackageToolsArtifact
      parameters:
       - name: Binaries
      sources:
       - query: |
          LET temp &lt;= tempfile()

          LET uploader = SELECT ToolName,
                                Upload.Path AS Filename,
                                Upload.sha256 AS ExpectedHash,
                                Upload.Size AS Size
          FROM foreach(row=Binaries,
            query={
              SELECT _value AS ToolName, upload(file=FullPath, name=Name) AS Upload
              FROM Artifact.Generic.Utils.FetchBinary(
                   ToolName=_value, SleepDuration=&#39;0&#39;,
                   ToolInfo=inventory_get(tool=_value))
            })

          // Flush the entire query into the inventory file.
          LET _ &lt;= SELECT * FROM write_csv(filename=temp, query=uploader)

          // Now upload it.
          SELECT upload(file=temp, name=&#34;inventory.csv&#34;) FROM scope()

  - name: FetchBinaryOverride
    description: |
       A replacement for Generic.Utils.FetchBinary which
       grabs files from the local archive.

    default: |
       LET temp_binary &lt;= tempfile(extension=&#34;.exe&#34;,
                remove_last=TRUE, permissions=&#34;x&#34;)

       LET matching_tools = SELECT ToolName AS ArchiveTool, Filename
       FROM parse_csv(filename=&#34;/inventory.csv&#34;, accessor=&#34;me&#34;)

       SELECT * FROM foreach(row=matching_tools, query={
         SELECT copy(filename=Filename, accessor=&#34;me&#34;, dest=temp_binary) AS FullPath,
                     Filename AS Name
         FROM scope()
         WHERE ToolName = ArchiveTool
       })

sources:
  - query: |
      LET Payload &lt;= tempfile(extension=&#34;.zip&#34;)
      LET Artifacts &lt;= parse_json_array(data=artifacts)

      LET Binaries &lt;= SELECT * FROM foreach(
          row={
             SELECT tools FROM artifact_definitions(names=Artifacts)
          }, query={
             SELECT * FROM foreach(row=tools,
             query={
              SELECT name AS Binary FROM scope()
             })
          }) GROUP BY Binary

      // Create a zip file with the binaries in it.
      LET _ &lt;= SELECT * FROM collect(artifacts=&#34;PackageToolsArtifact&#34;,
         output=Payload, args=dict(Binaries=Binaries.Binary),
         artifact_definitions=PackageToolsArtifact)

      LET CollectionArtifact &lt;= SELECT Value FROM switch(
        a = { SELECT StandardCollection AS Value FROM scope() WHERE target = &#34;ZIP&#34; },
        b = { SELECT S3Collection AS Value  FROM scope() WHERE target = &#34;S3&#34; },
        c = { SELECT GCSCollection AS Value  FROM scope() WHERE target = &#34;GCS&#34; },
        d = { SELECT &#34;&#34; AS Value  FROM scope() WHERE log(message=&#34;Unknown collection type &#34; + target) }
      )

      LET definitions &lt;= SELECT * FROM chain(
      a = { SELECT name, description, parameters, sources, reports
            FROM artifact_definitions(names=Artifacts + template)
            WHERE name =~ &#34;^(Custom|Packs)\\.&#34; AND
              log(message=&#34;Adding artifact_definition for &#34; + name) },

      b = { SELECT &#34;Collector&#34; AS name, (
                    dict(name=&#34;Artifacts&#34;, default=artifacts),
                    dict(name=&#34;Parameters&#34;, default=parameters),
                    dict(name=&#34;Template&#34;, default=template),
                    dict(name=&#34;Password&#34;, default=Password),
                    dict(name=&#34;target_args&#34;, default=target_args),
                ) AS parameters,
                (
                  dict(query=CollectionArtifact[0].Value),
                ) AS sources
            FROM scope() },
      c = { SELECT &#34;Generic.Utils.FetchBinary&#34; AS name,
            (
               dict(name=&#34;SleepDuration&#34;),
               dict(name=&#34;ToolName&#34;),
            ) AS parameters,
            (
               dict(query=FetchBinaryOverride),
            ) AS sources FROM scope()  }
      )

      // Build the autoexec config file depending on the user&#39;s
      // collection type choices.
      LET autoexec &lt;= dict(autoexec=dict(
          argv=[&#34;artifacts&#34;, &#34;collect&#34;, &#34;-v&#34;, &#34;Collector&#34;],
          artifact_definitions=definitions)
      )

      // Get some tempfiles to work with.
      LET Config &lt;= tempfile()
      LET Destination &lt;= tempfile()

      // Choose the right target binary depending on the target OS
      LET tool_name = SELECT * FROM switch(
       a={ SELECT &#34;VelociraptorWindows&#34; AS Type FROM scope() WHERE OS = &#34;Windows&#34;},
       b={ SELECT &#34;VelociraptorWindows_x86&#34; AS Type FROM scope() WHERE OS = &#34;Windows_x86&#34;},
       c={ SELECT &#34;VelociraptorLinux&#34; AS Type FROM scope() WHERE OS = &#34;Linux&#34;},
       d={ SELECT &#34;VelociraptorDarwin&#34; AS Type FROM scope() WHERE OS = &#34;MacOS&#34;},
       e={ SELECT &#34;&#34; AS Type FROM scope()
           WHERE NOT log(message=&#34;Unknown target type &#34; + OS) }
      )

      // Repack this binary.
      LET target_binary &lt;= SELECT FullPath, Name
         FROM Artifact.Generic.Utils.FetchBinary(
            ToolName=tool_name[0].Type, SleepDuration=&#34;0&#34;,
            ToolInfo=inventory_get(tool=tool_name[0].Type))
         WHERE log(message=&#34;Target binary &#34; + Name + &#34; is at &#34; + FullPath)

      LET me &lt;= SELECT Exe FROM info()

      // Copy the configuration to a temp file and shell out to our
      // binary to repack it.
      LET repack_step = SELECT upload(
           file=Destination,
           accessor=&#34;file&#34;,
           name=format(format=&#39;Collector_%v&#39;, args=[target_binary[0].Name, ])) AS Binary,
           timestamp(epoch=now()) As CreationTime
      FROM execve(argv=[
        me[0].Exe, &#34;config&#34;, &#34;repack&#34;,
        &#34;--exe&#34;, target_binary[0].FullPath,
        &#34;--append&#34;, Payload,
        copy(dest=Config,
             accessor=&#39;data&#39;,
             filename=serialize(format=&#39;json&#39;, item=autoexec)),
        Destination ], length=1000000)
      WHERE log(message=&#34;Creating config on &#34; + Config) AND log(message=Stderr)

      // Only actually run stuff if everything looks right.
      SELECT * FROM if(condition=autoexec AND target_binary AND me[0].Exe,
         then=repack_step)
</code></pre></div>   </div>
</div>
<h2 id="systemflowarchive">System.Flow.Archive</h2>
<p>An internal artifact that produces events for every flow completion
in the system.</p>
<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
          View Artifact Source
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">name: System.Flow.Archive
description: |
  An internal artifact that produces events for every flow completion
  in the system.

type: CLIENT_EVENT
</code></pre></div>   </div>
</div>
<h2 id="systemflowcompletion">System.Flow.Completion</h2>
<p>An internal artifact that produces events for every flow completion
in the system.</p>
<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
          View Artifact Source
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">name: System.Flow.Completion
description: |
  An internal artifact that produces events for every flow completion
  in the system.

type: CLIENT_EVENT
</code></pre></div>   </div>
</div>
<h2 id="systemhuntparticipation">System.Hunt.Participation</h2>
<p>Endpoints may participate in hunts. This artifact collects which hunt
each system participated in.</p>
<p>Note: This is an automated system artifact. You do not need to start it.</p>
<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
          View Artifact Source
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">name: System.Hunt.Participation
description: |
     Endpoints may participate in hunts. This artifact collects which hunt
     each system participated in.

     Note: This is an automated system artifact. You do not need to start it.

type: CLIENT_EVENT

reports:
  - type: MONITORING_DAILY
    template: |
      {{ define &#34;all_hunts&#34; }}LET allhunts &lt;= SELECT * FROM hunts(){{ end }}
      {{ define &#34;hunts&#34; }}
           SELECT * FROM foreach(
             row={ SELECT timestamp(epoch=Timestamp) AS Scheduled,
                          HuntId as ParticipatedHuntId
                   FROM source(client_id=ClientId,
                       artifact=&#39;System.Hunt.Participation&#39;) },
             query={
                SELECT Scheduled,
                       hunt_id,
                       hunt_description,
                       start_request.artifacts
                FROM allhunts
                WHERE hunt_id = ParticipatedHuntId
             })
      {{ end }}

      {{ $client_info := Query &#34;SELECT * FROM clients(client_id=ClientId) LIMIT 1&#34; }}

      # Hunt participation for {{ Get $client_info &#34;0.os_info.fqdn&#34; }}

      The client with a client ID of {{ Get $client_info &#34;0.client_id&#34; }} participated in some hunts today.

      {{ Query &#34;all_hunts&#34; &#34;hunts&#34; | Table }}

      ## VQL Query
      The following VQL query was used to plot the graph above.

      ```sql
      {{ template &#34;hunts&#34; }}
      ```
</code></pre></div>   </div>
</div>
<h2 id="systemuploadcompletion">System.Upload.Completion</h2>
<p>An internal artifact that produces events for every file that is
uploaded to the system.</p>
<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
          View Artifact Source
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">name: System.Upload.Completion
description: |
  An internal artifact that produces events for every file that is
  uploaded to the system.

type: CLIENT_EVENT
</code></pre></div>   </div>
</div>
<h2 id="systemvfsdownloadfile">System.VFS.DownloadFile</h2>
<p>This is an internal artifact used by the GUI to populate the
VFS. You may run it manually if you like, but typically it is
launched by the GUI when the user clicks the &ldquo;Collect from client&rdquo;
button at the file &ldquo;Stats&rdquo; tab.</p>
<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Path</td>
<td>/</td>
<td>The path of the file to download.</td>
</tr>
<tr>
<td>Accessor</td>
<td>file</td>
<td></td>
</tr>
</tbody>
</table>
<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
          View Artifact Source
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">name: System.VFS.DownloadFile
description: |
  This is an internal artifact used by the GUI to populate the
  VFS. You may run it manually if you like, but typically it is
  launched by the GUI when the user clicks the &#34;Collect from client&#34;
  button at the file &#34;Stats&#34; tab.

parameters:
  - name: Path
    description: The path of the file to download.
    default: /
  - name: Accessor
    default: file

sources:
  - queries:
      - SELECT Path, Accessor, Size, StoredSize, Error, Sha256, Md5
        FROM upload(files=Path, accessor=Accessor)
</code></pre></div>   </div>
</div>
<h2 id="systemvfslistdirectory">System.VFS.ListDirectory</h2>
<p>This is an internal artifact used by the GUI to populate the
VFS. You may run it manually if you like, but typically it is
launched by the GUI when a user clicks the &ldquo;Refresh this directory&rdquo;
button.</p>
<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Path</td>
<td>/</td>
<td>The path of the file to download.</td>
</tr>
<tr>
<td>Accessor</td>
<td>file</td>
<td></td>
</tr>
<tr>
<td>Depth</td>
<td>0</td>
<td></td>
</tr>
</tbody>
</table>
<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
          View Artifact Source
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">name: System.VFS.ListDirectory
description: |
  This is an internal artifact used by the GUI to populate the
  VFS. You may run it manually if you like, but typically it is
  launched by the GUI when a user clicks the &#34;Refresh this directory&#34;
  button.

parameters:
  - name: Path
    description: The path of the file to download.
    default: &#34;/&#34;

  - name: Accessor
    default: file

  - name: Depth
    default: 0

sources:
  - query: |
      // Old versions do not have the root parameter to glob()
      // Fixes https://github.com/Velocidex/velociraptor/issues/322
      LET LegacyQuery = SELECT FullPath as _FullPath,
           Accessor as _Accessor,
           Data as _Data,
           Name, Size, Mode.String AS Mode,
           Mtime as mtime,
           Atime as atime,
           Ctime as ctime
        FROM glob(globs=Path + if(condition=atoi(string=Depth),
             then=&#39;/**&#39; + Depth, else=&#39;/*&#39;),
             accessor=Accessor)

      LET NewQuery = SELECT FullPath as _FullPath,
           Accessor as _Accessor,
           Data as _Data,
           Name, Size, Mode.String AS Mode,
           Mtime as mtime,
           Atime as atime,
           Ctime as ctime
        FROM glob(globs=if(condition=atoi(string=Depth),
             then=&#39;/**&#39; + Depth, else=&#39;/*&#39;),
             root=Path,
             accessor=Accessor)

      SELECT * FROM if(
       condition=version(plugin=&#34;glob&#34;) &gt;= 1,
       then=NewQuery,
       else=LegacyQuery)
</code></pre></div>   </div>
</div>
<h2 id="adminclientupgrade">Admin.Client.Upgrade</h2>
<p>Remotely push new client updates.</p>
<p>NOTE: The updates can be pulled from any web server. You need to
ensure they are properly secured with SSL and at least a random
nonce in their path. You may configure the Velociraptor server to
serve these through the public directory. Simply place the MSI in
the public directory within the data store and set the URL below.</p>
<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>clientURL</td>
<td>http://127.0.0.1:8000/public/velociraptor.msi</td>
<td>The URL to fetch the MSI package.</td>
</tr>
</tbody>
</table>
<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
          View Artifact Source
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">name: Admin.Client.Upgrade
description: |
  Remotely push new client updates.

  NOTE: The updates can be pulled from any web server. You need to
  ensure they are properly secured with SSL and at least a random
  nonce in their path. You may configure the Velociraptor server to
  serve these through the public directory. Simply place the MSI in
  the public directory within the data store and set the URL below.

required_permissions:
  - EXECVE

parameters:
  - name: clientURL
    description: The URL to fetch the MSI package.
    default: http://127.0.0.1:8000/public/velociraptor.msi

sources:
  - precondition:
      SELECT OS From info() where OS = &#39;windows&#39;
    queries:
      # Wait a random amount of time so this can be run in a
      # hunt. Otherwise all clients will attempt to download the same
      # file at the same time probably overloading the server.
      - LET _ &lt;= SELECT sleep(time=rand(range=600)) FROM scope()

      - SELECT * from foreach(
         row={
            SELECT Content AS Binary
            FROM http_client(url=clientURL, tempfile_extension=&#34;.msi&#34;)
         },
         query={
            SELECT * from execve(
               argv=[&#34;msiexec.exe&#34;, &#34;/i&#34;, Binary]
            )
         })
</code></pre></div>   </div>
</div>
<h2 id="admineventspostprocessuploads">Admin.Events.PostProcessUploads</h2>
<p>Sometimes we would like to post process uploads collected as part of
the hunt&rsquo;s artifact collections</p>
<p>Post processing means to watch the hunt for completed flows and run
a post processing command on the files obtained from each host.</p>
<p>The command will receive the list of paths of the files uploaded by
the artifact. We dont actually care what the command does with those
files - we will just relay our stdout/stderr to the artifact&rsquo;s
result set.</p>
<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>uploadPostProcessCommand</td>
<td>[&quot;/bin/ls&quot;, &ldquo;-l&rdquo;]\n</td>
<td>The command to run - must be a json array of strings! The list\nof files will be appended to the end of the command.\n</td>
</tr>
<tr>
<td>uploadPostProcessArtifact</td>
<td>Windows.Registry.NTUser.Upload</td>
<td>The name of the artifact to watch.\n</td>
</tr>
</tbody>
</table>
<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
          View Artifact Source
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">name: Admin.Events.PostProcessUploads
description: |
  Sometimes we would like to post process uploads collected as part of
  the hunt&#39;s artifact collections

  Post processing means to watch the hunt for completed flows and run
  a post processing command on the files obtained from each host.

  The command will receive the list of paths of the files uploaded by
  the artifact. We dont actually care what the command does with those
  files - we will just relay our stdout/stderr to the artifact&#39;s
  result set.

type: SERVER_EVENT

required_permissions:
  - EXECVE

parameters:
  - name: uploadPostProcessCommand
    description: |
      The command to run - must be a json array of strings! The list
      of files will be appended to the end of the command.
    default: |
      [&#34;/bin/ls&#34;, &#34;-l&#34;]

  - name: uploadPostProcessArtifact
    description: |
      The name of the artifact to watch.
    default: Windows.Registry.NTUser.Upload

sources:
  - precondition:
      SELECT server_config FROM scope()
    queries:
      - |
        LET files = SELECT Flow,
            array(a1=parse_json_array(data=uploadPostProcessCommand),
                  a2=file_store(path=Flow.uploaded_files)) as Argv
        FROM watch_monitoring(artifact=&#39;System.Flow.Completion&#39;)
        WHERE uploadPostProcessArtifact in Flow.artifacts_with_results

      - |
        SELECT * from foreach(
          row=files,
          query={
             SELECT Flow.session_id as FlowId, Argv,
                    Stdout, Stderr, ReturnCode
             FROM execve(argv=Argv)
          })
</code></pre></div>   </div>
</div>
<h2 id="adminsystemcompressuploads">Admin.System.CompressUploads</h2>
<p>Compresses all uploaded files.</p>
<p>When artifacts collect files they are normally stored on the server
uncompressed. This artifact watches all completed flows and
compresses the files in the file store when the flow completes. This
is very useful for cloud based deployments with limited storage
space or when collecting large files.</p>
<p>In order to run this artifact you would normally run it as part of
an artifact acquisition process:</p>
<pre><code>$ velociraptor --config /etc/server.config.yaml artifacts acquire Admin.System.CompressUploads
</code></pre><p>Note that there is nothing special about compressed files - you can
also just run <code>find</code> and <code>gzip</code> in the file store. Velociraptor will
automatically decompress the file when displaying it in the GUI
text/hexdump etc.</p>
<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>blacklistCompressionFilename</td>
<td>(?i).+ntuser.dat</td>
<td>Filenames which match this regex will be excluded from compression.</td>
</tr>
</tbody>
</table>
<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
          View Artifact Source
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">name: Admin.System.CompressUploads
description: |
  Compresses all uploaded files.

  When artifacts collect files they are normally stored on the server
  uncompressed. This artifact watches all completed flows and
  compresses the files in the file store when the flow completes. This
  is very useful for cloud based deployments with limited storage
  space or when collecting large files.

  In order to run this artifact you would normally run it as part of
  an artifact acquisition process:

</code></pre></div><p>$ velociraptor &ndash;config /etc/server.config.yaml artifacts acquire Admin.System.CompressUploads</p>
<pre><code>
Note that there is nothing special about compressed files - you can
also just run `find` and `gzip` in the file store. Velociraptor will
automatically decompress the file when displaying it in the GUI
text/hexdump etc.

type: SERVER_EVENT

parameters:
- name: blacklistCompressionFilename
  description: Filenames which match this regex will be excluded from compression.
  default: '(?i).+ntuser.dat'

sources:
- precondition:
    SELECT server_config FROM scope()
  queries:
    - LET files = SELECT ClientId,
          Flow.session_id as Flow,
          Flow.uploaded_files as Files
      FROM watch_monitoring(artifact='System.Flow.Completion')
      WHERE Files and not Files =~ blacklistCompressionFilename

    - SELECT ClientId, Flow, Files,
             compress(path=Files) as CompressedFiles
      FROM files
</code></pre>   </div>
</div>



    
    
          <footer class=" footline" >
	
</footer>
  </div>
</div>

<div id="navigation">
<a class="nav nav-prev" href="/docs/artifacts/windows_system/monitoring/" title="Event Monitoring"> <i class="fa fa-chevron-left"></i><label>Event Monitoring</label></a>
    <a class="nav nav-next" href="/docs/artifacts/misc/" title="Miscelaneous Artifacts" style="margin-right: 0px;"><label>Miscelaneous Artifacts</label><i class="fa fa-chevron-right"></i></a></div>

</section>
<div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
  <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
</div>    

<script src="/js/clipboard.min.js"></script>
<script src="/js/featherlight.min.js"></script>
<script src="/js/html5shiv-printshiv.min.js"></script>

<script src="/js/modernizr.custom.71422.js"></script>
<script src="/js/docdock.js"></script>
<script src="/theme-original/script.js"></script>


    

    
    

    
  </body>
</html>