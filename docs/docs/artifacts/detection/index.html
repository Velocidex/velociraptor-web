<!DOCTYPE html>
<html>
  <head>
    <title>Velociraptor / Dig deeper</title>
    
      <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Windows Malware Detection :: Velociraptor / Dig deeper</title>
<link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link rel="stylesheet" href="/css/bootstrap.min.css">
<link href="/css/nucleus.css" rel="stylesheet">
<link href="/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/hybrid.css" rel="stylesheet">
<link href="/css/featherlight.min.css" rel="stylesheet">
<link href="/css/auto-complete.css" rel="stylesheet">
<link href="/theme-original/style.css" rel="stylesheet">

  <link href="/theme-original/variant-mine.css" rel="stylesheet">


<script src="/js/jquery-2.x.min.js"></script>
<style type="text/css">
  :root #header + #content > #left > #rlblock_left {
    display:none !important;
  }
</style>
<link rel="stylesheet" href="/css/theme-mine.css">
<script src="/js/custom.js"></script>


    
  </head>
  <body data-url="/docs/artifacts/detection/">
    
      <div id="headermain"></div>
<nav id="sidebar" class="">



<div class="highlightable">
  <div id="header-wrapper">
    <div id="header">
      
	
  
    <a href="/">
  <img src="/images/logo.svg">
</a>
  


    </div>
        <div class="searchbox">
		    <label for="search-by"><i class="fa fa-search"></i></label>
		    <input data-search-input id="search-by" type="text" placeholder="Search...">
		    <span data-search-clear=""><i class="fa fa-close"></i></span>
		</div>
		<script type="text/javascript" src="/js/lunr.min.js"></script>
		<script type="text/javascript" src="/js/auto-complete.js"></script>
		<script type="text/javascript">
        
            var baseurl = "\/";
        
		</script>
		<script type="text/javascript" src="/js/search.js"></script>
  </div>

      <ul class="topics">
    <li data-nav-id="/about/" class="dd-item haschildren
        ">
      <div>
      <a href="/about/">About Velociraptor</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/about/features/" class="dd-item">
        <div>
          <a href="/about/features/">
            Velociraptor Features
          </a>
        </div>
    </li>
      <li data-nav-id="/about/license/" class="dd-item">
        <div>
          <a href="/about/license/">
            License
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/" class="dd-item parent haschildren
        ">
      <div>
      <a href="/docs/">Velociraptor Documentation</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/getting-started/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/getting-started/">Getting Started</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/getting-started/stand_alone/" class="dd-item">
        <div>
          <a href="/docs/getting-started/stand_alone/">
            Standalone Deployment
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/getting-started/deploying_clients/" class="dd-item">
        <div>
          <a href="/docs/getting-started/deploying_clients/">
            Deploying Clients
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/getting-started/cloud/" class="dd-item">
        <div>
          <a href="/docs/getting-started/cloud/">
            Deploying in the cloud
          </a>
        </div>
    </li>
    <li data-nav-id="/docs/getting-started/performance/" class="dd-item
        ">
      <div>
      <a href="/docs/getting-started/performance/">Performance</a>
      </div>
    </li>
      <li data-nav-id="/docs/getting-started/triaging/" class="dd-item">
        <div>
          <a href="/docs/getting-started/triaging/">
            Triaging
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/user-interface/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/">User Interface</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/user-interface/investigating_clients/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/investigating_clients/">Investigating Clients</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/user-interface/investigating_clients/searching_clients/" class="dd-item">
        <div>
          <a href="/docs/user-interface/investigating_clients/searching_clients/">
            Searching for clients
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/investigating_clients/virtual_filesystem/" class="dd-item">
        <div>
          <a href="/docs/user-interface/investigating_clients/virtual_filesystem/">
            Client VFS
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/user-interface/artifacts/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/artifacts/">Velociraptor Artifacts</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/user-interface/artifacts/client_artifacts/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/client_artifacts/">
            Client Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/client_events/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/client_events/">
            Client Event Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/server_artifacts/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/server_artifacts/">
            Server Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/server_events/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/server_events/">
            Server Event Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/add_artifacts/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/add_artifacts/">
            Customizing Artifacts
          </a>
        </div>
    </li>
        </ul>
    </li>
      <li data-nav-id="/docs/user-interface/api/" class="dd-item">
        <div>
          <a href="/docs/user-interface/api/">
            The Velociraptor API
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/vql_reference/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/vql_reference/">VQL Reference</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/vql_reference/basic/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/basic/">
            Basic VQL
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/windows/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/windows/">
            Windows
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/parsers/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/parsers/">
            Parsers
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/server/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/server/">
            Server
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/plugin/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/plugin/">
            Client
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/event/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/event/">
            Event Plugins
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/experimental/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/experimental/">
            Experimental
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/filesystem_accessors/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/filesystem_accessors/">
            Filesystem Accessors
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/templates/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/templates/">
            Report Templates
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/tips/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/tips/">
            Artifact Tips
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/artifacts/" class="dd-item parent haschildren
        ">
      <div>
      <a href="/docs/artifacts/">Artifact Reference</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/artifacts/linux/" class="dd-item">
        <div>
          <a href="/docs/artifacts/linux/">
            Linux Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/windows_system/" class="dd-item">
        <div>
          <a href="/docs/artifacts/windows_system/">
            Windows System
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/server/" class="dd-item">
        <div>
          <a href="/docs/artifacts/server/">
            Server Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/triage/" class="dd-item">
        <div>
          <a href="/docs/artifacts/triage/">
            Windows Triage
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/detection/" class="dd-item active">
        <div>
          <a href="/docs/artifacts/detection/">
            Windows Detection
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/events/" class="dd-item">
        <div>
          <a href="/docs/artifacts/events/">
            Windows Monitoring
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/misc/" class="dd-item">
        <div>
          <a href="/docs/artifacts/misc/">
            Miscelaneous
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/linux/linux/" class="dd-item">
        <div>
          <a href="/docs/artifacts/linux/linux/">
            Linux Artifacts
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/presentations/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/presentations/">Presentations and Workshops</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/presentations/training_2020/" class="dd-item">
        <div>
          <a href="/docs/presentations/training_2020/">
            Training 2020
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/linux.conf.au.2020/" class="dd-item">
        <div>
          <a href="/docs/presentations/linux.conf.au.2020/">
            Linux.Conf.Au 2020
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/sans_dfir_summit2019/" class="dd-item">
        <div>
          <a href="/docs/presentations/sans_dfir_summit2019/">
            SANS 2019
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/rsa/" class="dd-item">
        <div>
          <a href="/docs/presentations/rsa/">
            RSA APJ 2019
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/crikeycon2019/" class="dd-item">
        <div>
          <a href="/docs/presentations/crikeycon2019/">
            Crikeycon 2019
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/nzitf2018/" class="dd-item">
        <div>
          <a href="/docs/presentations/nzitf2018/">
            NZITF 2018
          </a>
        </div>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li data-nav-id="/blog/" class="dd-item haschildren
        ">
      <div>
      <a href="/blog/">Velociraptor Blog</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/blog/medium/2019-12-31_digging-into-the-system-resource-usage-monitor-srum-afbadb1a375/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-12-31_digging-into-the-system-resource-usage-monitor-srum-afbadb1a375/">
            Digging into the System Resource Usage Monitor (SRUM)
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-12-08-velociraptor-to-elasticsearch-3a9fc02c6568/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-12-08-velociraptor-to-elasticsearch-3a9fc02c6568/">
            Velociraptor to Elasticsearch
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/">
            Recovering deleted NTFS Files with Velociraptor
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-11-12_windows-event-logs-d8d8e615c9ca/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-11-12_windows-event-logs-d8d8e615c9ca/">
            Windows Event Logs
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/">
            Triage with Velociraptor — Pt 3
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-10-04_triage-with-velociraptor-pt-2-d0f79066ca0e/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-10-04_triage-with-velociraptor-pt-2-d0f79066ca0e/">
            Triage with Velociraptor — Pt 2
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-10-02_triage-with-velociraptor-pt-1-253f57ce96c0/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-10-02_triage-with-velociraptor-pt-1-253f57ce96c0/">
            Triage with Velociraptor — Pt 1
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-09-11_velociraptor-s-client-side-buffer-3ce03697a4e6/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-09-11_velociraptor-s-client-side-buffer-3ce03697a4e6/">
            Velociraptor’s client side buffer
          </a>
        </div>
    </li>
        </ul>
    </li>




    <hr />
    <li></li>
    
    </ul>

 <section id="footer">
    </section>
  </div>
</nav>



<section id="body">
<div id="overlay"></div>
<div class="padding highlightable">

  <div id="top-bar">
    <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
        <span id="sidebar-toggle-span">
          <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
            <i class="fa fa-bars"></i>
          </a>
        </span>
        <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
        <span class="links">
        










 <a href='/'>Velociraptor / Dig deeper</a> > <a href='/docs/'>Velociraptor Documentation</a> > <a href='/docs/artifacts/'>Artifact Reference</a> > Windows Malware Detection

 

 

 

   
        </span>
    </div>
    
    
    <div class="progress">
        <div class="wrapper">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#windows-detection-impersonation">Windows.Detection.Impersonation</a></li>
<li><a href="#windows-detection-mutants">Windows.Detection.Mutants</a></li>
<li><a href="#windows-detection-processmemory">Windows.Detection.ProcessMemory</a></li>
<li><a href="#windows-detection-psexecservice">Windows.Detection.PsexecService</a></li>
<li><a href="#windows-detection-psexecservice-kill">Windows.Detection.PsexecService.Kill</a></li>
<li><a href="#windows-detection-remoteyara-process">Windows.Detection.RemoteYara.Process</a></li>
<li><a href="#windows-detection-service-upload">Windows.Detection.Service.Upload</a></li>
<li><a href="#windows-detection-thumbdrives-list">Windows.Detection.Thumbdrives.List</a></li>
<li><a href="#windows-detection-thumbdrives-officekeywords">Windows.Detection.Thumbdrives.OfficeKeywords</a></li>
<li><a href="#windows-detection-thumbdrives-officemacros">Windows.Detection.Thumbdrives.OfficeMacros</a></li>
<li><a href="#windows-detection-wmiprocesscreation">Windows.Detection.WMIProcessCreation</a></li>
<li><a href="#windows-persistence-debug">Windows.Persistence.Debug</a></li>
<li><a href="#windows-persistence-permanentwmievents">Windows.Persistence.PermanentWMIEvents</a></li>
<li><a href="#windows-persistence-powershellregistry">Windows.Persistence.PowershellRegistry</a></li>
<li><a href="#windows-persistence-wow64cpu">Windows.Persistence.Wow64cpu</a></li>
</ul></li>
</ul>
</nav>
        </div>
    </div>
    

  </div>


<div id="body-inner">
  
    <h1>Windows Malware Detection</h1>
  



    
    
    
    

<h2 id="windows-detection-impersonation">Windows.Detection.Impersonation</h2>

<p>An access token is an object that describes the security context of
a process or thread. The information in a token includes the
identity and privileges of the user account associated with the
process or thread. When a user logs on, the system verifies the
user&rsquo;s password by comparing it with information stored in a
security database.</p>

<p>Every process has a primary token that describes the security
context of the user account associated with the process. By default,
the system uses the primary token when a thread of the process
interacts with a securable object. Moreover, a thread can
impersonate a client account. Impersonation allows the thread to
interact with securable objects using the client&rsquo;s security
context. A thread that is impersonating a client has both a primary
token and an impersonation token.</p>

<p>This artfiact enumerates all threads on the system which have an
impersonation token. I.e. they are operating with a different token
then the token the entire process has. For example mimikatz has a
command called <code>token::elevate</code> to do just such a thing:</p>

<pre><code>mimikatz # privilege::debug
Privilege '20' OK

mimikatz # token::elevate
Token Id  : 0
User name :
SID name  : NT AUTHORITY\SYSTEM

688     {0;000003e7} 1 D 42171          NT AUTHORITY\SYSTEM     S-1-5-18        (04g,21p)       Primary
-&gt; Impersonated !
* Process Token : {0;000195ad} 1 F 757658339   DESKTOP-NHNHT65\mic     S-1-5-21-2310288903-2791442386-3035081252-1001  (15g,24p)       Primary
* Thread Token  : {0;000003e7} 1 D 759094260   NT AUTHORITY\SYSTEM     S-1-5-18        (04g,21p)       Impersonation (Delegation)
</code></pre>



<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
        
        
        View Artifact Source
        
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<pre><code>name: Windows.Detection.Impersonation
description: |
  An access token is an object that describes the security context of
  a process or thread. The information in a token includes the
  identity and privileges of the user account associated with the
  process or thread. When a user logs on, the system verifies the
  user's password by comparing it with information stored in a
  security database.

  Every process has a primary token that describes the security
  context of the user account associated with the process. By default,
  the system uses the primary token when a thread of the process
  interacts with a securable object. Moreover, a thread can
  impersonate a client account. Impersonation allows the thread to
  interact with securable objects using the client's security
  context. A thread that is impersonating a client has both a primary
  token and an impersonation token.

  This artfiact enumerates all threads on the system which have an
  impersonation token. I.e. they are operating with a different token
  then the token the entire process has. For example mimikatz has a
  command called `token::elevate` to do just such a thing:

</code></pre>

<p>mimikatz # privilege::debug
  Privilege &lsquo;20&rsquo; OK</p>

<p>mimikatz # token::elevate
  Token Id  : 0
  User name :
  SID name  : NT AUTHORITY\SYSTEM</p>

<p>688     {0;000003e7} 1 D 42171          NT AUTHORITY\SYSTEM     S-1-5-18        (04g,21p)       Primary
  -&gt; Impersonated !
  * Process Token : {0;000195ad} 1 F 757658339   DESKTOP-NHNHT65\mic     S-1-5-21-2310288903-2791442386-3035081252-1001  (15g,24p)       Primary
  * Thread Token  : {0;000003e7} 1 D 759094260   NT AUTHORITY\SYSTEM     S-1-5-18        (04g,21p)       Impersonation (Delegation)</p>

<pre><code>reference:
  - https://github.com/kslgroup/TokenImp-Token_Impersonation_Detection/blob/master/TokenImp%20documentation.pdf


precondition: SELECT OS From info() where OS = 'windows'

sources:
  - queries:
      - LET processes = SELECT Pid AS ProcPid, Name AS ProcName,
               Username, OwnerSid, TokenIsElevated,
               CommandLine, Exe
        FROM pslist()
        WHERE log(message=format(format=&quot;Inspecting %s (%v)&quot;, args=[ProcName, Pid]))

      - SELECT * FROM foreach(row=processes,
          query={
             // List all the threads and check that their tokens are the
             // same as the process token.
             SELECT ProcPid, ProcName, Username, OwnerSid, TokenIsElevated,
               CommandLine, Exe, ThreadInfo.TokenInfo AS ImpersonationToken
             FROM handles(pid=ProcPid, types='Thread')
             WHERE ImpersonationToken.User AND ImpersonationToken.User != OwnerSid
          })
</code></pre>

    </div>
</div>


<h2 id="windows-detection-mutants">Windows.Detection.Mutants</h2>

<p>Enumerate the mutants from selected processes.</p>

<p>Mutants are often used by malware to prevent re-infection.</p>

<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>processRegex</td>
<td>.</td>
<td>A regex applied to process names.</td>
</tr>

<tr>
<td>MutantNameRegex</td>
<td>.+</td>
<td></td>
</tr>
</tbody>
</table>



<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
        
        
        View Artifact Source
        
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<pre><code>name: Windows.Detection.Mutants
description: |
  Enumerate the mutants from selected processes.

  Mutants are often used by malware to prevent re-infection.

parameters:
  - name: processRegex
    description: A regex applied to process names.
    default: .
  - name: MutantNameRegex
    default: .+

sources:
  - name: Handles
    description: Open handles to mutants. This shows processes owning a handle open to the mutant.
    queries:
      - LET processes = SELECT Pid AS ProcPid, Name AS ProcName, Exe
        FROM pslist()
        WHERE ProcName =~ processRegex AND ProcPid &gt; 0

      - SELECT * FROM foreach(
          row=processes,
          query={
            SELECT ProcPid, ProcName, Exe, Type, Name, Handle
            FROM handles(pid=ProcPid, types=&quot;Mutant&quot;)
          })
        WHERE Name =~ MutantNameRegex

  - name: ObjectTree
    description: Reveals all Mutant objects in the Windows Object Manager namespace.
    queries:
      - SELECT Name, Type FROM winobj()
        WHERE Type = 'Mutant' AND Name =~ MutantNameRegex
</code></pre>

    </div>
</div>


<h2 id="windows-detection-processmemory">Windows.Detection.ProcessMemory</h2>

<p>Scanning process memory for signals is powerfull technique. This
artifact scans processes for a yara signature and when detected, the
process memory is dumped and uploaded to the server.</p>

<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>processRegex</td>
<td>notepad</td>
<td></td>
</tr>

<tr>
<td>yaraRule</td>
<td>wide nocase ascii: this is a secret</td>
<td></td>
</tr>
</tbody>
</table>



<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
        
        
        View Artifact Source
        
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<pre><code>name: Windows.Detection.ProcessMemory
description: |
  Scanning process memory for signals is powerfull technique. This
  artifact scans processes for a yara signature and when detected, the
  process memory is dumped and uploaded to the server.

precondition: SELECT OS From info() where OS = 'windows'

parameters:
  - name: processRegex
    default: notepad
  - name: yaraRule
    default: &quot;wide nocase ascii: this is a secret&quot;

sources:
  - queries:
      - |
        LET processes = SELECT Name as ProcessName, CommandLine, Pid
            FROM pslist()
            WHERE Name =~ processRegex

      - |
        LET hits = SELECT * FROM foreach(
          row=processes,
          query={
             SELECT ProcessName, CommandLine, Pid, String.Offset as Offsets
             FROM proc_yara(rules=yaraRule, pid=Pid)
          })

      - |
        SELECT * FROM foreach(
          row=hits,
          query={
            SELECT ProcessName, CommandLine, Pid, Offsets, FullPath,
                   upload(file=FullPath) as CrashDump
            FROM proc_dump(pid=Pid)
          })
</code></pre>

    </div>
</div>


<h2 id="windows-detection-psexecservice">Windows.Detection.PsexecService</h2>

<p>PSExec works by installing a new service in the system. The service
can be renamed using the -r flag and therefore it is not enough to
just watch for a new service called psexecsvc.exe. This artifact
improves on this by scanning the service binary to detect the
original psexec binary.</p>

<p>NOTE that if the service is very quick we are unable to examine
the service binary in time and will miss it.</p>

<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>yaraRule</td>
<td>wide nocase ascii: psexec</td>
<td></td>
</tr>
</tbody>
</table>



<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
        
        
        View Artifact Source
        
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<pre><code>name: Windows.Detection.PsexecService
description: |
  PSExec works by installing a new service in the system. The service
  can be renamed using the -r flag and therefore it is not enough to
  just watch for a new service called psexecsvc.exe. This artifact
  improves on this by scanning the service binary to detect the
  original psexec binary.

  NOTE that if the service is very quick we are unable to examine
  the service binary in time and will miss it.

type: CLIENT_EVENT

parameters:
  - name: yaraRule
    default: &quot;wide nocase ascii: psexec&quot;

sources:
  - queries:
      - |
        LET file_scan = SELECT  Name AS ServiceName,
               PathName, File.ModTime AS Modified,
               File.Size AS FileSize,
               String.Offset AS StringOffset,
               String.HexData AS StringContext,
               now() AS Timestamp,
               ServiceType, PID,
               {
                  SELECT Name, Exe, CommandLine
                  FROM pslist() WHERE Ppid = PID
                  LIMIT 2
               } AS ChildProcess
        FROM yara(rules=yaraRule, files=PathName)
        WHERE Rule

      - |
        LET service_creation = SELECT Parse,
            Parse.TargetInstance.Name AS Name,
            Parse.TargetInstance.PathName As PathName,
            Parse.TargetInstance.ServiceType As ServiceType,
            Parse.TargetInstance.ProcessId AS PID
        FROM wmi_events(
           query=&quot;SELECT * FROM __InstanceCreationEvent WITHIN 1 WHERE TargetInstance ISA 'Win32_Service'&quot;,
           wait=5000000,
           namespace=&quot;ROOT/CIMV2&quot;)

      - |
        SELECT * FROM foreach(
          row=service_creation,
          query=file_scan)
</code></pre>

    </div>
</div>


<h2 id="windows-detection-psexecservice-kill">Windows.Detection.PsexecService.Kill</h2>

<p>Psexec can launch a service remotely. This artifact implements a
client side response plan whereby all the child processes of the
service are killed.</p>

<p>NOTE: There is an inherent race between detection and response. If
the psexec is very quick we will miss it.</p>

<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>yaraRule</td>
<td>wide nocase ascii: psexec</td>
<td></td>
</tr>
</tbody>
</table>



<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
        
        
        View Artifact Source
        
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<pre><code>name: Windows.Detection.PsexecService.Kill
description: |
    Psexec can launch a service remotely. This artifact implements a
    client side response plan whereby all the child processes of the
    service are killed.

    NOTE: There is an inherent race between detection and response. If
    the psexec is very quick we will miss it.

type: CLIENT_EVENT

parameters:
  - name: yaraRule
    default: &quot;wide nocase ascii: psexec&quot;

sources:
  - queries:
      - |
        SELECT * FROM foreach(
          row={ SELECT * FROM Artifact.Windows.Detection.PsexecService() },
          query={
             SELECT ServiceName, PathName, Modified, FileSize, Timestamp,
                    ServiceType, ChildProcess, Stdout, Stderr FROM execve(
               argv=[&quot;taskkill&quot;, &quot;/PID&quot;, PID, &quot;/T&quot;, &quot;/F&quot;])
        })
</code></pre>

    </div>
</div>


<h2 id="windows-detection-remoteyara-process">Windows.Detection.RemoteYara.Process</h2>

<p>Scanning process memory for signals is powerful technique. This
artefact scans processes with a remote yara rule.</p>

<p>The User can define a rule URL or use the default Velociraptor &ldquo;Public&rdquo; share:
https://&lt;server&gt;/public/remote.yar</p>

<p>This content also provides the user the option to dump any process with hits,
and the rule summary information.</p>

<p>The user is also recommended to add any endpoint agents that may cause a false
positive into the hidden parameters pathWhitelist.</p>

<p>Output of the rule is process information, Yara rule name, metadata and hit
data.</p>

<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>processRegex</td>
<td>.</td>
<td>Process name to scan as regex. Default All.</td>
</tr>

<tr>
<td>pidRegex</td>
<td>.</td>
<td>Process PID to scan as regex. Default All.</td>
</tr>

<tr>
<td>yaraURL</td>
<td></td>
<td>URL of yara rule to scan with. If empty we use\nthe server&rsquo;s public directory/remote.yar&rdquo;\n</td>
</tr>

<tr>
<td>collectProcess</td>
<td></td>
<td>Upload process of each successful hit for for\nfurther analysis.\n</td>
</tr>

<tr>
<td>printRule</td>
<td></td>
<td>Report yara rule collection summary</td>
</tr>
</tbody>
</table>



<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
        
        
        View Artifact Source
        
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<pre><code>name: Windows.Detection.RemoteYara.Process
description: |
  Scanning process memory for signals is powerful technique. This
  artefact scans processes with a remote yara rule.

  The User can define a rule URL or use the default Velociraptor &quot;Public&quot; share:
  https://\&lt;server\&gt;/public/remote.yar

  This content also provides the user the option to dump any process with hits,
  and the rule summary information.

  The user is also recommended to add any endpoint agents that may cause a false 
  positive into the hidden parameters pathWhitelist.

  Output of the rule is process information, Yara rule name, metadata and hit
  data.

author: &quot;@mgreen27&quot;

precondition: SELECT OS From info() where OS = 'windows'

parameters:
  - name: pathWhitelist
    description: |
        Process paths to exclude. Default is common
        AntiVirus we have seen cause false positives with 
        signitures in memory.
    type: hidden
    default: |
      Path
      C:\Program Files\Microsoft Security Client\MsMpEng.exe
      C:\Program Files\Cybereason ActiveProbe\AmSvc.exe
      C:\Program Files\Common Files\McAfee\AMCore\mcshield.exe
  - name: processRegex
    description: &quot;Process name to scan as regex. Default All.&quot;
    default: .
  - name: pidRegex
    description: &quot;Process PID to scan as regex. Default All.&quot;
    default: .
  - name: yaraURL
    description: |
        URL of yara rule to scan with. If empty we use
        the server's public directory/remote.yar&quot;
  - name: collectProcess
    description: |
        Upload process of each successful hit for for
        further analysis.
    type: bool
  - name: printRule
    description: &quot;Report yara rule collection summary&quot;
    type: bool

sources:
  - queries:
      - |
        LET yara_url &lt;= SELECT URL
          FROM switch(
            a={
                SELECT yaraURL AS URL
                FROM scope()
                WHERE URL
              },
            b={
                SELECT config.ServerUrls[0] + &quot;public/remote.yar&quot; AS URL
                FROM scope()
                WHERE URL
              },
            c={
                SELECT log(
                    message=&quot;yaraURL not set and no server config.&quot;),
                  NULL AS URL
                FROM scope()
              })
      - |
        LET yara_data &lt;= SELECT Url,
                format(format=&quot;%s&quot;, args=Content) as Content,
                Response
              FROM http_client(
                chunk_size=1000000, url=(yara_url[0]).URL)
          WHERE yara_url
      - |
        LET me &lt;= SELECT Pid FROM pslist(pid=getpid())
      - |
        LET whitelist &lt;= SELECT upcase(string=Path) AS Path
                FROM parse_csv(filename=pathWhitelist, accessor='data')
      - |
        LET processes &lt;= SELECT Name as ProcessName, CommandLine, Pid
            FROM pslist()
            WHERE Name =~ processRegex
                AND format(format=&quot;%d&quot;, args=Pid) =~ pidRegex
                AND NOT Pid in me.Pid
                AND NOT upcase(string=Exe) in whitelist.Path
      - |
        LET hits &lt;= SELECT * FROM foreach(
          row=processes,
          query={
             SELECT ProcessName,
                CommandLine,
                Pid,
                Strings.Offset as Offsets,
                Namespace,
                Rule,
                Meta,
                Strings.Name as IOCname,
                format(format='%#v %s', args=[Strings.Data, Strings.Data]) as IOCdata
             FROM proc_yara(rules=yara_data.Content, pid=Pid)
          })
      - |
        SELECT * FROM hits

  - name: Rule
    queries:
      - SELECT * FROM if(
                condition=printRule,
                then={ SELECT * FROM yara_data }
            )

  - name: Upload
    queries:
      - |
        SELECT * FROM if(condition=collectProcess,
            then={
                SELECT * FROM foreach(
                  row=hits,
                  query={
                    SELECT ProcessName,
                        Pid,
                        format(format=&quot;%d.dmp&quot;, args=Pid) as UploadName,
                        upload(file=FullPath,name=format(format=&quot;%d.dmp&quot;, args=Pid)) as MiniProcDump
                    FROM proc_dump(pid=Pid)
                    GROUP BY Pid
                })
            })
</code></pre>

    </div>
</div>


<h2 id="windows-detection-service-upload">Windows.Detection.Service.Upload</h2>

<p>When a new service is installed, upload the service binary to the server</p>



<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
        
        
        View Artifact Source
        
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<pre><code>name: Windows.Detection.Service.Upload
description: |
  When a new service is installed, upload the service binary to the server

type: CLIENT_EVENT

precondition: SELECT OS From info() where OS = 'windows'

sources:
  - queries:
      # Sometimes the image path contains the full command line - we
      # try to extract the first parameter as the binary itself. Deal
      # with two options - either quoted or not.
      - SELECT ServiceName, upload(file=regex_replace(
                    source=ImagePath,
                    replace=&quot;$2&quot;,
                    re='^(&quot;([^&quot;]+)&quot; .+|([^ ]+) .+)')) AS Upload,
               Timestamp, _EventData, _System
        FROM Artifact.Windows.Events.ServiceCreation()
</code></pre>

    </div>
</div>


<h2 id="windows-detection-thumbdrives-list">Windows.Detection.Thumbdrives.List</h2>

<p>Users inserting Thumb drives or other Removable drive pose a
constant security risk. The external drive may contain malware or
other undesirable content. Additionally thumb drives are an easy way
for users to exfiltrate documents.</p>

<p>This artifact watches for any removable drives and provides a
complete file listing to the server for any new drive inserted. It
also provides information about any addition to the thumb drive
(e.g. a new file copied onto the drive).</p>

<p>We exclude very large removable drives since they might have too
many files.</p>

<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>maxDriveSize</td>
<td>32000000000</td>
<td>We ignore removable drives larger than this size in bytes.</td>
</tr>
</tbody>
</table>



<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
        
        
        View Artifact Source
        
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<pre><code>name: Windows.Detection.Thumbdrives.List
description: |
  Users inserting Thumb drives or other Removable drive pose a
  constant security risk. The external drive may contain malware or
  other undesirable content. Additionally thumb drives are an easy way
  for users to exfiltrate documents.

  This artifact watches for any removable drives and provides a
  complete file listing to the server for any new drive inserted. It
  also provides information about any addition to the thumb drive
  (e.g. a new file copied onto the drive).

  We exclude very large removable drives since they might have too
  many files.

type: CLIENT_EVENT

parameters:
  - name: maxDriveSize
    description: We ignore removable drives larger than this size in bytes.
    default: &quot;32000000000&quot;


sources:
  - queries:
      - |
        LET removable_disks = SELECT Name AS Drive,
            atoi(string=Data.Size) AS Size
        FROM glob(globs=&quot;/*&quot;, accessor=&quot;file&quot;)
        WHERE Data.Description =~ &quot;Removable&quot; AND Size &lt; atoi(string=maxDriveSize)

      - |
        LET file_listing = SELECT FullPath,
            timestamp(epoch=Mtime.Sec) As Modified,
            Size
        FROM glob(globs=Drive+&quot;\\**&quot;, accessor=&quot;file&quot;)
        LIMIT 1000

      - |
        SELECT * FROM diff(
          query={
             SELECT * FROM foreach(
                 row=removable_disks,
                 query=file_listing)
          },
          key=&quot;FullPath&quot;,
          period=10)
          WHERE Diff = &quot;added&quot;
</code></pre>

    </div>
</div>


<h2 id="windows-detection-thumbdrives-officekeywords">Windows.Detection.Thumbdrives.OfficeKeywords</h2>

<p>Users inserting Thumb drives or other Removable drive pose a
constant security risk. The external drive may contain malware or
other undesirable content. Additionally thumb drives are an easy way
for users to exfiltrate documents.</p>

<p>This artifact automatically scans any office files copied to a
removable drive for keywords. This could be useful to detect
exfiltration attempts of restricted documents.</p>

<p>We exclude very large removable drives since they might have too
many files.</p>

<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>officeExtensions</td>
<td>\.(xls</td>
<td>xlsm</td>
</tr>

<tr>
<td>yaraRule</td>
<td>rule Hit {\n  strings:\n    $a = &ldquo;this is my secre &hellip;</td>
<td>This yara rule will be run on document contents.</td>
</tr>
</tbody>
</table>



<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
        
        
        View Artifact Source
        
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<pre><code>name: Windows.Detection.Thumbdrives.OfficeKeywords
description: |
  Users inserting Thumb drives or other Removable drive pose a
  constant security risk. The external drive may contain malware or
  other undesirable content. Additionally thumb drives are an easy way
  for users to exfiltrate documents.

  This artifact automatically scans any office files copied to a
  removable drive for keywords. This could be useful to detect
  exfiltration attempts of restricted documents.

  We exclude very large removable drives since they might have too
  many files.

type: CLIENT_EVENT

parameters:
  - name: officeExtensions
    default: &quot;\\.(xls|xlsm|doc|docx|ppt|pptm)$&quot;
  - name: yaraRule
    description: This yara rule will be run on document contents.
    default: |
      rule Hit {
        strings:
          $a = &quot;this is my secret&quot; wide nocase
          $b = &quot;this is my secret&quot; nocase

        condition:
          any of them
      }

sources:
  - queries:
      - |
        SELECT * FROM foreach(
          row = {
            SELECT * FROM Artifact.Windows.Detection.Thumbdrives.List()
            WHERE FullPath =~ officeExtensions
          },
          query = {
            SELECT * FROM Artifact.Generic.Applications.Office.Keywords(
              yaraRule=yaraRule, searchGlob=FullPath, documentGlobs=&quot;&quot;)
          })
</code></pre>

    </div>
</div>


<h2 id="windows-detection-thumbdrives-officemacros">Windows.Detection.Thumbdrives.OfficeMacros</h2>

<p>Users inserting Thumb drives or other Removable drive pose a
constant security risk. The external drive may contain malware or
other undesirable content. Additionally thumb drives are an easy way
for users to exfiltrate documents.</p>

<p>This artifact watches for any removable drives and scans any added
office documents for VBA macros.</p>

<p>We exclude very large removable drives since they might have too
many files.</p>

<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>officeExtensions</td>
<td>\.(xls</td>
<td>xlsm</td>
</tr>
</tbody>
</table>



<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
        
        
        View Artifact Source
        
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<pre><code>name: Windows.Detection.Thumbdrives.OfficeMacros
description: |
  Users inserting Thumb drives or other Removable drive pose a
  constant security risk. The external drive may contain malware or
  other undesirable content. Additionally thumb drives are an easy way
  for users to exfiltrate documents.

  This artifact watches for any removable drives and scans any added
  office documents for VBA macros.

  We exclude very large removable drives since they might have too
  many files.

type: CLIENT_EVENT

parameters:
  - name: officeExtensions
    default: &quot;\\.(xls|xlsm|doc|docx|ppt|pptm)$&quot;

sources:
  - queries:
      - |
        SELECT * FROM foreach(
          row = {
            SELECT * FROM Artifact.Windows.Detection.Thumbdrives.List()
            WHERE FullPath =~ officeExtensions
          },
          query = {
            SELECT * from olevba(file=FullPath)
          })
</code></pre>

    </div>
</div>


<h2 id="windows-detection-wmiprocesscreation">Windows.Detection.WMIProcessCreation</h2>

<p>WMI Process creation is a common lateral movement technique. The
attacker simply uses WMI to call the Create() method on the
Win32_Process WMI object.</p>

<p>This can be easily done via the wmic.exe command or via powershell:</p>

<pre><code class="language-bash">wmic process call create cmd.exe
</code></pre>



<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
        
        
        View Artifact Source
        
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<pre><code>name: Windows.Detection.WMIProcessCreation
description: |
  WMI Process creation is a common lateral movement technique. The
  attacker simply uses WMI to call the Create() method on the
  Win32_Process WMI object.

  This can be easily done via the wmic.exe command or via powershell:

</code></pre>

<p>bash
  wmic process call create cmd.exe</p>

<pre><code>
type: CLIENT_EVENT

sources:
  - queries:
      - |
        SELECT Parse from wmi_events(
          query=&quot;SELECT * FROM MSFT_WmiProvider_ExecMethodAsyncEvent_Pre WHERE ObjectPath=\&quot;Win32_Process\&quot; AND MethodName=\&quot;Create\&quot;&quot;,
          namespace=&quot;ROOT/CIMV2&quot;,
          wait=50000000)
</code></pre>

    </div>
</div>


<h2 id="windows-persistence-debug">Windows.Persistence.Debug</h2>

<p>Windows allows specific configuration of various executables via a
registry key. Some keys allow defining a debugger to attach to a
program as it is run. If this debugger is launched for commonly used
programs (e.g. notepad) then another program can be launched at the
same time (with the same privileges).</p>

<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>imageFileExecutionOptions</td>
<td>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows N &hellip;</td>
<td></td>
</tr>
</tbody>
</table>



<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
        
        
        View Artifact Source
        
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<pre><code>name: Windows.Persistence.Debug
description: |
  Windows allows specific configuration of various executables via a
  registry key. Some keys allow defining a debugger to attach to a
  program as it is run. If this debugger is launched for commonly used
  programs (e.g. notepad) then another program can be launched at the
  same time (with the same privileges).

reference:
  - https://attack.mitre.org/techniques/T1183/

parameters:
  - name: imageFileExecutionOptions
    default: HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\*

sources:
  - queries:
      - |
        SELECT Key.Name AS Program,
               Key.FullPath as Key,
               Debugger FROM read_reg_key(
                  globs=imageFileExecutionOptions)
        WHERE Debugger
</code></pre>

    </div>
</div>


<h2 id="windows-persistence-permanentwmievents">Windows.Persistence.PermanentWMIEvents</h2>

<p>Malware often registers a permanent event listener within WMI. When
the event fires, the WMI system itself will invoke the consumer to
handle the event. The malware does not need to be running at the
time the event fires. Malware can use this mechanism to re-infect
the machine for example.</p>

<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>namespaces</td>
<td>namespace\nroot/subscription\nroot/default\n</td>
<td></td>
</tr>
</tbody>
</table>



<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
        
        
        View Artifact Source
        
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<pre><code>name: Windows.Persistence.PermanentWMIEvents
description: |
   Malware often registers a permanent event listener within WMI. When
   the event fires, the WMI system itself will invoke the consumer to
   handle the event. The malware does not need to be running at the
   time the event fires. Malware can use this mechanism to re-infect
   the machine for example.

parameters:
   - name: namespaces
     default: |
       namespace
       root/subscription
       root/default

sources:
 - precondition:
     SELECT OS from info() where OS = &quot;windows&quot;

   queries:
     - LET FilterToConsumerBinding = SELECT * FROM foreach(
        row={
                SELECT *
                FROM parse_csv(filename=namespaces, accessor='data')
        },
        query={
                SELECT parse_string_with_regex(string=Consumer,
                    regex=['((?P&lt;namespace&gt;^[^:]+):)?(?P&lt;Type&gt;.+?)\\.Name=&quot;(?P&lt;Name&gt;.+)&quot;']) as Consumer,
                    parse_string_with_regex(string=Filter,regex=['((?P&lt;namespace&gt;^[^:]+):)?(?P&lt;Type&gt;.+?)\\.Name=&quot;(?P&lt;Name&gt;.+)&quot;']) as Filter
                FROM wmi(
                    query=&quot;SELECT * FROM __FilterToConsumerBinding&quot;,namespace=namespace)
        })

     - SELECT * FROM foreach(
            row={
                    SELECT *
                    FROM parse_csv(filename=namespaces, accessor='data')
            },
            query={
                 SELECT {
                     SELECT * FROM wmi(
                       query=&quot;SELECT * FROM &quot; + Consumer.Type,
                       namespace=if(condition=Consumer.namespace,
                          then=Consumer.namespace,
                          else=namespace)) WHERE Name = Consumer.Name
                   } AS ConsumerDetails,
                   {
                     SELECT * FROM wmi(
                       query=&quot;SELECT * FROM &quot; + Filter.Type,
                       namespace=if(condition=Filter.namespace,
                          then=Filter.namespace,
                          else=namespace)) WHERE Name = Filter.Name
                   } AS FilterDetails,
                   namespace as Namespace
                 FROM FilterToConsumerBinding
                 WHERE (FilterDetails AND ConsumerDetails)
            })
</code></pre>

    </div>
</div>


<h2 id="windows-persistence-powershellregistry">Windows.Persistence.PowershellRegistry</h2>

<p>A common way of persistence is to install a hook into a user profile
registry hive, using powershell. When the user logs in, the
powershell script downloads a payload and executes it.</p>

<p>This artifact searches the user&rsquo;s profile registry hive for
signatures related to general Powershell execution. We use a yara
signature specifically targeting the user&rsquo;s profile which we extract
using raw NTFS parsing (in case the user is currently logged on and
the registry hive is locked).</p>

<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>yaraRule</td>
<td>rule PowerShell {\n  strings:\n    $a = /ActiveXOb &hellip;</td>
<td></td>
</tr>

<tr>
<td>userRegex</td>
<td>.</td>
<td></td>
</tr>
</tbody>
</table>



<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
        
        
        View Artifact Source
        
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<pre><code>name: Windows.Persistence.PowershellRegistry
description: |
  A common way of persistence is to install a hook into a user profile
  registry hive, using powershell. When the user logs in, the
  powershell script downloads a payload and executes it.

  This artifact searches the user's profile registry hive for
  signatures related to general Powershell execution. We use a yara
  signature specifically targeting the user's profile which we extract
  using raw NTFS parsing (in case the user is currently logged on and
  the registry hive is locked).

parameters:
  - name: yaraRule
    default: |
      rule PowerShell {
        strings:
          $a = /ActiveXObject.{,500}eval/ wide nocase

        condition:
          any of them
      }
  - name: userRegex
    default: .

sources:
  - precondition:
      SELECT OS From info() where OS = 'windows'
    queries:
      - |
        SELECT * from foreach(
        row={
          SELECT Name, Directory as HomeDir from Artifact.Windows.Sys.Users()
          WHERE Directory and Gid AND Name =~ userRegex
        },
        query={
          SELECT File.FullPath As FullPath,
                 String.Offset AS Off,
                 String.HexData As Hex,
                 upload(file=File.FullPath, accessor=&quot;ntfs&quot;) AS Upload
              FROM yara(
              files=&quot;\\\\.\\&quot; + HomeDir + &quot;\\ntuser.dat&quot;,
              accessor=&quot;ntfs&quot;,
              rules=yaraRule, context=50)
        })
</code></pre>

    </div>
</div>


<h2 id="windows-persistence-wow64cpu">Windows.Persistence.Wow64cpu</h2>

<p>Checks for wow64cpu.dll replacement Autorun in Windows 10.
<a href="http://www.hexacorn.com/blog/2019/07/11/beyond-good-ol-run-key-part-108-2/">http://www.hexacorn.com/blog/2019/07/11/beyond-good-ol-run-key-part-108-2/</a></p>

<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>TargetRegKey</td>
<td>HKEY_LOCAL_MACHINE\Software\Microsoft\Wow64\**</td>
<td></td>
</tr>
</tbody>
</table>



<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
        
        
        View Artifact Source
        
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<pre><code>name: Windows.Persistence.Wow64cpu
description: |
  Checks for wow64cpu.dll replacement Autorun in Windows 10.
  http://www.hexacorn.com/blog/2019/07/11/beyond-good-ol-run-key-part-108-2/

author: Matt Green - @mgreen27

parameters:
   - name: TargetRegKey
     default: HKEY_LOCAL_MACHINE\Software\Microsoft\Wow64\**
sources:
  - precondition:
      SELECT OS From info() where OS = 'windows'

    queries:
    - |
      SELECT dirname(path=FullPath) as KeyPath,
        Name as KeyName,
        Data.value as Value,
        timestamp(epoch=Mtime.Sec) AS LastModified
      FROM glob(globs=split(string=TargetRegKey, sep=&quot;,&quot;), accessor=&quot;reg&quot;)
      WHERE Data.value and
        not (Name = &quot;@&quot; and (Data.value =~ &quot;(wow64cpu.dll|wowarmhw.dll|xtajit.dll)&quot;))
</code></pre>

    </div>
</div>



    
    
          <footer class=" footline" >
	
</footer>
  </div>
</div>

<div id="navigation">
<a class="nav nav-prev" href="/docs/artifacts/triage/" title="Windows Triage Artifacts"> <i class="fa fa-chevron-left"></i><label>Windows Triage Artifacts</label></a>
    <a class="nav nav-next" href="/docs/artifacts/events/" title="Windows Event Monitoring" style="margin-right: 0px;"><label>Windows Event Monitoring</label><i class="fa fa-chevron-right"></i></a></div>

</section>
<div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
  <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
</div>    

<script src="/js/clipboard.min.js"></script>
<script src="/js/featherlight.min.js"></script>
<script src="/js/html5shiv-printshiv.min.js"></script>

<script src="/js/modernizr.custom.71422.js"></script>
<script src="/js/docdock.js"></script>
<script src="/theme-original/script.js"></script>


    

    
    

    
  </body>
</html>