<!DOCTYPE html>
<html>
  <head>
    <title>Velociraptor / Dig deeper</title>
    
      <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Windows Malware Detection :: Velociraptor / Dig deeper</title>
<link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link rel="stylesheet" href="/css/bootstrap.min.css">
<link href="/css/nucleus.css" rel="stylesheet">
<link href="/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/hybrid.css" rel="stylesheet">
<link href="/css/featherlight.min.css" rel="stylesheet">
<link href="/css/auto-complete.css" rel="stylesheet">
<link href="/theme-original/style.css" rel="stylesheet">

  <link href="/theme-original/variant-mine.css" rel="stylesheet">


<script src="/js/jquery-2.x.min.js"></script>
<style type="text/css">
  :root #header + #content > #left > #rlblock_left {
    display:none !important;
  }
</style>
<link rel="stylesheet" href="/css/theme-mine.css">
<script src="/js/custom.js"></script>


    
  </head>
  <body data-url="/docs/artifacts/detection/">
    
      <div id="headermain"></div>
<nav id="sidebar" class="">



<div class="highlightable">
  <div id="header-wrapper">
    <div id="header">
      
	
  
    <a href="/">
  <img src="/images/logo.svg">
</a>
  


    </div>
        <div class="searchbox">
		    <label for="search-by"><i class="fa fa-search"></i></label>
		    <input data-search-input id="search-by" type="text" placeholder="Search...">
		    <span data-search-clear=""><i class="fa fa-close"></i></span>
		</div>
		<script type="text/javascript" src="/js/lunr.min.js"></script>
		<script type="text/javascript" src="/js/auto-complete.js"></script>
		<script type="text/javascript">
        
            var baseurl = "\/";
        
		</script>
		<script type="text/javascript" src="/js/search.js"></script>
  </div>

      <ul class="topics">
    <li data-nav-id="/about/" class="dd-item haschildren
        ">
      <div>
      <a href="/about/">About Velociraptor</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/about/features/" class="dd-item">
        <div>
          <a href="/about/features/">
            Velociraptor Features
          </a>
        </div>
    </li>
      <li data-nav-id="/about/license/" class="dd-item">
        <div>
          <a href="/about/license/">
            License
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/" class="dd-item parent haschildren
        ">
      <div>
      <a href="/docs/">Velociraptor Documentation</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/getting-started/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/getting-started/">Getting Started</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/getting-started/stand_alone/" class="dd-item">
        <div>
          <a href="/docs/getting-started/stand_alone/">
            Standalone Deployment
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/getting-started/deploying_clients/" class="dd-item">
        <div>
          <a href="/docs/getting-started/deploying_clients/">
            Deploying Clients
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/getting-started/cloud/" class="dd-item">
        <div>
          <a href="/docs/getting-started/cloud/">
            Deploying in the cloud
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/getting-started/triaging/" class="dd-item">
        <div>
          <a href="/docs/getting-started/triaging/">
            Triaging
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/user-interface/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/">User Interface</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/user-interface/investigating_clients/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/investigating_clients/">Investigating Clients</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/user-interface/investigating_clients/searching_clients/" class="dd-item">
        <div>
          <a href="/docs/user-interface/investigating_clients/searching_clients/">
            Searching for clients
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/investigating_clients/virtual_filesystem/" class="dd-item">
        <div>
          <a href="/docs/user-interface/investigating_clients/virtual_filesystem/">
            Client VFS
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/user-interface/artifacts/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/user-interface/artifacts/">Velociraptor Artifacts</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/user-interface/artifacts/client_artifacts/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/client_artifacts/">
            Client Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/client_events/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/client_events/">
            Client Event Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/server_artifacts/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/server_artifacts/">
            Server Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/server_events/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/server_events/">
            Server Event Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/user-interface/artifacts/add_artifacts/" class="dd-item">
        <div>
          <a href="/docs/user-interface/artifacts/add_artifacts/">
            Customizing Artifacts
          </a>
        </div>
    </li>
        </ul>
    </li>
      <li data-nav-id="/docs/user-interface/api/" class="dd-item">
        <div>
          <a href="/docs/user-interface/api/">
            The Velociraptor API
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/vql_reference/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/vql_reference/">VQL Reference</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/vql_reference/basic/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/basic/">
            Basic VQL
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/windows/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/windows/">
            Windows
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/parsers/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/parsers/">
            Parsers
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/server/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/server/">
            Server
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/plugin/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/plugin/">
            Client
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/event/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/event/">
            Event Plugins
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/experimental/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/experimental/">
            Experimental
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/filesystem_accessors/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/filesystem_accessors/">
            Filesystem Accessors
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/templates/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/templates/">
            Report Templates
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/vql_reference/tips/" class="dd-item">
        <div>
          <a href="/docs/vql_reference/tips/">
            Artifact Tips
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/artifacts/" class="dd-item parent haschildren
        ">
      <div>
      <a href="/docs/artifacts/">Artifact Reference</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/artifacts/linux/" class="dd-item">
        <div>
          <a href="/docs/artifacts/linux/">
            Linux Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/windows_system/" class="dd-item">
        <div>
          <a href="/docs/artifacts/windows_system/">
            Windows System
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/server/" class="dd-item">
        <div>
          <a href="/docs/artifacts/server/">
            Server Artifacts
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/triage/" class="dd-item">
        <div>
          <a href="/docs/artifacts/triage/">
            Windows Triage
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/detection/" class="dd-item active">
        <div>
          <a href="/docs/artifacts/detection/">
            Windows Detection
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/events/" class="dd-item">
        <div>
          <a href="/docs/artifacts/events/">
            Windows Monitoring
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/misc/" class="dd-item">
        <div>
          <a href="/docs/artifacts/misc/">
            Miscellaneous
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/artifacts/linux/linux/" class="dd-item">
        <div>
          <a href="/docs/artifacts/linux/linux/">
            Linux Artifacts
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/presentations/" class="dd-item haschildren
        ">
      <div>
      <a href="/docs/presentations/">Presentations and Workshops</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/docs/presentations/training_2020/" class="dd-item">
        <div>
          <a href="/docs/presentations/training_2020/">
            Training 2020
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/linux.conf.au.2020/" class="dd-item">
        <div>
          <a href="/docs/presentations/linux.conf.au.2020/">
            Linux.Conf.Au 2020
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/sans_dfir_summit2019/" class="dd-item">
        <div>
          <a href="/docs/presentations/sans_dfir_summit2019/">
            SANS 2019
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/rsa/" class="dd-item">
        <div>
          <a href="/docs/presentations/rsa/">
            RSA APJ 2019
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/crikeycon2019/" class="dd-item">
        <div>
          <a href="/docs/presentations/crikeycon2019/">
            Crikeycon 2019
          </a>
        </div>
    </li>
      <li data-nav-id="/docs/presentations/nzitf2018/" class="dd-item">
        <div>
          <a href="/docs/presentations/nzitf2018/">
            NZITF 2018
          </a>
        </div>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li data-nav-id="/blog/" class="dd-item haschildren
        ">
      <div>
      <a href="/blog/">Velociraptor Blog</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/blog/medium/2019-12-31_digging-into-the-system-resource-usage-monitor-srum-afbadb1a375/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-12-31_digging-into-the-system-resource-usage-monitor-srum-afbadb1a375/">
            Digging into the System Resource Usage Monitor (SRUM)
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-12-08-velociraptor-to-elasticsearch-3a9fc02c6568/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-12-08-velociraptor-to-elasticsearch-3a9fc02c6568/">
            Velociraptor to Elasticsearch
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/">
            Recovering deleted NTFS Files with Velociraptor
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-11-12_windows-event-logs-d8d8e615c9ca/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-11-12_windows-event-logs-d8d8e615c9ca/">
            Windows Event Logs
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/">
            Triage with Velociraptor — Pt 3
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-10-04_triage-with-velociraptor-pt-2-d0f79066ca0e/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-10-04_triage-with-velociraptor-pt-2-d0f79066ca0e/">
            Triage with Velociraptor — Pt 2
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-10-02_triage-with-velociraptor-pt-1-253f57ce96c0/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-10-02_triage-with-velociraptor-pt-1-253f57ce96c0/">
            Triage with Velociraptor — Pt 1
          </a>
        </div>
    </li>
      <li data-nav-id="/blog/medium/2019-09-11_velociraptor-s-client-side-buffer-3ce03697a4e6/" class="dd-item">
        <div>
          <a href="/blog/medium/2019-09-11_velociraptor-s-client-side-buffer-3ce03697a4e6/">
            Velociraptor’s client side buffer
          </a>
        </div>
    </li>
        </ul>
    </li>




    <hr />
    <li></li>
    
    </ul>

 <section id="footer">
    </section>
  </div>
</nav>



<section id="body">
<div id="overlay"></div>
<div class="padding highlightable">

  <div id="top-bar">
    <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
        <span id="sidebar-toggle-span">
          <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
            <i class="fa fa-bars"></i>
          </a>
        </span>
        <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
        <span class="links">
        










 <a href='/'>Velociraptor / Dig deeper</a> > <a href='/docs/'>Velociraptor Documentation</a> > <a href='/docs/artifacts/'>Artifact Reference</a> > Windows Malware Detection

 

 

 

   
        </span>
    </div>
    
    
    <div class="progress">
        <div class="wrapper">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#windows-detection-processmemory">Windows.Detection.ProcessMemory</a></li>
<li><a href="#windows-detection-psexecservice">Windows.Detection.PsexecService</a></li>
<li><a href="#windows-detection-thumbdrives-list">Windows.Detection.Thumbdrives.List</a></li>
<li><a href="#windows-detection-thumbdrives-officekeywords">Windows.Detection.Thumbdrives.OfficeKeywords</a></li>
<li><a href="#windows-detection-thumbdrives-officemacros">Windows.Detection.Thumbdrives.OfficeMacros</a></li>
<li><a href="#windows-detection-wmiprocesscreation">Windows.Detection.WMIProcessCreation</a></li>
<li><a href="#windows-persistence-debug">Windows.Persistence.Debug</a></li>
<li><a href="#windows-persistence-permanentwmievents">Windows.Persistence.PermanentWMIEvents</a></li>
<li><a href="#windows-persistence-powershellregistry">Windows.Persistence.PowershellRegistry</a></li>
</ul></li>
</ul>
</nav>
        </div>
    </div>
    

  </div>


<div id="body-inner">
  
    <h1>Windows Malware Detection</h1>
  



    
    
    
    

<h2 id="windows-detection-processmemory">Windows.Detection.ProcessMemory</h2>

<p>Scanning process memory for signals is powerful technique. This
artifact scans processes for a yara signature and when detected, the
process memory is dumped and uploaded to the server.</p>

<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>processRegex</td>
<td>notepad</td>
<td></td>
</tr>

<tr>
<td>yaraRule</td>
<td>rule Process {\n   strings:\n     $a = &ldquo;this is a secret&rdquo; nocase wide\n     $b = &ldquo;this is a secret&rdquo; nocase\n   condition:\n     any of them\n}\n</td>
<td></td>
</tr>
</tbody>
</table>



<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
        
        
        View Artifact Source
        
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<pre><code>name: Windows.Detection.ProcessMemory
description: |
  Scanning process memory for signals is powerful technique. This
  artifact scans processes for a yara signature and when detected, the
  process memory is dumped and uploaded to the server.

precondition: SELECT OS From info() where OS = 'windows'

parameters:
  - name: processRegex
    default: notepad
  - name: yaraRule
    default: |
      rule Process {
         strings:
           $a = &quot;this is a secret&quot; nocase wide
           $b = &quot;this is a secret&quot; nocase
         condition:
           any of them
      }

sources:
  - queries:
      - |
        LET processes = SELECT Name as ProcessName, CommandLine, Pid
            FROM pslist()
            WHERE Name =~ processRegex

      - |
        LET hits = SELECT * FROM foreach(
          row=processes,
          query={
             SELECT ProcessName, CommandLine, Pid, String.Offset as Offsets
             FROM proc_yara(rules=yaraRule, pid=Pid)
          })

      - |
        SELECT * FROM foreach(
          row=hits,
          query={
            SELECT ProcessName, CommandLine, Pid, Offsets, FullPath,
                   upload(file=FullPath) as CrashDump
            FROM proc_dump(pid=Pid)
          })
</code></pre>

    </div>
</div>


<h2 id="windows-detection-psexecservice">Windows.Detection.PsexecService</h2>

<p>PSExec works by installing a new service in the system. The service
can be renamed using the -r flag and therefore it is not enough to
just watch for a new service called psexecsvc.exe. This artifact
improves on this by scanning the service binary to detect the
original psexec binary.</p>

<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>yaraRule</td>
<td>rule PsExec {\n  strings:\n    $a = &ldquo;psexec&rdquo; nocase\n    $b = &ldquo;psexec&rdquo; nocase wide\n\n  condition:\n    any of them\n}\n</td>
<td></td>
</tr>
</tbody>
</table>



<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
        
        
        View Artifact Source
        
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<pre><code>name: Windows.Detection.PsexecService
description: |
  PSExec works by installing a new service in the system. The service
  can be renamed using the -r flag and therefore it is not enough to
  just watch for a new service called psexecsvc.exe. This artifact
  improves on this by scanning the service binary to detect the
  original psexec binary.

type: CLIENT_EVENT

parameters:
  - name: yaraRule
    default: |
      rule PsExec {
        strings:
          $a = &quot;psexec&quot; nocase
          $b = &quot;psexec&quot; nocase wide

        condition:
          any of them
      }

sources:
  - queries:
      - |
        LET file_scan = SELECT File, Rule, String, now() AS Timestamp,
               Name, ServiceType
        FROM yara(rules=yaraRule, files=PathName)
        WHERE Rule

      - |
        LET service_creation = SELECT Parse.TargetInstance.Name AS Name,
               Parse.TargetInstance.PathName As PathName,
               Parse.TargetInstance.ServiceType As ServiceType
        FROM wmi_events(
           query=&quot;SELECT * FROM __InstanceCreationEvent WITHIN 1 WHERE TargetInstance ISA 'Win32_Service'&quot;,
           wait=5000000,
           namespace=&quot;ROOT/CIMV2&quot;)

      - |
        SELECT * FROM foreach(
          row=service_creation,
          query=file_scan)
</code></pre>

    </div>
</div>


<h2 id="windows-detection-thumbdrives-list">Windows.Detection.Thumbdrives.List</h2>

<p>Users inserting Thumb drives or other Removable drive pose a
constant security risk. The external drive may contain malware or
other undesirable content. Additionally thumb drives are an easy way
for users to exfiltrate documents.</p>

<p>This artifact watches for any removable drives and provides a
complete file listing to the server for any new drive inserted. It
also provides information about any addition to the thumb drive
(e.g. a new file copied onto the drive).</p>

<p>We exclude very large removable drives since they might have too
many files.</p>

<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>maxDriveSize</td>
<td>32000000000</td>
<td>We ignore removable drives larger than this size in bytes.</td>
</tr>
</tbody>
</table>



<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
        
        
        View Artifact Source
        
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<pre><code>name: Windows.Detection.Thumbdrives.List
description: |
  Users inserting Thumb drives or other Removable drive pose a
  constant security risk. The external drive may contain malware or
  other undesirable content. Additionally thumb drives are an easy way
  for users to exfiltrate documents.

  This artifact watches for any removable drives and provides a
  complete file listing to the server for any new drive inserted. It
  also provides information about any addition to the thumb drive
  (e.g. a new file copied onto the drive).

  We exclude very large removable drives since they might have too
  many files.

type: CLIENT_EVENT

parameters:
  - name: maxDriveSize
    description: We ignore removable drives larger than this size in bytes.
    default: &quot;32000000000&quot;


sources:
  - queries:
      - |
        LET removable_disks = SELECT Name AS Drive,
            atoi(string=Data.Size) AS Size
        FROM glob(globs=&quot;/*&quot;, accessor=&quot;file&quot;)
        WHERE Data.Description =~ &quot;Removable&quot; AND
           Size &lt; atoi(string=maxDriveSize)

      - |
        LET file_listing = SELECT FullPath,
            timestamp(epoch=Mtime.Sec) As Modified,
            Size
        FROM glob(globs=Drive+&quot;\\**&quot;, accessor=&quot;file&quot;)
        LIMIT 1000

      - |
        SELECT * FROM diff(
          query={
             SELECT * FROM foreach(
                 row=removable_disks,
                 query=file_listing)
          },
          key=&quot;FullPath&quot;,
          period=10)
          WHERE Diff = &quot;added&quot;
</code></pre>

    </div>
</div>


<h2 id="windows-detection-thumbdrives-officekeywords">Windows.Detection.Thumbdrives.OfficeKeywords</h2>

<p>Users inserting Thumb drives or other Removable drive pose a
constant security risk. The external drive may contain malware or
other undesirable content. Additionally thumb drives are an easy way
for users to exfiltrate documents.</p>

<p>This artifact automatically scans any office files copied to a
removable drive for keywords. This could be useful to detect
exfiltration attempts of restricted documents.</p>

<p>We exclude very large removable drives since they might have too
many files.</p>

<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>officeExtensions</td>
<td>\.(xls</td>
<td>xlsm</td>
</tr>

<tr>
<td>yaraRule</td>
<td>rule Hit {\n  strings:\n    $a = &ldquo;this is my secret&rdquo; wide nocase\n    $b = &ldquo;this is my secret&rdquo; nocase\n\n  condition:\n    any of them\n}\n</td>
<td>This yara rule will be run on document contents.</td>
</tr>
</tbody>
</table>



<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
        
        
        View Artifact Source
        
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<pre><code>name: Windows.Detection.Thumbdrives.OfficeKeywords
description: |
  Users inserting Thumb drives or other Removable drive pose a
  constant security risk. The external drive may contain malware or
  other undesirable content. Additionally thumb drives are an easy way
  for users to exfiltrate documents.

  This artifact automatically scans any office files copied to a
  removable drive for keywords. This could be useful to detect
  exfiltration attempts of restricted documents.

  We exclude very large removable drives since they might have too
  many files.

type: CLIENT_EVENT

parameters:
  - name: officeExtensions
    default: &quot;\\.(xls|xlsm|doc|docx|ppt|pptm)$&quot;
  - name: yaraRule
    description: This yara rule will be run on document contents.
    default: |
      rule Hit {
        strings:
          $a = &quot;this is my secret&quot; wide nocase
          $b = &quot;this is my secret&quot; nocase

        condition:
          any of them
      }

sources:
  - queries:
      - |
        SELECT * FROM foreach(
          row = {
            SELECT * FROM Artifact.Windows.Detection.Thumbdrives.List()
            WHERE FullPath =~ officeExtensions
          },
          query = {
            SELECT * FROM Artifact.Generic.Applications.Office.Keywords(
              yaraRule=yaraRule, searchGlob=FullPath, documentGlobs=&quot;&quot;)
          })
</code></pre>

    </div>
</div>


<h2 id="windows-detection-thumbdrives-officemacros">Windows.Detection.Thumbdrives.OfficeMacros</h2>

<p>Users inserting Thumb drives or other Removable drive pose a
constant security risk. The external drive may contain malware or
other undesirable content. Additionally thumb drives are an easy way
for users to exfiltrate documents.</p>

<p>This artifact watches for any removable drives and scans any added
office documents for VBA macros.</p>

<p>We exclude very large removable drives since they might have too
many files.</p>

<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>officeExtensions</td>
<td>\.(xls</td>
<td>xlsm</td>
</tr>
</tbody>
</table>



<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
        
        
        View Artifact Source
        
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<pre><code>name: Windows.Detection.Thumbdrives.OfficeMacros
description: |
  Users inserting Thumb drives or other Removable drive pose a
  constant security risk. The external drive may contain malware or
  other undesirable content. Additionally thumb drives are an easy way
  for users to exfiltrate documents.

  This artifact watches for any removable drives and scans any added
  office documents for VBA macros.

  We exclude very large removable drives since they might have too
  many files.

type: CLIENT_EVENT

parameters:
  - name: officeExtensions
    default: &quot;\\.(xls|xlsm|doc|docx|ppt|pptm)$&quot;

sources:
  - queries:
      - |
        SELECT * FROM foreach(
          row = {
            SELECT * FROM Artifact.Windows.Detection.Thumbdrives.List()
            WHERE FullPath =~ officeExtensions
          },
          query = {
            SELECT * from olevba(file=FullPath)
          })
</code></pre>

    </div>
</div>


<h2 id="windows-detection-wmiprocesscreation">Windows.Detection.WMIProcessCreation</h2>

<p>WMI Process creation is a common lateral movement technique. The
attacker simply uses WMI to call the Create() method on the
Win32_Process WMI object.</p>

<p>This can be easily done via the wmic.exe command or via powershell:</p>

<pre><code class="language-bash">wmic process call create cmd.exe
</code></pre>



<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
        
        
        View Artifact Source
        
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<pre><code>name: Windows.Detection.WMIProcessCreation
description: |
  WMI Process creation is a common lateral movement technique. The
  attacker simply uses WMI to call the Create() method on the
  Win32_Process WMI object.

  This can be easily done via the wmic.exe command or via powershell:

</code></pre>

<p>bash
  wmic process call create cmd.exe</p>

<pre><code>
type: CLIENT_EVENT

sources:
  - queries:
      - |
        SELECT Parse from wmi_events(
          query=&quot;SELECT * FROM MSFT_WmiProvider_ExecMethodAsyncEvent_Pre WHERE ObjectPath=\&quot;Win32_Process\&quot; AND MethodName=\&quot;Create\&quot;&quot;,
          namespace=&quot;ROOT/CIMV2&quot;,
          wait=50000000)
</code></pre>

    </div>
</div>


<h2 id="windows-persistence-debug">Windows.Persistence.Debug</h2>

<p>Windows allows specific configuration of various executables via a
registry key. Some keys allow defining a debugger to attach to a
program as it is run. If this debugger is launched for commonly used
programs (e.g. notepad) then another program can be launched at the
same time (with the same privileges).</p>

<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>imageFileExecutionOptions</td>
<td>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\*</td>
<td></td>
</tr>
</tbody>
</table>



<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
        
        
        View Artifact Source
        
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<pre><code>name: Windows.Persistence.Debug
description: |
  Windows allows specific configuration of various executables via a
  registry key. Some keys allow defining a debugger to attach to a
  program as it is run. If this debugger is launched for commonly used
  programs (e.g. notepad) then another program can be launched at the
  same time (with the same privileges).

reference:
  - https://attack.mitre.org/techniques/T1183/

parameters:
  - name: imageFileExecutionOptions
    default: HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\*

sources:
  - queries:
      - |
        SELECT Key.Name AS Program,
               Key.FullPath as Key,
               Debugger FROM read_reg_key(
                  globs=imageFileExecutionOptions)
        WHERE Debugger
</code></pre>

    </div>
</div>


<h2 id="windows-persistence-permanentwmievents">Windows.Persistence.PermanentWMIEvents</h2>

<p>Malware often registers a permanent event listener within WMI. When
the event fires, the WMI system itself will invoke the consumer to
handle the event. The malware does not need to be running at the
time the event fires. Malware can use this mechanism to re-infect
the machine for example.</p>

<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>namespace</td>
<td>root/subscription</td>
<td></td>
</tr>
</tbody>
</table>



<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
        
        
        View Artifact Source
        
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<pre><code>name: Windows.Persistence.PermanentWMIEvents
description: |
   Malware often registers a permanent event listener within WMI. When
   the event fires, the WMI system itself will invoke the consumer to
   handle the event. The malware does not need to be running at the
   time the event fires. Malware can use this mechanism to re-infect
   the machine for example.

parameters:
  - name: namespace
    default: root/subscription

sources:
 - precondition:
     SELECT OS from info() where OS = &quot;windows&quot;
   queries:
   - |
     LET FilterToConsumerBinding = SELECT parse_string_with_regex(
        string=Consumer,
        regex=['((?P&lt;namespace&gt;^[^:]+):)?(?P&lt;Type&gt;.+?)\\.Name=&quot;(?P&lt;Name&gt;.+)&quot;']) as Consumer,
          parse_string_with_regex(
        string=Filter,
        regex=['((?P&lt;namespace&gt;^[^:]+):)?(?P&lt;Type&gt;.+?)\\.Name=&quot;(?P&lt;Name&gt;.+)&quot;']) as Filter
     FROM wmi(
         query=&quot;SELECT * FROM __FilterToConsumerBinding&quot;,
         namespace=namespace)
   - |
     SELECT {
         SELECT * FROM wmi(
           query=&quot;SELECT * FROM &quot; + Consumer.Type,
           namespace=if(condition=Consumer.namespace,
              then=Consumer.namespace,
              else=namespace)) WHERE Name = Consumer.Name
       } AS ConsumerDetails,
       {
         SELECT * FROM wmi(
           query=&quot;SELECT * FROM &quot; + Filter.Type,
           namespace=if(condition=Filter.namespace,
              then=Filter.namespace,
              else=namespace)) WHERE Name = Filter.Name
       } AS FilterDetails
     FROM FilterToConsumerBinding
</code></pre>

    </div>
</div>


<h2 id="windows-persistence-powershellregistry">Windows.Persistence.PowershellRegistry</h2>

<p>A common way of persistence is to install a hook into a user profile
registry hive, using powershell. When the user logs in, the
powershell script downloads a payload and executes it.</p>

<p>This artifact searches the user&rsquo;s profile registry hive for
signatures related to general Powershell execution. We use a yara
signature specifically targeting the user&rsquo;s profile which we extract
using raw NTFS parsing (in case the user is currently logged on and
the registry hive is locked).</p>

<table>
<thead>
<tr>
<th>Arg</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>yaraRule</td>
<td>rule PowerShell {\n  strings:\n    $a = /ActiveXObject.{,500}eval/ wide nocase\n\n  condition:\n    any of them\n}\n</td>
<td></td>
</tr>
</tbody>
</table>



<div class="expand">
    <div class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fa fa-chevron-down' : 'fa fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fa fa-chevron-right"></i>
        <span>
        
        
        View Artifact Source
        
        </span>
    </div>
    <div class="expand-content" style="display: none;">
<pre><code>name: Windows.Persistence.PowershellRegistry
description: |
  A common way of persistence is to install a hook into a user profile
  registry hive, using powershell. When the user logs in, the
  powershell script downloads a payload and executes it.

  This artifact searches the user's profile registry hive for
  signatures related to general Powershell execution. We use a yara
  signature specifically targeting the user's profile which we extract
  using raw NTFS parsing (in case the user is currently logged on and
  the registry hive is locked).

parameters:
  - name: yaraRule
    default: |
      rule PowerShell {
        strings:
          $a = /ActiveXObject.{,500}eval/ wide nocase

        condition:
          any of them
      }

sources:
  - precondition:
      SELECT OS From info() where OS = 'windows'
    queries:
      - |
        SELECT * from foreach(
        row={
          SELECT Name, Directory as HomeDir from Artifact.Windows.Sys.Users()
          WHERE Directory and Gid
        },
        query={
          SELECT File.FullPath As FullPath,
                 String.Offset AS Off,
                 String.HexData As Hex,
                 upload(file=File.FullPath, accessor=&quot;ntfs&quot;) AS Upload
              FROM yara(
              files=&quot;\\\\.\\&quot; + HomeDir + &quot;\\ntuser.dat&quot;,
              accessor=&quot;ntfs&quot;,
              rules=yaraRule, context=50)
        })
</code></pre>

    </div>
</div>



    
    
          <footer class=" footline" >
	
</footer>
  </div>
</div>

<div id="navigation">
<a class="nav nav-prev" href="/docs/artifacts/triage/" title="Windows Triage Artifacts"> <i class="fa fa-chevron-left"></i><label>Windows Triage Artifacts</label></a>
    <a class="nav nav-next" href="/docs/artifacts/events/" title="Windows Event Monitoring" style="margin-right: 0px;"><label>Windows Event Monitoring</label><i class="fa fa-chevron-right"></i></a></div>

</section>
<div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
  <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
</div>    

<script src="/js/clipboard.min.js"></script>
<script src="/js/featherlight.min.js"></script>
<script src="/js/html5shiv-printshiv.min.js"></script>

<script src="/js/modernizr.custom.71422.js"></script>
<script src="/js/docdock.js"></script>
<script src="/theme-original/script.js"></script>


    

    
    

    
  </body>
</html>