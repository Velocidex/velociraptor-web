<!DOCTYPE html>
<html>
  <head>
    <title>Velociraptor / Dig deeper</title>
    
      <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Performance :: Velociraptor / Dig deeper</title>
<link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link rel="stylesheet" href="/css/bootstrap.min.css">
<link href="/css/nucleus.css" rel="stylesheet">
<link href="/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/hybrid.css" rel="stylesheet">
<link href="/css/featherlight.min.css" rel="stylesheet">
<link href="/css/auto-complete.css" rel="stylesheet">
<link href="/theme-original/style.css" rel="stylesheet">

  <link href="/theme-original/variant-mine.css" rel="stylesheet">


<script src="/js/jquery-2.x.min.js"></script>
<style type="text/css">
  :root #header + #content > #left > #rlblock_left {
    display:none !important;
  }
</style>
<link rel="stylesheet" href="/css/theme-mine.css">
<script src="/js/custom.js"></script>


    
  </head>
  <body data-url="/docs/getting-started/performance/">
    
      <div id="headermain"></div>
<nav id="sidebar" class="">



<div class="highlightable">
  <div id="header-wrapper">
    <div id="header">
      
	
  
    <a href="/">
  <img src="/images/logo.svg">
</a>

  


    </div>
        <div class="searchbox">
                    <label for="search-by"><i class="fa fa-search"></i></label>
                    <input data-search-input id="search-by" type="text" placeholder="Search...">
                    <span data-search-clear=""><i class="fa fa-close"></i></span>
                </div>
                <script type="text/javascript" src="/js/lunr.min.js"></script>
                <script type="text/javascript" src="/js/auto-complete.js"></script>
                <script type="text/javascript">
        
            var baseurl = "\/";
        
                </script>
                <script type="text/javascript" src="/js/search.js"></script>
  </div>

      <ul class="topics">
    <li data-nav-id="/about/" class="dd-item haschildren
        ">
      <div>
      <a href="/about/">About Velociraptor</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/about/features/" class="dd-item">
        <div>
          <a href="/about/features/">
            Velociraptor Features
          </a>
        </div>
    </li>
      <li data-nav-id="/about/license/" class="dd-item">
        <div>
          <a href="/about/license/">
            License
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/docs/" class="dd-item parent haschildren
        ">
      <div>
      <a href="/docs/">Velociraptor Documentation</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i>
      </div>
        <ul>
        </ul>
    </li>
    <li data-nav-id="/blog/" class="dd-item haschildren
        ">
      <div>
      <a href="/blog/">Velociraptor Blog</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/docs/artifacts/windows_system/events/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/events/">Event Logs</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/system/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/system/">System</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/registry/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/registry/">Registry</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/network/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/network/">Network</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/applications/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/applications/">Applications</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/detection/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/detection/">Malware Detection</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/triage/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/triage/">Triage Artifacts</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/remediation/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/remediation/">Remdiation</a>
      </div>
    </li>
    <li data-nav-id="/docs/artifacts/windows_system/monitoring/" class="dd-item
        ">
      <div>
      <a href="/docs/artifacts/windows_system/monitoring/">Event Monitoring</a>
      </div>
    </li>
        </ul>
    </li>




    <hr />
    <li></li>

    </ul>

 <section id="footer">
    </section>
  </div>
</nav>



<section id="body">
<div id="overlay"></div>
<div class="padding highlightable">

  <div id="top-bar">
    <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
        <span id="sidebar-toggle-span">
          <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
            <i class="fa fa-bars"></i>
          </a>
        </span>
        <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
        <span class="links">
        










 <a href='/'>Velociraptor / Dig deeper</a> > <a href='/docs/'>Velociraptor Documentation</a> > <a href='/docs/getting-started/'>Getting Started</a> > Performance








        </span>
    </div>

    
    <div class="progress">
        <div class="wrapper">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#idle-performance">Idle performance</a></li>
    <li><a href="#heavy-hunting">Heavy hunting</a>
      <ul>
        <li><a href="#managing-concurrency">Managing concurrency</a></li>
        <li><a href="#disk-space">Disk space</a></li>
      </ul>
    </li>
  </ul>
</nav>
        </div>
    </div>
    

  </div>


<div id="body-inner">
  
      <h1>Performance</h1>
      
  



    
    
    

<p>With the present architecture, Velociraptor only supports a file based
data store. This makes it easy to deploy as you don&rsquo;t need to set up
an elaborate database backend, but this is inherently limited to a
single machine.</p>
<p>We expect this limitation to be removed in the near future but until
then, people are often asking us about how to spec the server and how
many endpoints Velociraptor can support in its current form.</p>
<p>In this page we discuss some of the performance limitations of the
platform. It is important to understand how performance affects the
framework and how Velociraptor manages finite resources to scale up
efficiently.</p>
<p>The following discussion is fairly technical and goes into a lot of
specific implementation details.</p>
<h2 id="idle-performance">Idle performance</h2>
<p>One of the important considerations is how many resources are used by
an idle deployment - i.e. one at which clients are simply connected to
the server but no active hunts or collections are run from them. It is
important to note that even when clients are idle, Velociraptor always
collects endpoint footprint telemetry by sampling Velociraptor&rsquo;s own
CPU and Memory footprint every 10 seconds on each endpoint.</p>
<p>We typically deploy on AWS a <code>t2.large</code> (8Gb 2 core VM) to support up
to 10k endpoints. Below is a deployment we have that is mostly idle.
CPU load is in the range 10-20% of one core, memory &lt; 400mb when
idle. This is a typical medium sized deployment of around 2.5k
endpoints. Load typically increases linearly - so a 5,000 endpoint
deployment might use twice the CPU load etc. For 20,000 endpoint
deployment a larger size VM would be required.</p>
<p><img src="idle.png" alt="Idle performance statistics"></p>
<p>When idle, the main CPU load is with RSA operations for encrypting and
decrypting messages to the endpoint. Since each endpoint selects an
ephemeral key we need to maintain an in-memory cache of session keys -
this avoids having to do a lot of RSA operations. The size of the
cache is controlled by the <code>Frontend.expected_clients</code> setting and
defaults to 10,000 endpoints. Increasing endpoints above that will
overflow the memory cache and will results in a lot more RSA
operations. The cache can be increased safely at the cost of added
memory use.</p>
<h2 id="heavy-hunting">Heavy hunting</h2>
<p>When running many hunts, the server simply collects results from the
endpoints. Due to the unique architecture of Velociraptor, all
collections are simply queries that run on the endpoints. Queries can
return a result set (essentially rows and columns of JSON encoded
values), or bulk data (e.g. for file uploads). The server simply
stores these results in the filestore.</p>
<p>For this reason even hunts that intuitively seem expensive are
actually very light on the server. For example, consider an artifact
that applies a Yara signature to many files on the endpoints. This
might search through many Terabytes of data collectively on all
endpoints, but if the signature is good will only report few relevant
results. In this case the load will be very small on the server
(client side load can be managed through the op/sec client side query
limiting mechanism).</p>
<p>On the other hand, consider a hunt that just collects a lot of data
(e.g. the <code>Windows.KapeFiles.Targets</code> artifact). This causes the
clients to send a lot of bulk data which the server needs to decrypt,
then store on the filesystem. This will lead to a lot of server load
(and will also saturate inbound bandwidth). It is easy to collect
hundreds of Gigabytes unintentionally at scale.</p>
<h3 id="managing-concurrency">Managing concurrency</h3>
<p>When receiving a lot of data from many clients simultaneously, the
Velociraptor frontend must buffer the data in memory before decrypting
and processing the data. Therefore the limiting factor is actually
memory and not CPU load. The total number of concurrent connections
determines the total memory used.</p>
<p>To protect itself, the frontend has a limit on the total number of
concurrent client connections. This is controlled by the
<code>Frontend.concurrency</code> setting. The default is 6 but if you have more
than 2Gb of RAM you should probably increase that to 20 or more.</p>
<p>The concurrency setting limits the number of clients that are allowed
to upload data to the server at the same time. Lowering this value
reduces memory use, but increases the time taken for hunts to
complete. Many hunts are not terribly urgent so this is a reasonable
trade off.</p>
<p>In the current version (0.4.1) there is no QoS mechanism on the
communications so while a heavy hunt is in progress, interactive
investigation (e.g. through the VFS view) can not proceed. Therefore
currently this is a disadvantage of lowering concurrency too much. We
expect the situation to change in the near future.</p>
<p>Typically hunts progress very quickly and do not transfer a lot of
data (Collecting large quantities of data not only leads to server
saturation, but also leaves the investigators with huge quantity of
data to post process - it is better to be more surgical in collection
and move processing to the query on the endpoints as much as possible).</p>
<p>The figure below shows a typical day of heavy hunting on the
deployment shown in the previous figure (about 2.5k endpoints). Each
of the CPU spikes is a hunt, and most hunts complete in a few
minutes. During the hunt CPU load rises to about 160-180% (this is a 2
core VM), but memory remains very stable due to the concurrency
controls described above.</p>
<p><img src="hunting.png" alt="Hunting performance"></p>
<h3 id="disk-space">Disk space</h3>
<p>By far the most important aspects of specing the server is the amount
of disk space available. Since Velociraptor uses a simple filesystem
to store all its data, it is easy to manage disk space by deleting or
archiving old data.</p>
<div class="notices note" ><p>It is very easy to fill up disk space with Velociraptor because it is
so fast and responsive. For example issuing a large triage file
collection for user&rsquo;s web browser related files might include on
average 500Mb of Internet cache files per client - on a 10,000 machine
deployment this will collect 5tb of data! Since Velociraptor is very
fast, if you have excellent connectivity to your endpoints, you
<strong>will</strong> fill up the disk in a matter of hours!</p>
<p>Always be aware of the multiplicative effect of scale. In many cases
it might require a change of mindset - if you are most familiar with
interactive &ldquo;traditional&rdquo; digital forensics it might require
re-thinking your approach when scaling up investigations and issuing
more surgical artifact collections.</p>
<p>If your disk fills, The Velociraptor frontend will be unable to
receive any data from endpoints (will begin serving 500
responses). Due to Velociraptor&rsquo;s architecture, clients will queue up
outgoing messages to the server in their local buffer file (by
default up to 1Gb).</p>
<p>This might result in a situation where after clearing the disk space,
Velociraptor will immediately fill it up again with more data queued
to be sent by the clients. If this happens you need to stop active
hunts to actively remove their results from clients&rsquo; buffer files.</p>
</div>

<p>The following describes the directories one typically finds in the
filestore directory:</p>
<ol>
<li>
<p><code>acl</code> : This contains the ACL policies for all users.</p>
</li>
<li>
<p><code>artifact_definitions</code>: This contains custom artifacts that were added through the GUI</p>
</li>
<li>
<p><code>client_index</code> and <code>clients</code>: These contains information collected
from all clients. It is possible to completely remove these
directories and restart the server. Clients will simply re-enrol
automatically.</p>
</li>
<li>
<p><code>config</code>: This directory contains server specific configuration
that is changed through the GUI.</p>
</li>
<li>
<p><code>downloads</code>: Contains Zip files prepared via the GUI&rsquo;s &ldquo;Prepare Download&rdquo; button.</p>
</li>
<li>
<p><code>hunt_index</code> and <code>hunt</code>: contain metadata related to managing
current hunts. It does not typically contain a lot of data.</p>
</li>
<li>
<p><code>journals</code> are journal files that allow Velociraptor to follow all
clients at the same time. It is safe to remove journal files at any
time as they can become large. They typically contain events from
client and server monitoring queries.</p>
</li>
<li>
<p><code>notebooks</code> contains the user created post processing and analysis
notebooks. You probably do not want to remove these.</p>
</li>
<li>
<p><code>server_artifacts</code> store the results of collection Server Artifacts
in the GUI.</p>
</li>
<li>
<p><code>users</code> contains information about all GUI users.</p>
</li>
</ol>
<p>The majority of the disk usage appears in the <code>clients</code> and <code>journals</code>
directories so it is worth aggressively managing that usage.</p>
<p>In the AWS cloud it is possible to resize disk space dynamically. See <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/requesting-ebs-volume-modifications.html">Requesting Modifications to Your EBS Volumes
</a> and <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/recognize-expanded-volume-linux.html">Extending a Linux File System After Resizing a Volume</a>. You can do this without even restarting the server.</p>



    
    
          <footer class=" footline" >
	
</footer>
  </div>
</div>

<div id="navigation">
<a class="nav nav-prev" href="/docs/getting-started/cloud/" title="Deploying in the cloud"> <i class="fa fa-chevron-left"></i><label>Deploying in the cloud</label></a>
    <a class="nav nav-next" href="/docs/getting-started/triaging/" title="Triaging" style="margin-right: 0px;"><label>Triaging</label><i class="fa fa-chevron-right"></i></a></div>

</section>
<div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
  <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
</div>    

<script src="/js/clipboard.min.js"></script>
<script src="/js/featherlight.min.js"></script>
<script src="/js/html5shiv-printshiv.min.js"></script>

<script src="/js/modernizr.custom.71422.js"></script>
<script src="/js/docdock.js"></script>
<script src="/theme-original/script.js"></script>


    

    
    

    
  </body>
</html>